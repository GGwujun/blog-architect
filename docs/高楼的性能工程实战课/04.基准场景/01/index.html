<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog-architect/umi.3ec1f225.css" />
    <script>
      window.routerBase = "/blog-architect";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>10 | 设计基准场景需要注意哪些关键点？ - 大师兄</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/高楼的性能工程实战课/04.基准场景/01" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-architect/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>后端开发<ul><li><a href="/blog-architect/spark性能调优实战">spark性能调优实战</a></li></ul></span><span>架构师<ul><li><a href="/blog-architect/设计模式之美">设计模式之美</a></li><li><a href="/blog-architect/架构实战案例解析">架构实战案例解析</a></li><li><a href="/blog-architect/许式伟的架构课">许式伟的架构课</a></li><li><a href="/blog-architect/说透中台">说透中台</a></li><li><a href="/blog-architect/oauth2.0实战课">oauth2.0实战课</a></li><li><a href="/blog-architect/从0开始学架构">从0开始学架构</a></li><li><a href="/blog-architect/即时消息技术剖析与实战">即时消息技术剖析与实战</a></li><li><a href="/blog-architect/如何设计一个秒杀系统">如何设计一个秒杀系统</a></li><li><a href="/blog-architect/如何落地业务建模">如何落地业务建模</a></li><li><a href="/blog-architect/性能优化高手课">性能优化高手课</a></li><li><a href="/blog-architect/性能工程高手课">性能工程高手课</a></li><li><a href="/blog-architect/手把手带你搭建秒杀系统">手把手带你搭建秒杀系统</a></li><li><a href="/blog-architect/技术与商业案例解读">技术与商业案例解读</a></li><li><a href="/blog-architect/推荐系统三十六式">推荐系统三十六式</a></li><li><a href="/blog-architect/检索技术核心20讲">检索技术核心20讲</a></li><li><a href="/blog-architect/软件设计之美">软件设计之美</a></li><li><a href="/blog-architect/高并发系统设计40问">高并发系统设计40问</a></li><li><a aria-current="page" class="active" href="/blog-architect/高楼的性能工程实战课">高楼的性能工程实战课</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-architect/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>后端开发<ul><li><a href="/blog-architect/spark性能调优实战">spark性能调优实战</a></li></ul></li><li>架构师<ul><li><a href="/blog-architect/设计模式之美">设计模式之美</a></li><li><a href="/blog-architect/架构实战案例解析">架构实战案例解析</a></li><li><a href="/blog-architect/许式伟的架构课">许式伟的架构课</a></li><li><a href="/blog-architect/说透中台">说透中台</a></li><li><a href="/blog-architect/oauth2.0实战课">oauth2.0实战课</a></li><li><a href="/blog-architect/从0开始学架构">从0开始学架构</a></li><li><a href="/blog-architect/即时消息技术剖析与实战">即时消息技术剖析与实战</a></li><li><a href="/blog-architect/如何设计一个秒杀系统">如何设计一个秒杀系统</a></li><li><a href="/blog-architect/如何落地业务建模">如何落地业务建模</a></li><li><a href="/blog-architect/性能优化高手课">性能优化高手课</a></li><li><a href="/blog-architect/性能工程高手课">性能工程高手课</a></li><li><a href="/blog-architect/手把手带你搭建秒杀系统">手把手带你搭建秒杀系统</a></li><li><a href="/blog-architect/技术与商业案例解读">技术与商业案例解读</a></li><li><a href="/blog-architect/推荐系统三十六式">推荐系统三十六式</a></li><li><a href="/blog-architect/检索技术核心20讲">检索技术核心20讲</a></li><li><a href="/blog-architect/软件设计之美">软件设计之美</a></li><li><a href="/blog-architect/高并发系统设计40问">高并发系统设计40问</a></li><li><a aria-current="page" class="active" href="/blog-architect/高楼的性能工程实战课">高楼的性能工程实战课</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog-architect/高楼的性能工程实战课">高楼的性能工程实战课</a></li><li><a href="/blog-architect/高楼的性能工程实战课/01.开篇词">01.开篇词</a><ul><li><a href="/blog-architect/高楼的性能工程实战课/01.开篇词/01"><span>开篇词 | 打破四大认知局限，进阶高级性能工程师</span></a></li></ul></li><li><a href="/blog-architect/高楼的性能工程实战课/02.性能工程的核心理念">02.性能工程的核心理念</a><ul><li><a href="/blog-architect/高楼的性能工程实战课/02.性能工程的核心理念/01"><span>01 | 性能工程：为什么很多性能测试人员无法对性能结果负责？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/02.性能工程的核心理念/02"><span>02 | 关键概念：性能指标和场景的确定</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/02.性能工程的核心理念/03"><span>03 | 核心分析逻辑：所有的性能分析，靠这七步都能搞定</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/02.性能工程的核心理念/04"><span>04 | 如何构建性能分析决策树和查找瓶颈证据链？</span></a></li></ul></li><li><a href="/blog-architect/高楼的性能工程实战课/03.性能工程的实践关键点">03.性能工程的实践关键点</a><ul><li><a href="/blog-architect/高楼的性能工程实战课/03.性能工程的实践关键点/01"><span>05 | 性能方案：你的方案是否还停留在形式上？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/03.性能工程的实践关键点/02"><span>06 | 如何抽取出符合真实业务场景的业务模型？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/03.性能工程的实践关键点/03"><span>07 | 性能场景的数据到底应该做成什么样子？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/03.性能工程的实践关键点/04"><span>08 | 并发、在线和TPS到底是什么关系？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/03.性能工程的实践关键点/05"><span>09 | 如何设计全局和定向监控策略？</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog-architect/高楼的性能工程实战课/04.基准场景">04.基准场景</a><ul><li><a aria-current="page" class="active" href="/blog-architect/高楼的性能工程实战课/04.基准场景/01"><span>10 | 设计基准场景需要注意哪些关键点？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/02"><span>11 | 打开首页之一：一个案例，带你搞懂基础硬件设施的性能问题</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/03"><span>12 | 打开首页之二：如何平衡利用硬件资源？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/04"><span>13 | 用户登录：怎么判断线程中的Block原因？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/05"><span>14 | 用户信息查询：如何解决网络软中断瓶颈问题？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/06"><span>15 | 查询商品：资源不足有哪些性能表现？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/07"><span>16 | 商品加入购物车：SQL优化和压力工具中的参数分析</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/08"><span>17 | 查询购物车：为什么铺底参数一定要符合真实业务特性？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/09"><span>18 | 购物车信息确定订单：为什么动态参数化逻辑非常重要？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/10"><span>19 | 生成订单信息之一：应用JDBC池优化和内存溢出分析</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/11"><span>20 | 生成订单信息之二：业务逻辑复杂，怎么做性能优化？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/12"><span>21 | 支付前查询订单列表：如何分析优化一个固定的技术组件？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/13"><span>22 | 支付订单信息：如何高效解决for循环产生的内存溢出？</span></a></li></ul></li><li><a href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景">05.容量稳定性异常场景</a><ul><li><a href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/01"><span>23 | 决定容量场景成败的关键因素有哪些？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/02"><span>24 | 容量场景之一：索引优化和Kubernetes资源分配不均衡怎么办？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/03"><span>25 | 容量场景之二：缓存对性能会有什么样的影响？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/04"><span>26 | 稳定性场景之一：怎样搞定业务积累量产生的瓶颈问题？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/05"><span>27 | 稳定性场景之二：怎样搞定磁盘不足产生的瓶颈问题？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/06"><span>28 | 如何确定异常场景的范围和设计逻辑？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/07"><span>29 | 异常场景：如何模拟不同组件层级的异常？</span></a></li></ul></li><li><a href="/blog-architect/高楼的性能工程实战课/06.特别放送">06.特别放送</a><ul><li><a href="/blog-architect/高楼的性能工程实战课/06.特别放送/01"><span>我们这个课程的系统是怎么搭建起来的？</span></a></li></ul></li><li><a href="/blog-architect/高楼的性能工程实战课/07.性能结论">07.性能结论</a><ul><li><a href="/blog-architect/高楼的性能工程实战课/07.性能结论/01"><span>30 | 如何确定生产系统配置？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/07.性能结论/02"><span>31 | 怎么写出有价值的性能报告？</span></a></li></ul></li><li><a href="/blog-architect/高楼的性能工程实战课/08.结课测试">08.结课测试</a><ul><li><a href="/blog-architect/高楼的性能工程实战课/08.结课测试/01"><span>一套习题，测出你的掌握程度</span></a></li></ul></li><li><a href="/blog-architect/高楼的性能工程实战课/09.结束语">09.结束语</a><ul><li><a href="/blog-architect/高楼的性能工程实战课/09.结束语/01"><span>结束语 | 做真正的性能项目</span></a></li></ul></li><li><a href="/blog-architect/高楼的性能工程实战课/summary">高楼的性能工程实战课</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="性能场景分类" data-depth="2"><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/01#性能场景分类"><span>性能场景分类</span></a></li><li title="基准场景" data-depth="2"><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/01#基准场景"><span>基准场景</span></a></li><li title="登录接口" data-depth="2"><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/01#登录接口"><span>登录接口</span></a></li><li title="总结" data-depth="2"><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/01#总结"><span>总结</span></a></li><li title="课后作业" data-depth="2"><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/01#课后作业"><span>课后作业</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="10--设计基准场景需要注意哪些关键点"><a aria-hidden="true" tabindex="-1" href="/blog-architect/高楼的性能工程实战课/04.基准场景/01#10--设计基准场景需要注意哪些关键点"><span class="icon icon-link"></span></a>10 | 设计基准场景需要注意哪些关键点？</h1><p>你好，我是高楼。</p><p>在前面的课程中我们提到过，在RESAR性能工程中，场景分为四类：基准、容量、稳定性、异常。每一类场景都对应着不同的目标。</p><p>其中，基准场景是为了找到系统中明显的配置及软件Bug，同时也为容量场景提供可对比的基准数据。在RESAR性能工程的逻辑中，基准场景是非常重要、非常重要的部分，而不是随意试验一下场景能不能跑起来，是要有确定的结论的。</p><p>在这节课中，我要给你解释几个基本的问题，比如线程数应该如何确定，压力线程的连续递增的重要性，以及如何将之前所讲的分析思路应用在具体的分析案例中。</p><p>下面我们一起来看一看。</p><h2 id="性能场景分类"><a aria-hidden="true" tabindex="-1" href="/blog-architect/高楼的性能工程实战课/04.基准场景/01#性能场景分类"><span class="icon icon-link"></span></a>性能场景分类</h2><p>在设计性能场景时，我们首先要清楚场景的目标是什么。在一些项目中，我们通常会拿到这样的需求：</p><ol><li>评估一下系统能支持的最大容量。这显然是为了知道当前的系统容量，目标很明确；</li><li>测试并优化系统以支持线上的业务目标。这个需求显然有了优化的必要；</li><li>测试并评估未来几年内，性能容量是否可以满足业务发展。这个需求显然是要求测试未来的业务场景。</li></ol><p>这是我们经常拿到的几类性能需求，基于此，我把场景按照目标划分为三类：</p><ol><li>验证：评估当前系统容量；</li><li>调优：评估并优化当前系统；</li><li>推算：评估并推算未来系统容量。</li></ol><p>这种分类和我们一直强调的按类型分类（也就是基准、容量、稳定性、异常）是什么关系呢？这里我画一张图说明一下：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimagee901e9639fbd9a2dd4a99af8ce7b2097c801.99a1f983.jpg" alt=""/></p><p>从图中可以明显看出这两种分类之间的关系：我们首先要确定性能场景的目标，然后再设计对应的具体场景。</p><p>你要注意，对于图中的三种目标，位于下方的目标是包含它上方的目标的，比如以调优为目标的场景，包括了以验证为目标的场景。</p><p>有了这些基本的了解后，下面我再给你详细解释一下。</p><h4 id="1-按目标分类"><a aria-hidden="true" tabindex="-1" href="/blog-architect/高楼的性能工程实战课/04.基准场景/01#1-按目标分类"><span class="icon icon-link"></span></a>1. 按目标分类</h4><p>对于按目标划分出的这三种性能场景，我们结合RESAR性能过程图具体来看看。</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage1580155ff7d26a09a1865f473b720f4a7880.f3e60359.jpg" alt=""/></p><ul><li><strong>性能验证</strong></li></ul><p>性能验证（测试）是指针对当前的系统、当前的模型、当前的环境，验证一下版本是否有性能的变化。注意，在这个阶段中，我们不做复杂的性能监控，不做性能分析，也不调优。</p><p>在目前的性能市场中，大部分项目都处于性能验证的状态。如果对于一个已经在线上稳定运行了很久的系统来说，我们去做版本更新的验证倒是无可厚非的，只要比对一下数据就可以了。这种项目周期通常在一两周以内，不会更长了，而且也不用更长，除非有大的性能瓶颈。</p><p>对于性能验证的项目，其实很多人一直在做“性能场景执行”和“性能结果/报告”这两个步骤。其他的步骤也不是不做，只是会拿之前的文档做个修改，走个过场，想着反正也没人仔细看。所以，性能验证这个项目就变成了：来一个版本，用同样的脚本、同样的环境、同样的数据，执行一遍就好了。</p><p>当这样的执行多了以后，你就会产生一种误解：原来性能就是这样无聊地一轮一轮执行下去，还是熟悉的姿势、还是熟悉的味道……在我遇到的性能从业人员中，有很多人都是在这样的项目中认识了性能，从而认为自己的技术还挺好的，觉得性能也不怎么难。</p><ul><li><strong>性能调优</strong></li></ul><p>性能调优是指针对当前的系统、当前的模型、当前的环境，做性能监控、性能分析和性能优化，并且要给出具体的结论。这是我们大部分项目都应该做到，但实际上没有做到的。</p><p>如果一个项目需要给出“系统上线后以什么样的容量能力来运行”这样的结论，那么这个场景目标的细化是相当关键的。</p><p>现在，很多性能项目最缺少的就是给出一个明确的结论。什么叫“给出结论”呢？你说我写了TPS是多少、CPU使用率是多少，这叫结论吗？对不起，我觉得这不叫结论。</p><p><strong>结论应该是有业务含义的</strong>，比如说支持1000万用户在线、支持1万用户并发等等，这才叫结论。</p><p>不管你给出多少TPS，只要老板或是其他人问：“那我上了1000万用户之后，系统会不会死呢？”你会有一种被敲了一闷棍的感觉，不知道该如何回答。而这个时候，给对方的感觉就是，这个性能做得没什么具体的价值。不管你有多累多辛苦，在这种情况下，性能的价值都会被低估。</p><p>前段时间，我跟一个十几年的朋友聊天，就聊到了这个话题：性能如何才能体现出价值。我说，如果是我做的项目，我会给出这样的承诺，那就是在我执行的性能场景范围之内，我要保证线上不会死。如果死了，我觉得这个性能项目就不应该收费了。</p><p>这就像你买了一个手机，回来一用，发现打不了电话，你觉得这时候怎么办？不是退货就是换货，还要生一肚子闷气。</p><p>既然如此，那我们做性能为什么就给不了这样的承诺呢？你想想，如果你做完了一个项目，却不能告诉对方这个系统能不能好好活着，那人家还要你干嘛，直接砍掉这个项目就好，还省了成本。</p><p>此外，从RESAR性能工程的过程图来看，对于性能调优的项目，我们需要完成从“性能需求指标”到“生产运维”的整个过程。注意，这整个过程不是走过场，而是每一步都要精雕细琢。</p><ul><li><strong>性能推算</strong></li></ul><p>性能估算针对的是未来的系统、未来的模型、未来的环境，我们要对此做出严谨的业务增长模型分析，并在场景执行过程中进行性能监控、分析和优化，同时给出具体的结论。很多项目都想做到性能估算，可往往都只走了过场。</p><p>其实，在性能估算的场景目标中，如果要估算的未来时间并不遥远，那我们根据业务的发展趋势的确可以推算得出来，并且这也是合理的场景。就怕遇到那种狮子大开口的需求，一说到估算，就是系统十年不宕机。</p><p>对于性能估算的项目，我们同样需要完成从“性能需求指标”到“生产运维”的整个过程。其中，有两个环节与性能调优项目中的不同，那就是“性能需求指标”和“性能模型”。</p><p>在性能估算项目中，性能需求指标和性能模型一定不是由性能测试人员来决定的，而是由整个团队来决定。上到老板，下到基层员工，都要有统一的认识。要不然等项目做完了之后，你就无法回答老板那个“能不能支持1000万在线“的问题。</p><p>上述就是我们按照目标划分出的三类性能场景，这里我用一张图帮你总结一下，我希望你能对它们有了一个清楚的了解。</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimaged0ded0744079dcf8c0908f3fe4b58ee798de.1708be10.jpg" alt=""/></p><h4 id="2-按过程分类"><a aria-hidden="true" tabindex="-1" href="/blog-architect/高楼的性能工程实战课/04.基准场景/01#2-按过程分类"><span class="icon icon-link"></span></a>2. 按过程分类</h4><p>我们说，性能场景还可以按照过程分类，而这个“过程”，说的其实就是我们应该怎样执行性能场景、性能场景应该从哪里开始的问题。不知道你记不记得，我之前在<a target="_blank" rel="noopener noreferrer" href="https://time.geekbang.org/column/article/357539">第5讲<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中画过这样一张图：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage7d037df293f3b57eed500d95acf156c05303.01136b87.jpg" alt=""/></p><p>从图中可以看到，我一直强调的是这四种场景执行过程：</p><ul><li>基准场景</li><li>容量场景</li><li>稳定性场景</li><li>异常场景</li></ul><p>请你记住：<strong>性能场景中需要且仅需要这四种场景</strong>**。**</p><p>你可能会问，就这么绝对吗？是的，我就是这么固执。</p><p>在正式的性能场景（需要给出结果报告的性能场景）中，我还要再强调两个关键词：“<strong>递增</strong>”和“<strong>连续</strong>”。为了说明这两个关键词有多么重要，我特意用红框红字给你写在下面，希望你能重视。</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimagea9b6a9af5f15e7d31108b7af0a080ae119b6.f5affae0.jpg" alt=""/></p><p>这两个关键词是我们在性能场景中一定要做到的。因为，在我们的生产环境里没有不连续的情况，并且在我们的生产环境中，用户量肯定是一个由少到多、有起伏变化的过程。而且，也只有这两个关键词能把场景的基调给定下来。所以，我一直在反复反复强调它们。</p><p>也许有人会说，我就是试一下看看场景能不能执行起来，也得这么干吗？嗯……那倒不用，请退出去把门带上。</p><p>下面我们来说一下在基准场景执行过程中，我们要重点关注什么。</p><h2 id="基准场景"><a aria-hidden="true" tabindex="-1" href="/blog-architect/高楼的性能工程实战课/04.基准场景/01#基准场景"><span class="icon icon-link"></span></a>基准场景</h2><p>在我们对一个系统完全不了解的情况下，我们先要搞清楚系统大概的容量能力是多少，具体要从哪里开始呢？就是从基准场景开始。</p><p>比如说在我们这个电商系统中，我们要测试11个业务。那是不是可以一上来就把这11个业务脚本都做出来，上去压呢？那肯定是不行的，因为我们还不知道每一个业务能跑到多大的TPS，有没有性能瓶颈。如果直接混合去压，会导致多个性能问题一起暴露出来并产生相互的影响，这样的话我们分析起来会比较困难。</p><p>所以，<strong>我们要先做单接口的基准场景</strong>。那具体怎么做呢？我们来看一个例子。首先，我们拿几个用户测试一下登录接口的基本性能（请你注意，这个尝试的过程本身并不是基准场景）。如下所示：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimaged307d36yy6a2682926799bc2b69031066b07.f4f8d404.png" alt=""/></p><p>从图中，我们至少可以看出，1个压力线程大概会产生20TPS。</p><p>那单接口的容量达到多少才不影响混合的容量场景呢？很显然，如果这是一个单登录接口，就必须高过50TPS，这是最起码的。而我们现在用的是8C16G的机器，根据CRUD的测试经验，即使不走缓存，这样的操作要达到500TPS应该没什么问题。</p><p>那在一个线程能产生20个TPS的前提下，我们先假设这个接口能达到的最大500TPS都是线性的，那就需要：</p><p>$$线程数 = 500 TPS \div 20 TPS = 25 个线程$$</p><p>同时，因为1个压力线程大概会产生20TPS，从TPS曲线上看还是上升的比较快的，所以我会考虑把Duration（场景的持续时间）放长一点，目的是让压力不要增加得太快，而在这个缓慢增加的过程中观察各类曲线的变化，以判断后续的动作以及最大容量。我会这样来确定场景的加压过程。</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimageee67eef19bf93f9a009378444a26da9ab567.e41ca943.png" alt=""/></p><p>在图中，我上到了30个线程，这里也可以不要高出那么多，只要高出25个线程就可以了。我把Ramp-up period设置为600秒，也就是20秒上一个线程，这样就会产生一个明显的连续递增的过程。</p><p>现在，我们总结一下整个思路：</p><ol><li>先确定单线程运行时的TPS值；</li><li>根据系统最大的预估容量设置场景中的线程数、递增参数等。强调一下，如果你不会预估容量，可以直接多加一些线程，然后在递增的过程中查看曲线的变化；</li><li>确定正式基准场景的压力参数。</li></ol><p>对于其他接口，我们也用这样的思路一个个执行下去。当然，对于这个过程，我们也需要在测试过程中不断地修正。</p><p>现在，我们根据上面讲述的过程，总结一下基准场景的目的：</p><ol><li><p><strong>获得单接口最大TPS</strong>：如果单接口最大TPS没有超过容量场景中的要求，那就必须要调优。那如果超过了，是不是就不需要调优了呢？我们接着看第二个目的。</p></li><li><p><strong>解决单接口基准场景中遇到的性能问题</strong>：也就是说，当我们在做单接口测试时，碰到了性能瓶颈一定要分析，这就涉及到了性能分析逻辑。所以，性能分析基本上可以分为两大阶段：</p></li></ol><ul><li><p>第一阶段：硬件资源用完。即在基准场景中，我们要把CPU、内存、网络、IO等资源中的任一个耗尽，因为在这种情况下，我们很容易从全局监控的性能计数器中看到现象，可以接着去跟踪分析。</p></li><li><p>第二阶段：优化到最高TPS。即在基准场景中，我们要把单接口的TPS调到最高，以免成为容量场景中的瓶颈点。</p></li></ul><p>如果第一阶段的目标达不到，那么不用多想，我们肯定要找瓶颈在哪里。要是硬件资源已经用完了，TPS也满足了容量场景中的要求，那么，从成本的角度来考虑，这个项目就不需要再进行下去了。如果硬件资源用完了，但TPS没有满足容量场景中的要求，那就必须优化。</p><p>下面我们先来执行一个单接口场景，看一下上面的思路如何落地的。</p><h2 id="登录接口"><a aria-hidden="true" tabindex="-1" href="/blog-architect/高楼的性能工程实战课/04.基准场景/01#登录接口"><span class="icon icon-link"></span></a>登录接口</h2><p>按照上面所讲的基准场景的设计步骤，我们先试运行一下这个接口的基准场景。注意，在基准测试中，试运行的过程只是为了看一下基本的接口响应时间，并不是为了完成基准场景。</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimaged840d876c3cd1828e331270d8946524fd940.07fa5f4e.png" alt=""/></p><p>啊，满目疮痍呀！</p><p>从图中看，虽然场景执行时间并不长，但是10个线程上来就报了错，响应时间和TPS也都达到了让人伤心的程度，只有12.5TPS。这可怎么办？</p><p>没办法，我们只有分析这个过程了。接下来的内容就是我对问题的分析过程。主要是看一下，我们前面提到的性能分析思路是如何落地的。</p><ul><li><strong>问题现象</strong></li></ul><p>如上图所示，这现象老明显了。</p><ul><li><strong>分析过程</strong></li></ul><p>从我一直提倡的RESAR性能分析逻辑上来说，针对响应时间长的问题，我们首先要做的就是拆分时间。由于这个系统已经部署了SkyWalking，我们自然要果断地用它看看时间浪费在了哪里。</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimagec43dc476c0b16e52c94d8953f4fa31265f3d.481c21dd.png" alt=""/></p><p>你看图中，一个Token的SelfDuration居然要5秒多！唉，开源项目的坑还是多呀。看起来功能似乎都实现了，连Star都好几万了，但是完全没性能意识。</p><p>不过这样也好，这下我们可有的玩了。我们做性能分析的人，就是要收拾这样的烂系统，才能快速成长嘛。</p><p>话说回来，既然Token接口响应时间长，我们在SkyWaking中又看不到完整的调用栈，那么接下来就有两个动作可以做：</p><ol><li>打印一个完整的栈，看看调用链路。</li><li>不打印栈，直接连到Java进程中看方法的时间消耗。</li></ol><p>我们用第一个方法看到调用链路，也还是要跟踪具体方法的耗时，只有这样才能把证据链走下去。在这里，我就直接用第二个方法了。</p><p>在第二个方法中，我们要看方法的时间消耗，可以使用的工具其实有很多，像JDB/JvisualVM/Arthas这些都可以。这里我们用Arthas来跟踪一下。</p><p>首先，我们跟踪一下那个Token的方法。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">trace com.dunshan.mall.auth.controller.AuthController postAccessToken &#x27;#cost &gt; 1000&#x27; -n 3</span></div><div class="token-line"><span class="token plain">    trace org.springframework.security.oauth2.provider.endpoint.TokenEndpoint postAccessToken &#x27;#cost &gt; 1000&#x27; -n 3</span></div><div class="token-line"><span class="token plain">    trace org.springframework.security.oauth2.provider.token.AbstractTokenGranter getOAuth2Authentication &#x27;#cost &gt; 1000&#x27; -n 3</span></div><div class="token-line"><span class="token plain">    trace org.springframework.security.authentication.AuthenticationManager getOAuth2Authentication &#x27;#cost &gt; 500&#x27; -n 3</span></div><div class="token-line"><span class="token plain">    trace org.springframework.security.authentication.ProviderManager authenticate &#x27;#cost &gt; 500&#x27; -n 3</span></div><div class="token-line"><span class="token plain">    trace org.springframework.security.authentication.dao.AbstractUserDetailsAuthenticationProvider authenticate &#x27;#cost &gt; 500&#x27; -n 3</span></div></pre></div><p>我们用上面的语句一层层跟踪下去，最终来到了这里：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage6c3b6c71c0b24ff382d6291db53012d3a83b.c01dfc1c.png" alt=""/></p><p>请你注意，我们即使不用Arthas，采用其他的工具也可以达到同样的效果。所以，请你不要迷恋工具，要迷恋就迷恋哥。</p><p>既然这个authenticate方法耗时比较长，那我们就打开源代码看看这一段是什么东西。</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage26c1269c00655a509b4803915a9c898379c1.37b5138a.png" alt=""/></p><p>接着，我们调试跟踪进去，看到如下部分：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage193a198e300b04a133156b1793dafc048d3a.646582e7.png" alt=""/></p><p>原来，这里是一个加密算法BCrypt。</p><ul><li><strong>优化方案</strong></li></ul><p>我解释一下，Bcrypt在加密时，每一次HASH出来的值是不同的，并且特别慢！</p><p>我们跟踪到这里，解决方案其实比较明确了，那就是用更快的加密方式，或者去掉这个加密算法。我们把更换加密方式这个问题留给开发去解决。作为性能分析人员，我决定把这个加密算法直接去掉，咱们先往下走。</p><ul><li><strong>优化效果</strong></li></ul><p>优化效果如下：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimagee428e487d4cc5eb67d58b6afc9e11eba7b28.9bd90c46.png" alt=""/></p><p>从图中可以看到，对于同样的线程数，现在TPS从20涨到了80了。</p><p>从这个简单的分析逻辑中，你可以看到，我们通过响应时间的拆分跟踪，知道了哪个方法慢，再进一步去分析这个方法，确定解决方案。这就是一个最简单的RESAR性能分析七步法的应用，看起来我们似乎在这个分析过程中跳过了七步法中的分析架构图这样的步骤，但实际上在我们分析的过程中，是跳不开的，因为不管是看架构图，还是看调用链，都是要在脑子中有架构逻辑的。</p><p>在基准场景中，我们还会遇到各种问题，后面我都会一一记录下来，希望能给你一些借鉴。</p><h2 id="总结"><a aria-hidden="true" tabindex="-1" href="/blog-architect/高楼的性能工程实战课/04.基准场景/01#总结"><span class="icon icon-link"></span></a>总结</h2><p>根据RESAR性能工程理论，在性能场景中，我们按执行过程，可以将场景分为四类：基准场景、容量场景、稳定性场景和异常场景。这些场景各有目的，在这节课中，我们主要描述了基准场景的逻辑，并给出了实例。</p><p>基准场景有两个重要的目的：</p><ol><li><p>获得单接口最大TPS；</p></li><li><p>解决单接口基准场景中遇到的性能问题。</p></li></ol><p>这两个目的对我们很重要，都是为了容量场景打基础的。</p><p>在这节课中，我主要想让你感受一下性能分析的过程。当然了，我们最后的这个优化效果其实还没有达到我对性能的要求。不过，你放心，在后面的课程中你将看到更多的分析逻辑。</p><p>来，跟哥往下走。</p><h2 id="课后作业"><a aria-hidden="true" tabindex="-1" href="/blog-architect/高楼的性能工程实战课/04.基准场景/01#课后作业"><span class="icon icon-link"></span></a>课后作业</h2><p>最后，请你思考一下：</p><ol><li>为什么RESAR性能工程按过程只分为四类场景？</li><li>在分析代码时间时，我们如何跟踪Java的执行耗时，有多少种手段？</li></ol><p>记得在留言区和我讨论、交流你的想法，每一次思考都会让你更进一步。</p><p>如果这节课让你有所收获，也欢迎你分享给你的朋友，共同学习进步。我们下一讲再见！</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/ssrc/高楼的性能工程实战课/04.基准场景/01.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">2023/9/29 14:47:35</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog-architect/umi.ded6fefd.js"></script>
  </body>
</html>
