<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog-architect/umi.3ec1f225.css" />
    <script>
      window.routerBase = "/blog-architect";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>
      26 | 稳定性场景之一：怎样搞定业务积累量产生的瓶颈问题？ - 大师兄
    </title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/高楼的性能工程实战课/05.容量稳定性异常场景/04" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-architect/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>后端开发<ul><li><a href="/blog-architect/spark性能调优实战">spark性能调优实战</a></li></ul></span><span>架构师<ul><li><a href="/blog-architect/设计模式之美">设计模式之美</a></li><li><a href="/blog-architect/架构实战案例解析">架构实战案例解析</a></li><li><a href="/blog-architect/许式伟的架构课">许式伟的架构课</a></li><li><a href="/blog-architect/说透中台">说透中台</a></li><li><a href="/blog-architect/oauth2.0实战课">oauth2.0实战课</a></li><li><a href="/blog-architect/从0开始学架构">从0开始学架构</a></li><li><a href="/blog-architect/即时消息技术剖析与实战">即时消息技术剖析与实战</a></li><li><a href="/blog-architect/如何设计一个秒杀系统">如何设计一个秒杀系统</a></li><li><a href="/blog-architect/如何落地业务建模">如何落地业务建模</a></li><li><a href="/blog-architect/性能优化高手课">性能优化高手课</a></li><li><a href="/blog-architect/性能工程高手课">性能工程高手课</a></li><li><a href="/blog-architect/手把手带你搭建秒杀系统">手把手带你搭建秒杀系统</a></li><li><a href="/blog-architect/技术与商业案例解读">技术与商业案例解读</a></li><li><a href="/blog-architect/推荐系统三十六式">推荐系统三十六式</a></li><li><a href="/blog-architect/检索技术核心20讲">检索技术核心20讲</a></li><li><a href="/blog-architect/软件设计之美">软件设计之美</a></li><li><a href="/blog-architect/高并发系统设计40问">高并发系统设计40问</a></li><li><a aria-current="page" class="active" href="/blog-architect/高楼的性能工程实战课">高楼的性能工程实战课</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-architect/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>后端开发<ul><li><a href="/blog-architect/spark性能调优实战">spark性能调优实战</a></li></ul></li><li>架构师<ul><li><a href="/blog-architect/设计模式之美">设计模式之美</a></li><li><a href="/blog-architect/架构实战案例解析">架构实战案例解析</a></li><li><a href="/blog-architect/许式伟的架构课">许式伟的架构课</a></li><li><a href="/blog-architect/说透中台">说透中台</a></li><li><a href="/blog-architect/oauth2.0实战课">oauth2.0实战课</a></li><li><a href="/blog-architect/从0开始学架构">从0开始学架构</a></li><li><a href="/blog-architect/即时消息技术剖析与实战">即时消息技术剖析与实战</a></li><li><a href="/blog-architect/如何设计一个秒杀系统">如何设计一个秒杀系统</a></li><li><a href="/blog-architect/如何落地业务建模">如何落地业务建模</a></li><li><a href="/blog-architect/性能优化高手课">性能优化高手课</a></li><li><a href="/blog-architect/性能工程高手课">性能工程高手课</a></li><li><a href="/blog-architect/手把手带你搭建秒杀系统">手把手带你搭建秒杀系统</a></li><li><a href="/blog-architect/技术与商业案例解读">技术与商业案例解读</a></li><li><a href="/blog-architect/推荐系统三十六式">推荐系统三十六式</a></li><li><a href="/blog-architect/检索技术核心20讲">检索技术核心20讲</a></li><li><a href="/blog-architect/软件设计之美">软件设计之美</a></li><li><a href="/blog-architect/高并发系统设计40问">高并发系统设计40问</a></li><li><a aria-current="page" class="active" href="/blog-architect/高楼的性能工程实战课">高楼的性能工程实战课</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog-architect/高楼的性能工程实战课">高楼的性能工程实战课</a></li><li><a href="/blog-architect/高楼的性能工程实战课/01.开篇词">01.开篇词</a><ul><li><a href="/blog-architect/高楼的性能工程实战课/01.开篇词/01"><span>开篇词 | 打破四大认知局限，进阶高级性能工程师</span></a></li></ul></li><li><a href="/blog-architect/高楼的性能工程实战课/02.性能工程的核心理念">02.性能工程的核心理念</a><ul><li><a href="/blog-architect/高楼的性能工程实战课/02.性能工程的核心理念/01"><span>01 | 性能工程：为什么很多性能测试人员无法对性能结果负责？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/02.性能工程的核心理念/02"><span>02 | 关键概念：性能指标和场景的确定</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/02.性能工程的核心理念/03"><span>03 | 核心分析逻辑：所有的性能分析，靠这七步都能搞定</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/02.性能工程的核心理念/04"><span>04 | 如何构建性能分析决策树和查找瓶颈证据链？</span></a></li></ul></li><li><a href="/blog-architect/高楼的性能工程实战课/03.性能工程的实践关键点">03.性能工程的实践关键点</a><ul><li><a href="/blog-architect/高楼的性能工程实战课/03.性能工程的实践关键点/01"><span>05 | 性能方案：你的方案是否还停留在形式上？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/03.性能工程的实践关键点/02"><span>06 | 如何抽取出符合真实业务场景的业务模型？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/03.性能工程的实践关键点/03"><span>07 | 性能场景的数据到底应该做成什么样子？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/03.性能工程的实践关键点/04"><span>08 | 并发、在线和TPS到底是什么关系？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/03.性能工程的实践关键点/05"><span>09 | 如何设计全局和定向监控策略？</span></a></li></ul></li><li><a href="/blog-architect/高楼的性能工程实战课/04.基准场景">04.基准场景</a><ul><li><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/01"><span>10 | 设计基准场景需要注意哪些关键点？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/02"><span>11 | 打开首页之一：一个案例，带你搞懂基础硬件设施的性能问题</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/03"><span>12 | 打开首页之二：如何平衡利用硬件资源？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/04"><span>13 | 用户登录：怎么判断线程中的Block原因？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/05"><span>14 | 用户信息查询：如何解决网络软中断瓶颈问题？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/06"><span>15 | 查询商品：资源不足有哪些性能表现？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/07"><span>16 | 商品加入购物车：SQL优化和压力工具中的参数分析</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/08"><span>17 | 查询购物车：为什么铺底参数一定要符合真实业务特性？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/09"><span>18 | 购物车信息确定订单：为什么动态参数化逻辑非常重要？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/10"><span>19 | 生成订单信息之一：应用JDBC池优化和内存溢出分析</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/11"><span>20 | 生成订单信息之二：业务逻辑复杂，怎么做性能优化？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/12"><span>21 | 支付前查询订单列表：如何分析优化一个固定的技术组件？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/04.基准场景/13"><span>22 | 支付订单信息：如何高效解决for循环产生的内存溢出？</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景">05.容量稳定性异常场景</a><ul><li><a href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/01"><span>23 | 决定容量场景成败的关键因素有哪些？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/02"><span>24 | 容量场景之一：索引优化和Kubernetes资源分配不均衡怎么办？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/03"><span>25 | 容量场景之二：缓存对性能会有什么样的影响？</span></a></li><li><a aria-current="page" class="active" href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/04"><span>26 | 稳定性场景之一：怎样搞定业务积累量产生的瓶颈问题？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/05"><span>27 | 稳定性场景之二：怎样搞定磁盘不足产生的瓶颈问题？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/06"><span>28 | 如何确定异常场景的范围和设计逻辑？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/07"><span>29 | 异常场景：如何模拟不同组件层级的异常？</span></a></li></ul></li><li><a href="/blog-architect/高楼的性能工程实战课/06.特别放送">06.特别放送</a><ul><li><a href="/blog-architect/高楼的性能工程实战课/06.特别放送/01"><span>我们这个课程的系统是怎么搭建起来的？</span></a></li></ul></li><li><a href="/blog-architect/高楼的性能工程实战课/07.性能结论">07.性能结论</a><ul><li><a href="/blog-architect/高楼的性能工程实战课/07.性能结论/01"><span>30 | 如何确定生产系统配置？</span></a></li><li><a href="/blog-architect/高楼的性能工程实战课/07.性能结论/02"><span>31 | 怎么写出有价值的性能报告？</span></a></li></ul></li><li><a href="/blog-architect/高楼的性能工程实战课/08.结课测试">08.结课测试</a><ul><li><a href="/blog-architect/高楼的性能工程实战课/08.结课测试/01"><span>一套习题，测出你的掌握程度</span></a></li></ul></li><li><a href="/blog-architect/高楼的性能工程实战课/09.结束语">09.结束语</a><ul><li><a href="/blog-architect/高楼的性能工程实战课/09.结束语/01"><span>结束语 | 做真正的性能项目</span></a></li></ul></li><li><a href="/blog-architect/高楼的性能工程实战课/summary">高楼的性能工程实战课</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="稳定性场景的要点" data-depth="2"><a href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/04#稳定性场景的要点"><span>稳定性场景的要点</span></a></li><li title="1. 运行时长" data-depth="3"><a href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/04#1-运行时长"><span>1. 运行时长</span></a></li><li title="2. 压力量级" data-depth="3"><a href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/04#2-压力量级"><span>2. 压力量级</span></a></li><li title="场景运行数据" data-depth="2"><a href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/04#场景运行数据"><span>场景运行数据</span></a></li><li title="全局监控分析" data-depth="2"><a href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/04#全局监控分析"><span>全局监控分析</span></a></li><li title="定向监控分析" data-depth="2"><a href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/04#定向监控分析"><span>定向监控分析</span></a></li><li title="定向分析第一阶段" data-depth="3"><a href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/04#定向分析第一阶段"><span>定向分析第一阶段</span></a></li><li title="总结" data-depth="2"><a href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/04#总结"><span>总结</span></a></li><li title="课后作业" data-depth="2"><a href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/04#课后作业"><span>课后作业</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="26--稳定性场景之一怎样搞定业务积累量产生的瓶颈问题"><a aria-hidden="true" tabindex="-1" href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/04#26--稳定性场景之一怎样搞定业务积累量产生的瓶颈问题"><span class="icon icon-link"></span></a>26 | 稳定性场景之一：怎样搞定业务积累量产生的瓶颈问题？</h1><p>你好，我是高楼。</p><p>根据我们的RESAR性能理论，在执行完基准场景、容量场景之后，接下来就是稳定性场景了。</p><p>做过性能项目的工程师应该都有一个感觉：在跑稳定性场景之前，内心是战战兢兢的，因为不知道在运行长时间之后，系统会是什么样的表现。</p><p>并且，还有一个复杂的地方就是，在稳定性场景中，由于运行的时间长，出现问题后，我们分析起来会比较困难，主要有三点原因：</p><p>（1）分析一定要有完整且持续的计数器监控。因为在稳定性场景中，实时查看性能计数器是不现实的，我们不可能一直盯着。而且，问题出现的时间点也不确定。所以，在分析问题时，我们需要完整且持续的计数器监控。</p><p>（2）累积业务量产生的问题点在整个系统中也是不确定的。</p><p>（3）你知道，稳定性场景回归比较耗时，在分析优化的过程中，但凡调个参数、改行代码啥的，总是要回归场景的，而把稳定性场景拉起来就需要几个小时。所以，稳定性场景中的优化动作即便看似简单，也会消耗比较长的时间。</p><p>基于这几点原因，<strong>我们在稳定性运行之前，一定要想好监控哪些计数器</strong>，避免在稳定性运行过程中遇到问题时，发现没有可用的计数器分析问题，那就悲催了。这是极有可能出现的情况，你要格外注意。</p><p>根据<a target="_blank" rel="noopener noreferrer" href="https://time.geekbang.org/column/article/361138">第9讲<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中提到的监控逻辑，在执行我们稳定性场景前，我们已经按“组件 - 模块 - 计数器”这样的逻辑罗列了所有需要监控的计数器，并且也用相应的工具去实现了。一切看起来已经万事具备。下面我们来看看在执行稳定性场景时，有哪些要点需要注意？</p><h2 id="稳定性场景的要点"><a aria-hidden="true" tabindex="-1" href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/04#稳定性场景的要点"><span class="icon icon-link"></span></a>稳定性场景的要点</h2><p>在稳定性场景中，有两点是需要你着重关注的：一个是运行时长，另一个是压力量级。</p><h3 id="1-运行时长"><a aria-hidden="true" tabindex="-1" href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/04#1-运行时长"><span class="icon icon-link"></span></a>1. 运行时长</h3><p>我们在前面提到，容量场景是为了看系统所能承受的最大容量，而<strong>稳定性场景主要看的是系统提供长时间服务时的性能稳定性，观察系统在长时间运行过程中出现的累积效应</strong>。因此，运行时长就是稳定性场景中非常重要的一个指标了。</p><p>在每个业务系统中，稳定性运行时长都不是固定的，这取决于业务系统的具体应用场景。</p><p>对于大部分长年不能宕机的系统来说，它们靠的不是系统中的所有节点都能长年运行，而是<strong>架构设计可以在任一节点出现问题之后，将对应的业务承接到其他节点上</strong>。而这些架构设计就涉及到了DNS分区、扩展能力、高可用能力等技术。</p><p>可是，对于我们性能项目来说，即便是长年不宕机的系统，稳定性场景也不可能长年运行。因为如果这样做，就相当于长年运行着另一个生产系统，成本高、维护难，这显然是非常不现实的。</p><p>这时候，另一个岗位的重要性就体现出来了，那就是：运维。</p><p>在运维的职责里，就有“处理生产环境中出现的各种问题”这一项，我们俗称背锅侠。运维要做的就是保障系统在各种场景下都要正常运行。不过我想多啰嗦几句，要保证这一点，就不能只靠运维岗的工程师，它需要一个企业中所有技术岗的通力合作。换句话说，运维的职责实际上应该由一个企业的所有技术人员来承担。</p><p>话说回来，我们知道，运维会制定各种工作内容来保障系统的正常运行，其中，非常重要的一项就是，搭建完善的监控系统，因为你让一个运维眼睛都不眨眼地盯着系统是不现实的。而我们这个课程中提到的全局监控和定向监控，就可以完全覆盖到这种监控系统的要求。</p><p>为什么要提到运维呢？</p><p>因为<strong>稳定性场景的运行时长，不能覆盖长年运行的系统，这就需要运维人员来保障那线上的稳定性状态了</strong>。总体来看，运维有两大类工作内容：一类是日常巡检（用手工或自动化的方式，查看系统的健康状态）；另一类是运维动作（用手工或自动化的方式，完成归档、日志清理等动作）。</p><p>有些系统有固定的运维周期，周期按照天、周或者月来计算。而有些系统是没有固定的运维周期的，这就要靠监控系统提供的信息来判断什么时候做运维动作了。在自动化运维比较完善的情况下，有些运维动作就由自动化系统承接了；在自动化运维不完善的情况下，就只能靠人了。</p><p>不过，不管有没有自动化运维，每个系统都是有运维周期的，像下面这样：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage50c950abb9b4044ca8205b4725a0936fd6c9.2d2f3828.jpg" alt=""/></p><p>下面我们具体来看看，对于上述两种系统，怎么计算稳定性场景的运行时长。</p><ul><li><strong>有固定运维周期的系统</strong></li></ul><p>对于有固定运维周期的系统，稳定性场景的运行时长就比较容易定义了。我们先根据生产系统的数据统计，看一下系统在固定的运维周期内，最大的业务容量是多少。</p><p>假设你根据生产系统统计出，在之前的运维周期中，有1亿的业务容量，而在容量场景中得到的最大TPS有1000。那么，我们就可以通过下面这个公式来计算：</p><p>$$ 稳定性运行时长 = 1亿(业务累积量) \div 1000(TPS) \div 3600(秒) \approx 28(小时) $$</p><p>用这种方式得出的稳定性运行时长，对于有固定运维周期的系统来说已经足够了。</p><ul><li><strong>没有固定运维周期的系统</strong></li></ul><p>对于没有固定运维周期的系的系统，该怎么办呢？也许有人会说，运行时间只有尽可能长了。但是，“尽可能”也得有一个界限。根据我的经验，我们不能用“尽可能”来判断稳定性场景的运行时长。</p><p>根据上面的运算公式，TPS来自于容量场景，时间是最大的变量，所以业务累积累是不确定的。现在，我们要做的就是把业务累积量确定下来。</p><p>我们知道，<strong>业务积累量需要根据历史业务的统计数据来做决定</strong>。如果你的系统一个月有1000万的业务累积量，同时，稳定性运行的指标是稳定运行三个月（也就是说，即便没有固定的运维周期，我们也得给出一个时间长度）：<br/><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimagea813a8e36a90955af2aa75638b48f924d613.81a0df9c.jpg" alt=""/></p><p>那么，总业务累积量就是3000万。</p><p>我们再根据上面的公式来计算就可以了：</p><p>$$ 稳定性运行时长 = 3000万(业务累积量) \div 1000(TPS) \div 3600(秒) \approx 8(小时) $$</p><p>总之，<strong>不管是什么样的系统，要想运行稳定性场景，都得确定一个业务累积量</strong>。</p><h3 id="2-压力量级"><a aria-hidden="true" tabindex="-1" href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/04#2-压力量级"><span class="icon icon-link"></span></a>2. 压力量级</h3><p>我们再来看压力量级，这是稳定性场景中必须要确定的另一个前提条件。</p><p>我们在网上经常能看到这样的说法：稳定性的压力应该用最大TPS的80%来运行。可是，我们来看一下<strong>稳定性场景的目标：保障系统的业务累积量</strong>。也就是说，我们只要保证这一目标就可以了，至于TPS是多少，并不重要。</p><p>因此，<strong>我们不用考虑80%的问题，直接用最大TPS来运行即可</strong>。一个系统如果能在最大TPS的状态下正常运行，才算是真正经受住了考验。</p><p>你可能会有这样的疑问：当一个系统在最大TPS状态下运行，如果有突增的压力需要更高的TPS怎么办？请你注意，稳定性场景不是为了解决突增的压力峰值而设计的。如果你要考虑突增的业务压力，我建议你增加容量场景来验证。</p><p>另外，如果我们要对付突增的业务容量，不止要在性能场景中考虑增加容量场景，还要在架构设计时，把相应的限流、熔断、降级等异常保障机制加进来。</p><p>到这里，我们就把两个重要的稳定性条件讲完了。</p><p>下面我们具体操作一下，以我们这个课程的电商系统为例，看看稳定性场景该怎么确定。</p><h2 id="场景运行数据"><a aria-hidden="true" tabindex="-1" href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/04#场景运行数据"><span class="icon icon-link"></span></a>场景运行数据</h2><p>因为这是一个示例系统，所以我们先定一个小目标：稳定运行业务累积量为5000万。</p><p>对于这个系统，我们在容量场景中得到的最大TPS在1700，但是随着容量场景的不断增加，数据库中的数据量越来越大，TPS也会慢慢降低，因为我并没有做数据库的容量限制和归档等动作。那我们就用容量场景中的相应的压力线程来运行稳定性场景，让我们的理论能在落地时得到印证。根据前面的计算公式，运行时长为：</p><p>$$ 稳定性运行时长 = 5000万 \div 1700(TPS) \div 3600(秒) \approx 8.16(小时) $$</p><p>也就是说我们要运行稳定性场景8个小时多一点。</p><p>下面我们来看一下具体的运行数据：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage62b662bbb6910332dcb7d9954377d704ddb6.d02cc888.png" alt=""/></p><p>从数据上来看，在稳定性场景运行4个多小时的时候，TPS就没了，响应时间又非常高，这明显是出现问题了。</p><p>这时候的业务积累量为：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASsAAAB2CAYAAACQw7UpAAABOmlDQ1BpY2MAACjPY2BgEkksKMhhYWBgyM0rKQpyd1KIiIxSYH/KwMQgBhQUZWBOTC4ucAwI8AHyGGA0Kvh2jYERRF/WBZnVd6Vt6bazHIc/rbd65XHH8QYDfsCVklqcDKT/AHFGckFRCQMDYwqQrVxeUgBidwDZIkVARwHZc0DsdAh7A4idBGEfAasJCXIGskH2CSRnJALNYHwBZOskIYmnI7Gh9oIAn4+7gmdAsIJbqI+PhwsDdUFJakUJiHbOL6gsykzPKFFwBIZSqoJnXrKejoKRgZEhAwMozCGqP98AhyWjGAdCrBDoRytPBgamXIRYQgADw44PIK8ixFR1GBh4jjMwHIgtSCxKhDuA8RtLcZqxEYTNvZ2BgXXa//+fwxkY2DUZGP5e////9/b///8uY2BgvgXU+w0A3hdh3f1YcskAAAAgY0hSTQAAeiYAAICEAAD6AAAAgOgAAHUwAADqYAAAOpgAABdwnLpRPAAAAAZiS0dEAP8A/wD/oL2nkwAAAXx6VFh0UmF3IHByb2ZpbGUgdHlwZSBpY2MAADjLpVNZbsQgDP3nFD2CN2xyHAJB6v0vUAMhykxnqlZ9UkRsjP28hc9SwkdHZArQQSiKBgZaQIYGtOphYhRJTIggprjFTAB2xP4CAHVaYpc5KCobG4jLEaTAiWf5JzSP2hnhUlSmupilo0rSHHctFVLhRrlxPrKkWgRrenYWfhPxhqyi0Vj55HIy1hQ8MTCyWRnUs0LEZl4hWPp0MsBetVGtKW5l6YPa/WKHdaEPD4rcHIk3YDK6UkRwRpp0McHjvKCibx544DeOHnK+cEjx4CCb94791BhdUySJvC7eX4v9Fv92ZD2jZHI5EtbmXdqMdFNTv/KEzpnS2JPUQ5kOKgRM3L8xf2viHxg1HsVbA4q+BOlajTsLnN3kLNvsjdbwylAhjnNPbfWKX9n5Is45KsUGowKxegroaSF8BzYF8c4qM989Iey7jb+4aWgdHKfCaFBttdrQu+E4a56bzjXPwE3DF3rm5HE4k0upAAAAAW9yTlQBz6J3mgAAIXRJREFUeNrt3Xd8FHXi//HXzOzOtmSTTSENCF0gIYQWIEAAUZAiIqKe2MudeOpZzzu9O8+vfj3LnT+9s5c7PcWGKCgoiiIqR29SFKnSQ0nP9jLz+2PjJksKJITE/d7n+XjweLA7M5/57Gz2vZ/5zGc+K2V16qobDAYAJElCEAShPeiajs/vw+WsQtO0esul1LRMXdf19q6nIAgCRqMRRTFQXlYKROeS3FCCCYIgtIdAIADoqCa13jK5vSsnCIJQl6ZpGAzGes+LsBIEISaIsBIEISaIsBIEISaIsBIEISaIsBIEISYY2rsCQuvK7tKVwlGjOXzwAF8vXdLe1RGEViPC6gyZcelMjKra6HKPx838uXNafb/ZXboy88prWLNqRYNhVTCskO49e0U9F/D72bplMz98v7W9D5sgNEqE1Rly0aUziYuLa3R5WVnpScNqwuTzueW2u/jsk4U889TfWqVeBcMKmTBpSr3ndV3nyy8W89TfHoUYuaNhwMDBPPjo39j23VbuueOW9q6OcIaJsDpDLpteGwi33H43EyZNYc5bs3njtVfau2oAkbrYbHEMKijg5tvu5uxzzmX5N1+xdvXK9q6eINQjwqodDRg0hOtv/DWdOmej6zrbvv+OF595ir0/7uHxJ5+hT04uABMmTWFE0RhmXXsFoVCIq669gdHjzsFqteFyOln40Tzemf1vgsFgs+vgcjn5ZumXDB02gqKx4+jZ6yzWrl5JXFw81/3qJorGjkNVVcrKSnn3zddZtPAjAOwJCfz6N3cyrHAEAOvWrCa7Szfi4uOZde0VDBs5ql6r8MprbuCSmVdEhfbEKVO57IqrSXQk4fP5WPbVl/zrpedxOqsxGAxcee0NnDfpfKw2Gx6Ph6VffMZrr7zI9TfeHGkh9snJZf6iJfzujlvYvWtno9t4PJ72fsuF0yDCqp30zenHH//nYQAWLfyIeHs8I4vG8tBjT3DXrTexaOGHlJeXUTiyiB0/bOObpUvwej3cec8fKBxVxLcb1rN500YmTJzMpTOvxFldzfz3W9YHJssyaRmZAJSWlqAoCvfe/yD9+uezbs0q9u39kXHnTmDWLbfjdrv4+ssl3Hzb3RSOHEXx4cN889UShhWOJD0jA6fTecr7veDCGVw/62YOHzrI4kUf0y9/AOeeNwmbLY5HHrqfGZdezvSLf8H3W7ewdvVKhhWOZNL505AVhRX/+QZJkhg/cTLHjhzh44UfcvzYsSa3efapJ9r7bRdOgwirdnLJzCtRVZXnn36KTxbMB8BZXc2k86cxeeo0Xn35BVSzmcKRRfy4ZzcfzpuLqqpUVJSzeNHHvPbPF6muquJo8WF+e9/9DC4Y2qywyumXx2VXXoMiywwcUkDPXr05eqSYVSuWk9d/ALl5/Vm3ZhUP/uleADZ/u4EHHn6cceecx64dOxg0pACXy8l9v72dkuPHWLxoIc+89Oop799kNnPBRRfjcjn5/V2/oaK8HPVtlRdffZMBgwaTlJzCgEGDAHjvnTdZt2YVy5d9HQnmDevWoGsa4ydOprS0hA/mvA3Q5DZCbBNh1Q6Mqkr3Hj3x+/18u3Fd5PlVK5YzccoFkdO/E/n9fp5/+kl69e7D+PMmo5pMZNS0iFTV1Kw65PTLI6dfXuTx999t4a8PP0hlRTm9evdBlmWGDB3OgsVfRW2XmpZGZlZHTCYTe/fspuT4MQB8Xh+h0KnP4JHVsROOpGQMBgNvvDsvalkoFCI1NZXVK1fQJ6cfv733Tyz7eik7ftjGS889jdvtarTclmwjxAYRVu1ANRpRFIVgMIi3Tj+K3+9D13UsFmuj2177y1lcOONS3C4Xhw8dRDU1L6R+8lO/0eCCYfzpwb/QoUMaHm+4LjZb+CrmmtUrWL1iRdR2Lmc1RmP4jnjXaQSA2WxGlmXKSkt58/XoFpmuaxQXH2b79h+oKC9j6vQZnDPhPCZMmsJ1N97EU399lFUr/tNguR/MfbfZ2wixQYRVO3C5XFRVVpKemUlqhzTKSksBSEvPQJZljh870uB2mZkdmTz1QiorK7j5l9dQVVkZuXzfUuvWrmbH9m307pPDhIlT+OC9dygrKwHAYrayeNHCetv06ZuLFtLokJoGktTkUAe5kdlnq6uqCAaDWKxWNm1cz9EjxVHLFUUhf8BASkqOc/uvf4VRVTn/gulcff0vue5XNzUYPIqi0K9/frO2EWKHuN2mnXzz1RIUReHyq64jISGRjMwsZlw6E13XWLrkCwD0mokRHUnJWK02TGYTsixjMBhISHAQb7czbvzE06uIrjPnrdlomsa0iy4m3m5n/do1eL0e+ubmcsH0i5Flmd59cnjq2ZcYVjiSPXt2UVJyjMyOHZk2/WIkSaJwVBEWizlSbFVFJQB9++WRkOigc5euDCoYGll+4MB+9uzeicVi4fobbyIhIZFEh4Pbf3svs269HUVRuOX2u3ng4ccZVDCUgN/Prh3bo3JR03V0XScuPp64+HhMJtNJtxFil2hZtZN5c98lp19/BgwazOz35gPhgZlffLaIZV8vBWD3zp34fT4Khg3njTnzuOVX17Jm1QpGjBrNc6+8BoDL6UTTNExmcwtrAmvXrGLn9h84q09fpky9kLdn/5uXn3uGWbfexg2zbuaGWTcD4HG70XQdn9fLa6+8yB333Mf1N/6a62/8NaFQKKrMzZs2sG/vj2R36crsOeE+KberzmmjrvPk44/w4CN/ZfiIIoaPKIocg48/mo8/EOCfLz7Pnffcy58fepRgIIDBaCQUCvH+u+HO9L0/7qaivJxOnbN5+/0F3P/7u0+6jRC7pOTUdF38UMSZ9dMtLt9t2czmbzdEnpdlmeEjRkXGWf2w7Xs2bVwftW3f3H7k5Q/E7/fz6cKP8Ho9FI05m/TMLDxuFxvWrWX4yCJCwSAfzX+fzMysJu8NbKwu3Xv0omB4Ic7qKhbM/wCAzKyODB0+ArPFgsvpZNnXS2vmxq7ZpmcvBg0pAMLBeve9fwJg1rVXUFlZQbzdzthx47HZbBw/foxDBw+QP3Bw1L7NZgujzx6HIykZLRRiy6Zv2Vbntp/UDh0oHDkaq82G1+Nh7eqVHDywP7K8U6dsCkeFg+7LLxZz/NjRk24j/LypqkogEMDtih4GI8JKaBUJCYm88OpsoDasBKElGgsr0WclCEJMEH1WQqvw+ry8/+5bkf8LQmsTp4GCIPysiNNAQRBimggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigggrQRBigqHd9iyBoaMVYycLkkUBHTR3iMBeF6GjXtCbWVamBWMXK5JZgZBO8LiPwE4nul877arKDiOmPnY8a8og2IyKyWDMtmHoaEFSZdAgVOEnsMuJVh1sdDPzQAeyw9ji+urOEJ7Vpa1eVoMvMdGI2jMeOd4AEug+jeAhD4F9LjjdQy9LqH3i0d0hAj+6TrMwIda1fVjJEpbhyViLUsN/4A0IlftxLTmGb0P5SYsz9UvANiEdJUmtt0wPaHhWlOJechS9OSEDSKqMKS8B80AHxmwbmi+Ed335qZUjgXlwErZz05DjGniNOvh3VFO98DBaqb/+axqYiNotrsWHOHjUGwmY1iyrLmNXG7YJ6Rg7WUGqv53mC+FZWYpn6XH0QPNSy5BhxjzIgWmAA9mi4PriiAgroW3DSrIq2K/IRu1ia3I9xaFin9ERTxcrzvmHGv6GlsA2MQPriJQGPywAklHGOjoVQxcrVa/tRfed5EMjgbGLDdOARMz9E5GMLThLliDugkwsBclNrqOeFY+jU3cqXtlD6IivVY9zc4O5uWVZx6RiOze90eMOIJsUbGM6YOoVT+Wre9FcQZoiWRTMgxyYByRiyLC06vEQ/m9ou7CSIf4XnesFVajCT/CwB8mkYMy2IRlqPwGWwUkEi714V9b/ZrcMS64XVJozSOCAGyXRiCHdElmmZtuIv6gjVW/vb/D0Uk4wYh7swDzIgZJYv4XWHObBDixDooMqVBUgeNCNZDVg7GxFksMVk60G7DOzqXh2V1SQBva60N2hU96nkmLCkG6OPPZurjgjZQGY8hPrBZXu1wjsc6EHNAyZlqhjaMi0EDejI1Wv761/7GVQe9sx5yei9rVHjosgNKTNwsqUm4Cpe+3piO7TqJp7AP93VZHnpDgD9ss7o2bXBpq1KBXvunKocyohxxmwnpNW+4HRwf31MVxfHAMt/Ikw9rCRMDM73IcFmHLsqGfF4/+hul7dEq7pgiHNzOmSTDLWs6Pr5fzsCJ5lxyMfVDlJJeHK7Mj+DCkmTAVJeJeVRMpxf3GsGTuFhOu6Rh5q7iC+9eVnpCzJJGObEB1U3o3lOD88HNU3qObasV/cKdIyNfWKw5htJbDXHbU7U98E7DM7n/ZxF/47tM3VQCncEqr7R+5cVBwVVAC6M0j12/vRvLUtAcVuxJBmilrPlJ+IbFEij33bqnB9fjQSVACBXS6qPzpc+20uSViaOGWsK1Tqw72s+X0tas94lITazmzfjqqooALQyvxUzzsUVVfLAAe0sFVh6GRF7Vob7r5Nlc1qSTWnLEMXW9TrCx7xUv3BoXoXMfxbq8JfMD+RJNTe9pPuXw/p+LZW4t9ZfdJ1hf8+bdKykiwGDBm1LRfNHcS3ubLBdbWqIIF9Lkxn1fxxS6AkqgQPeiLrqL3jazfQwbO8pMHTO9+WSkLj0lCSw6clxs5W5DhDg1fiQpUBfN9W4NtcQbDYi2SSMQ9JQmrGhTRjr+iObO+68gbrFTzgJnjUG+mbUVJNyAlGtHL/qewmimVEciTo9KCOZ1Vps8s41bIMHaK/NPzbqyDUcP+Yf0c1luG1p8PKCdv+RNd0Ajuq8X5XhX9LJbpfw3p2KmrPeAShrjYJK9mmIKm1LSGtMojubfzbX3M20TJQJBRHbZ+I7g8RPOpteN2Qjn93NZbk8IdGMsoYMi34t0d/c1e9s5/Q0dPv5K7b16OHdIKHG6mXDoFDnkhYSYqEId2Ev5lhpaSomPokRB77d1UTOt6y13EqZXmWleCpc7ralBNbWw1drAjsd1P68DZ0T8tagsJ/lzYJq1CJj5IHv6t94iQXq+qeaqDrhMpqPzSSQQqPy6qheUJNjqUKnTA0QEk1wQlh1RpBhVGOqrfu19DdjV8BO7EVpSSbgOad/liGp9RekNB1PMtPo1XVimUBUV8oQIMhqlUFTmsfwn+Xtulg1zn5sIEacqIRY2dr5HGoPECwbpjoRA3MlFQFSZEavVxf7xtePTNXnCQZqNN60H0h9FDjqayd0K/U3HrJcQZMAxIjj4PFXgI/OltU99YsCwCDFHUKiKbj3VTR8vJaoGBYId179qr3vK7rOKurWLdmNUeKD7dpnYTT034j2BsigW18eni0dw3P2rKofhE9oIVPG2oGW8oWGSVJJVjsbfbufk4kS/PeCnOBA9lc28J0rypt8YjxVivLIKF2j8M6rgOGrNqxUp61ZQT3uVtQYMsNHVbI+ElTGl3+y5tCLPl8MS8/9w88Hk8zSo5t5543iZTUDng9HubNfbe9q9MsP6uw+mkw5k+CpT68J3YY6+A/4MaSWtNhK0mYBiQSLD5Sv0AZTH1PfhXqZ6EZ12Ulk4x5aG3LJVQdwL+l8tQLaMWy4i/rhLlfYsMLdfBsKMe5sPiMHrqm6LrO2tUrcTnDLUVHUjJ9c3NRVRPnTpiIpmk88+Rf261+be3c8ybRp28uZWWlIqxaytjFSvwFWZGhBXpIxzn/UIOnj/7NleHL/TXrWoanENjnjh6zZZCwTc74P3lVydQ/ESW+tn/Mu7bslE+zz2RZJ/JsKMM579Dp3yN4GjRNY85bb7D9h22R5zKysvjrk8+SkJhI0eixvDP735Qcb8Z4NKFd/CzCSulgwn5Zdu0VIx1cnx0hsLvh+8H8u5wE9rkw1oyGlxSJhJnZ+LZXETrsAZOCOS+xwXsPdX/r3YrSPgdLwlJY2xLS/Vr0mKb2KqsBlkFJGDMs4autJc0flnGmFB86xMrlyzhv8vmYLRYyM7MiYWUwGJg6fQaTp15IamoHdF3naHEx895/l08/XoCu1/79JCencPUNN1I4sgiTyURVVSUffziPbj16MnT4CLZ9v5V7br8FgH+/8z5JSclRzwEMGDSYBx/5GwDP/v0JPv14QWRZtx49ufyqa8kfOBhVVfF6PKxbu5rX//UyxYcPRdaTZZnJU6dxwfSLSe2QhiRJVFdX8fXSJcx56w0qysu59fa7o06Lk5KSWbD4Kw4e2M9N118FQFp6BpdffR3Dho/AYrUSCgY5sH8fH8x9l6VfLG7vt639w0p2qCRc1SUqWDzry8Jjpxqj6VS/d4CEWd1rWwUSmHrboe7gQx00ZwC5TsshVBHbV6DU3vEYUmuHSPi+r0Jr4WtqjbKq5x7E+UH4gyMnGjF0tGIZ5Ih8kRgyLSRc3ZXyF3ajn+T+wLYUCNa+Tk0PN/0MBgP3/fkhhgwdHlkmSRIZWVncdOsdZHXsxCsvPAtAvN3Og4/+jc7ZXSLr2u0JXHblNQQCp/83lj9wMH944H8xm2vfH7PFwsiiMeTm9eeeO26h+FD4uN96x285Z8JEAILBIOg6dnsC518wnYGDhnDPHbfidFZTWlJCvD0eVTURCoWoKC+nojz85ZSekcnjTz6DIykJXdcJ+P0oBgNdunXnjt/eS1bHTsx+7Z/t+p6163xWcpyBhKu7RM2Y4PuhCmfdkeeNCJUHqHxxD4H9DXfc6j6N6g8P4f22os6TeovHIZ1ppzTWSCL6fkhNx7Py1MY9nbGyAjq6T0P3aYSO+vCtL6filT1R9xQqySrWMalteTiblNqhA4UjRgHgrK5m/969AEy76BKGDB2OrussmDeXy6ZP4YarLmPt6lVIksTkqdPodVZvAC6YfnEkqFYuX8a1l1/CzBlTWfjhBxgMp9cGsNvt3H737zCbzRw/dpR777qNCyedw/97/C94PB4SEx1c98ubAOjarTujzz4HgG+WLuHSaZOYPmU87775Brquk9WxE+dOmMirr7zINTNnsHvXTgAqKyu4ZuYM7r37NgDOv/AiHElJBAIBHrr/PqZPGc+1l1/C/n17kSSJ86ddREpqh3Z939qtZSWZZOKvzI4aFe3f7aTqrf2nPGdUqMxPxQu7MWZbMXaLq5kXSydU5se3uRLdEyLhV91q13eGosZstSqdqKuWkkFGkiX0RlK37hXP8Is/eceOIdsWNawjsN8dNbK/OVqzrHo0cC8+iqmvHclQc39gjh3XZ0eaNx9YK5BlmfETpzBwyFAAUlJSKRxZRFx8PLqu89G8uVRVVWJUVc6bPBWAXTu28/ILz4aHOTidvPz80+Tl52MymSkYPoId239gZNEYACrKy/nHE4/hrOnAf+m5pxkxagyOpKQW17lw1BiSU1LRdZ0Xnv07W7dsAmDpF4vJyc1jwqQp9MvLx56QQKLDgdEYPnPYvPlb/P7w6fb899/FH/CjKAqHDx066T4zMjIB8Hg8fLdlMwBlpSW8+MzfycnrHz6WUvveaN4+YWWQwlPFdKr9sPj3u6iava9Ff8yBfW4CDVwaV1JUjB3rfCB3V0PgzHxYIkMqbOFDKqkykio3OmBVtilRj5sctV+j7u0wAO4VJc2bpPAMldWQUFUAzRVESVBrXq8B2aI0OengmSBJEuMnTq73vMft5p03X49cEcvMzCKp5k6HUCjEL664Omp9reZezuwuXUlOSSUpOQWAXTu3R4IKwlcf9dM8kLk14RAMBumXl0/3HrXjxRxJ4TqaLRY6pKWzb++POKuriYuP54Ybb6Zr1+5s3bKJDevWMOetN055n1s2bWTI0OHY7XYef+oZln6xmO+2bGbL5m/ZvGlj27xZJ9EOk++B/dJOqHVmYAgWe6h+fV+rXYUCwqc5Z6dFjcr2rm29zuN6dAge86GkhFuKkiqjJKtozoY/nIZ0S/S2R5seJ6akmWrvlyTcqjzxtqFT1dKyLGNSMWbW1tv15TFCR5qo94mf2Xb4Zq47dEFRFIaNGIWqqhzYv48PP3gv0mGe6EiKnL717ptD7745DR87RUE1GlGU8JdNWUkLT8ObkJIaPmU2Go1Mu+iSRtdTZJmy0lIef+RB7rznPhITHUyeOo3JU6cRCoXYtHEDb73xKtu3fX/SfS6Y/wHpGVmcN3kK2V26cs0NNwJQXV3FZx8v4L133sLtbt8JENs2rCSIuyALU07tPWjBUh+Vr+2tN6L7dPdjPTctasyWf7eLwN4ze7ADe11R47rUPvYGW3ySVcHQqfZDr7kCJ+1Li7odBnCvLm1xK7GlZSlJKqbc2vcusN+Np5GwkuMMyLbaPy/dp6F72r6D/cShC3fecx9jzxlPz7N6M3zEKP7zzVcAhEK1dVuzagWrV65osLzjx44QCoXQtPAXq3Ka/VMNCQbCdfF6vcx+7Z8ND1rVdYqLw+PXNq5byw1XXsbI0WPoP2AQ+QMH4XAkMXDwEHL75fGne+/m+61bmt5nMMjzTz/JgvnvUziyiIFDCujVqzfx8XZm/OJy+ubm8Yd77gh34LeTNg0r2/g0LENqz+VDZX4q/7W31U4NJKOMmmPHUpgcdfqne0M4Fxxq1dOchvi2VYVH4NcEgXmwA8+aMrSy6Mv21sIU5Doj1v07mp4rXk4wYsqrDQnNG8K/saJFdTydsgK7XVgG175/1pEp+LZW1r+CKIF1XIeom5fDk/O1/7CR9955KzzUwGzm0suvYs2qFfj9fspKS/H7/ZhMJgwGA4sXLWy0DJPJhNfjxmw206lzdqvX8eiRcAgZjUZ27vihyaDp3qMniY4kgoEAX37+GUsWfwpA0dhx3H7371FNJqZMvbDJMlRVJTevP5IkU1x8mDlvz2bO27OxWm385q57GDFqNH1ycundN4etmze11VtVT5tdDbSMTMFaFH01QfOGiJuYjn1m55P+a2yKEXOBg8Rbe5D8xz6kPJCD/ZJO0UEV0Kh85wCh42d+nI9W6se3paL24FoNJF7fFfOQJAzp5vDA12mZWMfWHgc9pONZ2fRNw+YhSVG3w/g2VjR6enkyp1OWf1sVoTrBK9uNOGZ1xzIyJTxDaJoJU/8EEq7rimVQbajpIf2UZ2s40w7s3xtpTWV36cqoMWcDcPjQQfbUXCnLyx/I8JGjorabOHkqN978G2RZxufzse378I353Xr0ZODggsh6mVkdsZjrT8vs9YRb2B3S0rFaa+cM65eXX2/d5cu+QtM0FEXhiquvx2KpLc+RlMT9Dz1Ctx49ARg3fiIPPPwY9//vo3SveQ5g7aoVkRaZyVx/YklFVjCqNf2JisJdv/sjDzz8GDffdidSzem62+1i4/q1QLjvz2Bo+Q+PtIY2a1mpvePrTXxnzLRA5qnNt+1ZWUqI+qdKcpwBYyNzdodKfFTNOdB6V7lOgWvREYxdbZGpfRWHSvyFWY2u7152nOChxusnWRQsBY7IYz2kh++XbIHTLUv3a1TPPUDCtV0jrSbZbiRuUkYTG4F76bFGh5i0h/fnvM2IotGYzRYunXklK5Z9jcfj4bV/vshDjz6Bqqr87g9/Zu2qlezb+yP9BwzirD59Afh+6xaWfb2UeXPfZXDBMIxGI/fd/yDffPUlPp+XseeMx2K11tvnhvXryMzqRHJyCo89+TTfblhHTm4ePXqdVW/djevXsW7NKgqGFdKvfz5Pv/gqy5d9hdVqY2TRGOLi40lJSeWOW25kyeJFTJg4GdVk4o//8xcWL1qI3+9nwOAh2O12dF1n3ZrVkbKPFhfTp28u9oQE/vzQoxw+dIDn/vEk33z9JVOmXki/vHzuf+hRvtuyCbPZzKTzpwFQXlbGj7t3tev7plhtcQ9IbdDxaR7oqDdtSHN4N5Q3OGDR2NUW/estOgSPeHAtOUb1B4fQKls2QE8ySFhGpkQuvetBPTxQNdT0qYzu1/Bvd2Lsbovqs6lH03H/pwT350ebPD01D0mKuvfOv6Mabwunb2mNsrSKAIHdTozd4pCtSpPr6j4N54LDTQ/wbcCJ72lgj5PAj80Lu6E1sy7ous4Xn31CaZ2O8KrKSjIys+jeoyfx8XbKy8vZ8cM2jh87xu6dO8gfNBir1UbHztnk5vUnJbUDwWCQOW/P5pMF8wEoOX4Mr9dDXv8BqCYT3Xv0pFfvPng9HnRdx2A0UnL8GJ9/+gkAe/fspmBYIfF2O4kOB7375pCUnMyuHdtJdDiQZZm1q1eya+cOINwySsvIpHN2F+Li4+mTk0uPXmehmkzs2b2LJx57mIryMsrLyjiwfx95+QNxJCXRr38++QMHkZaegaaFWDD/fd57e3bktZeXlVE0dhxGo5H0jAySU1KZP3cOWzdtwpGURNfuPcjq2In8gYPIzeuPyWSivLyMRx66n4MH9rfo7665FEVB0zQCgeizISk5NV1vq7A6nd+v865vPKyM3WzhQYklPgL73K0zmZtBCg+a/KkjOqjjXl5y6kMrDBLmgQ5MOfbwj0SYFNB0QhUB/Dur8a4pO6WZIsyDHch15snyb6tqfFK/NiwLWcLUPwFTbzvGrjXBLIWnxgkc9IRf47ryFk2x/NN7+pPAHlezf4qroE5Yff7pJ5SWHI9anpaewdhzxiNJEuVlZXz68UeRZSaTmeEjR5GenoEkSTid1axeuYJjR+vfLJ+Z1ZFhhSMxmc1UV1XyzdIlPP3Sqw3eWmO2WBg9dhyOpGR0TWPXrh1s3/Y9k8+fhqworF21kl07t0eV37Vbd/IHDsZssRAKBtm390fWrl4Z6eCvW+cRRaPpUHO7jcvlYv3a1Rw6eKBenTt26szwEaNQDAbKy0r57JOFUcsGFwzFYrWhhUIcOVLMquX/wedru1lNVFUlEAjgdkVPU9RmYSUI/y0auw9QODWNhZX4+XhBEGKCCCtBEGKCCCtBEGKC6LMSBOFnRfRZCYIQ00RYCYIQE0RYCYIQE0RYCYIQE0RYCYIQE0RYCYIQE0RYCYIQE0RYCYIQE0RYCYIQE0RYCYIQE0RYCYIQE0RYCYIQE0RYCYIQE0RYCYIQE0RYCYIQE0RYCYIQE0RYCYIQE0RYCYIQE0RYCYIQE0RYCYIQE0RYCYIQE0RYCYIQE0RYCYIQE0RYCYLwsyJLMqFgsP7zsix+4FQQhJ8Ho9GIJEv4/b56ywyqasZgMAAgfplZEIT2oms6Pr+PivIydF2vt1yyxdn1FpQrCILQpkSflSAIMeH/A16bT2cn3SQOAAAAOGVYSWZNTQAqAAAACAABh2kABAAAAAEAAAAaAAAAAAACoAIABAAAAAEAAAEroAMABAAAAAEAAAB2AAAAAGLF2FkAAAAldEVYdGRhdGU6Y3JlYXRlADIwMjMtMDktMjlUMTA6MDM6NDgrMDA6MDAjfdKeAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDIzLTA5LTI5VDEwOjAzOjQ4KzAwOjAwUiBqIgAAACh0RVh0ZGF0ZTp0aW1lc3RhbXAAMjAyMy0wOS0yOVQxMDowMzo0OCswMDowMAU1S/0AAAASdEVYdGV4aWY6RXhpZk9mZnNldAAyNlMbomUAAAAYdEVYdGV4aWY6UGl4ZWxYRGltZW5zaW9uADI5Oexq/dkAAAAYdEVYdGV4aWY6UGl4ZWxZRGltZW5zaW9uADExOMz9GGgAAAAASUVORK5CYII=" alt=""/></p><p>总的业务累积量是2900多万，这和我们的预期并不相符。</p><p>下面我们分析一下到底是怎么回事。</p><h2 id="全局监控分析"><a aria-hidden="true" tabindex="-1" href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/04#全局监控分析"><span class="icon icon-link"></span></a>全局监控分析</h2><p>按照我们一贯的性能分析逻辑，我们先来查看全局监控数据：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage39a3390d06dfa6c2d4aae450f64a1cbb25a3.2d33aed4.png" alt=""/></p><p>你看，在运行期间，好几个worker的CPU资源都在70%以上，这样的数据中规中矩，还不是我们关注的重点。因为对于稳定性场景来说，资源只要能撑得住就行了。</p><p>但是，在场景运行数据中，TPS直接就断掉了。在我查看每个主机的资源情况时，在worker-1上看到了这样的数据：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimagecaedca3b821ee2cb9ff37dabdc67223339ed.fbb7dde6.png" alt=""/><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimageb5b4b51b0545310a1fe58222b3fd2256d7b4.6934ed75.png" alt=""/></p><p>这是数据断掉了呀！那我们就要定向分析这个主机了。</p><h2 id="定向监控分析"><a aria-hidden="true" tabindex="-1" href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/04#定向监控分析"><span class="icon icon-link"></span></a>定向监控分析</h2><h3 id="定向分析第一阶段"><a aria-hidden="true" tabindex="-1" href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/04#定向分析第一阶段"><span class="icon icon-link"></span></a>定向分析第一阶段</h3><p>根据断掉的时间点，和我们前面使用的监控手段，一层层查（这个步骤就是把我们的项目级全局监控计数器看一遍，在<a target="_blank" rel="noopener noreferrer" href="https://time.geekbang.org/column/article/356789">第<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><a target="_blank" rel="noopener noreferrer" href="https://time.geekbang.org/column/article/356789">4<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><a target="_blank" rel="noopener noreferrer" href="https://time.geekbang.org/column/article/356789">讲<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中已经有了明确的说明，我这里不再赘述了），结果看到了这样的日志信息：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">Feb 20 04:20:41 hp-server kernel: Out of memory: Kill process 7569 (qemu-kvm) score 256 or sacrifice child</span></div><div class="token-line"><span class="token plain">    Feb 20 04:20:41 hp-server kernel: Killed process 7569 (qemu-kvm), UID 107, total-vm:18283204kB, anon-rss:16804564kB, file-rss:232kB, shmem-rss:16kB</span></div><div class="token-line"><span class="token plain">    Feb 20 04:20:44 hp-server kernel: br0: port 4(vnet2) entered disabled state</span></div><div class="token-line"><span class="token plain">    Feb 20 04:20:44 hp-server kernel: device vnet2 left promiscuous mode</span></div><div class="token-line"><span class="token plain">    Feb 20 04:20:44 hp-server kernel: br0: port 4(vnet2) entered disabled state</span></div><div class="token-line"><span class="token plain">    Feb 20 04:20:44 hp-server libvirtd: 2021-02-19 20:20:44.706+0000: 1397: error : qemuMonitorIO:718 : 内部错误：End of file from qemu monitor</span></div><div class="token-line"><span class="token plain">    Feb 20 04:20:44 hp-server libvirtd: 2021-02-19 20:20:44.740+0000: 1397: error : qemuAgentIO:598 : 内部错误：End of file from agent monitor</span></div><div class="token-line"><span class="token plain">    Feb 20 04:20:45 hp-server systemd-machined: Machine qemu-3-vm-k8s-worker-1 terminated.</span></div></pre></div><p>显然，因为宿主机内存不够，worker-1被直接杀掉了。既然是内存不足，我们肯定要确定一下这个宿主机是为什么内存不足了。</p><p>我检查了宿主机的overcommit参数。这个参数是确定操作系统是否允许超分内存的。对于Linux来说，内存分配出去，不一定会被用完。所以，对宿主机来说超分可以支持更多的虚拟机。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">[root@hp-server log]# cat /proc/sys/vm/overcommit_memory</span></div><div class="token-line"><span class="token plain">    1</span></div></pre></div><p>我们看到，overcommit的配置是1，那就是允许超分。</p><p>我在这里简单说明一下，这个参数的几个选项：</p><ul><li>0，不允许超分。</li><li>1，不管当前的内存状态，都允许分配所有的物理内存。</li><li>2，允许分配的内存超过物理内存+交换空间。</li></ul><p>请你注意，允许超分，并不是说允许超用！而我们现在的情况是宿主已经OOM（内存溢出）了，这就说明内存真的已经不够用了。</p><p>这个逻辑其实挺有意思；Linux虽然允许超分内存，但是当内存真正不够用的时候，即便是收到了超分请求，也得为了保证自己的正常运行而做OOM的判断。也就是说分给你，你不见得能用得起来！这种耍流氓的手段，像不像领导画大饼？</p><p>没办法，我们还是要理智地来分析，看看怎么解决。</p><p>因为虚拟机是worker-1被杀掉的，我们来看一下worker-1的内存：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage5f275f6e7e3510d3833b2f1c9dd50c87af27.8c262999.png" alt=""/></p><p>从worker-1的资源上来看，如果worker-1是因为内存用得多被杀掉，那应该在12点20分到12点30分之间就被杀掉了，因为上面的内存曲线在12点半左右之后就没有大的波动了。</p><p>可是，为什么要等到凌晨4点20分呢？这说明worker-1被杀掉，并不是因为worker-1上的内存使用突然增加。而是宿主机上的内存使用变多，进而内存不足，然后在计算了OOM评分之后杀掉了worker-1。那我们就到宿主机上，看看还有哪些虚拟机在运行：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">[root@hp-server log]# virsh list --all</span></div><div class="token-line"><span class="token plain">     Id    名称                         状态</span></div><div class="token-line"><span class="token plain">    ----------------------------------------------------</span></div><div class="token-line"><span class="token plain">     1     vm-k8s-master-1                running</span></div><div class="token-line"><span class="token plain">     2     vm-k8s-master-3                running</span></div><div class="token-line"><span class="token plain">     4     vm-k8s-worker-2                running</span></div><div class="token-line"><span class="token plain">     5     vm-k8s-worker-3                running</span></div><div class="token-line"><span class="token plain">     6     vm-k8s-worker-4                running</span></div><div class="token-line"><span class="token plain">     7     vm-k8s-worker-1                running</span></div></pre></div><p>宿主机上总共运行了6个虚拟机，它们在12点半之后的时间里，对应的内存依次如下：</p><p>vm-k8s-worker-2：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimagef0yyf03dc5cd91ac0756c1ee27dfb008fcyy.fbbd46ef.png" alt=""/></p><p>vm-k8s-worker-3：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage5d575d108482d8db10d9daa2eebf90666657.32494dfb.png" alt=""/></p><p>vm-k8s-worker-4：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage7b6e7bcba1c104c2377225af8c91df60ee6e.24def68e.png" alt=""/></p><p>vm-k8s-master-1：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage300230d449c7243661d6a523ea2c92eab602.07f44881.png" alt=""/></p><p>vm-k8s-master-3：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimagec573c548ec1aca5aac3520d4cfc8842df173.827a2804.png" alt=""/></p><p>看到了没有？4点多的时候，在worker-2上有一个内存较大的请求。</p><p>针对这种情况，如果我们要细细地分析下去，接下来应该分析这个内存请求是从哪来的。但是，在稳定性场景中，要做这样的分析是比较麻烦的。因为这个场景的运行时间长，并且业务众多，不容易拆分时间。因此，我建议你到基准场景中去做分析。</p><p>现在，我们不能断言这个内存请求不合理，我们要做的是让这个系统稳定运行下去。所以，我们先来解决问题。</p><p>你可能会有疑问：既然是worker-2请求了内存，为啥要把worker-1杀掉呢？这就需要了解Linux的OOM killer机制了。</p><p>在OOM killer机制中，不是说谁用的内存大就会杀谁（当然，如果谁用的内存大，被杀的可能性也会比较大），而是会经过计算评分，哪个进程评分高就杀哪个。</p><p>在每个进程中，都会有三个参数：oom_adj、oom_score、oom_score_adj，系统的评分结果就记录在oom_score中。其他两个是调节参数：oom_adj是一个旧的调节参数，为了系统的兼容性，被保留了下来；oom_score_adj是一个新的调节参数，Linux会根据进程的运行参数来判断调节参数为多少。</p><p>这里提到的运行参数主要是这几个：</p><ul><li>运行时长（存活时间越长的进程，越不容易被杀掉）</li><li>CPU时间消耗（CPU消耗越大的进程，越容易被干掉）</li><li>内存消耗（内存消耗越大的进程，越容易被干掉）</li></ul><p>这些参数组合在一起，决定了哪个进程要被干掉。</p><p>而在我们这个场景中是worker-1被干掉了，这就说明worker-1的评分是高的。</p><p>因为前面有worker-1上的内存消耗也比较大，所以，我们在worker-1、worker-2这两台机器上查一下有多少Pod：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">[root@k8s-master-1 ~]# kubectl get pods -o wide --all-namespaces| grep worker-2</span></div><div class="token-line"><span class="token plain">    default                cloud-nacos-registry-76845b5cfb-bnj76        1/1     Running            0          9h     10.100.140.8     k8s-worker-2   &lt;none&gt;           &lt;none&gt;</span></div><div class="token-line"><span class="token plain">    default                sample-webapp-755fq                          0/1     ImagePullBackOff   0          19h    10.100.140.7     k8s-worker-2   &lt;none&gt;           &lt;none&gt;</span></div><div class="token-line"><span class="token plain">    default                skywalking-es-init-4w44r                     0/1     Completed          0          15h    10.100.140.11    k8s-worker-2   &lt;none&gt;           &lt;none&gt;</span></div><div class="token-line"><span class="token plain">    default                skywalking-ui-7d7754576b-nj7sf               1/1     Running            0          9h     10.100.140.14    k8s-worker-2   &lt;none&gt;           &lt;none&gt;</span></div><div class="token-line"><span class="token plain">    default                svc-mall-auth-6ccf9fd7c9-qh7j8               1/1     Running            0          151m   10.100.140.21    k8s-worker-2   &lt;none&gt;           &lt;none&gt;</span></div><div class="token-line"><span class="token plain">    default                svc-mall-auth-6ccf9fd7c9-sblzx               1/1     Running            0          151m   10.100.140.23    k8s-worker-2   &lt;none&gt;           &lt;none&gt;</span></div><div class="token-line"><span class="token plain">    default                svc-mall-member-df566595c-9zq9k              1/1     Running            0          151m   10.100.140.19    k8s-worker-2   &lt;none&gt;           &lt;none&gt;</span></div><div class="token-line"><span class="token plain">    default                svc-mall-member-df566595c-dmj67              1/1     Running            0          151m   10.100.140.22    k8s-worker-2   &lt;none&gt;           &lt;none&gt;</span></div><div class="token-line"><span class="token plain">    kube-system            calico-node-pwsqt                            1/1     Running            8          37d    172.16.106.149   k8s-worker-2   &lt;none&gt;           &lt;none&gt;</span></div><div class="token-line"><span class="token plain">    kube-system            kube-proxy-l8xf9                             1/1     Running            15         85d    172.16.106.149   k8s-worker-2   &lt;none&gt;           &lt;none&gt;</span></div><div class="token-line"><span class="token plain">    monitoring             node-exporter-wcsj7                          2/2     Running            18         42d    172.16.106.149   k8s-worker-2   &lt;none&gt;           &lt;none&gt;</span></div><div class="token-line"><span class="token plain">    nginx-ingress          nginx-ingress-7jjv2                          1/1     Running            0          18h    10.100.140.62    k8s-worker-2   &lt;none&gt;           &lt;none&gt;</span></div><div class="token-line"><span class="token plain">    [root@k8s-master-1 ~]# kubectl get pods -o wide --all-namespaces| grep worker-1</span></div><div class="token-line"><span class="token plain">    default                mysql-min-c4f8d4599-fxwf4                    1/1     Running            0          9h     10.100.230.9     k8s-worker-1   &lt;none&gt;           &lt;none&gt;</span></div><div class="token-line"><span class="token plain">    kube-system            calico-node-tmpfl                            1/1     Running            8          37d    172.16.106.130   k8s-worker-1   &lt;none&gt;           &lt;none&gt;</span></div><div class="token-line"><span class="token plain">    kube-system            kube-proxy-fr22f                             1/1     Running            13         85d    172.16.106.130   k8s-worker-1   &lt;none&gt;           &lt;none&gt;</span></div><div class="token-line"><span class="token plain">    monitoring             alertmanager-main-0                          2/2     Running            0          162m   10.100.230.12    k8s-worker-1   &lt;none&gt;           &lt;none&gt;</span></div><div class="token-line"><span class="token plain">    monitoring             node-exporter-222c5                          2/2     Running            10         7d     172.16.106.130   k8s-worker-1   &lt;none&gt;           &lt;none&gt;</span></div><div class="token-line"><span class="token plain">    nginx-ingress          nginx-ingress-pjrkw                          1/1     Running            1          18h    10.100.230.10    k8s-worker-1   &lt;none&gt;           &lt;none&gt;</span></div><div class="token-line"><span class="token plain">    [root@k8s-master-1 ~]#</span></div></pre></div><p>我们进一步查看那些应用经常使用的Pod，看看它们的内存情况如何：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                                                                                  </span></div><div class="token-line"><span class="token plain">     7609 27        20   0   12.4g   7.0g  12896 S 118.9 45.0 167:38.02 /opt/rh/rh-mysql57/root/usr/libexec/mysqld --defaults-file=/etc/my.cnf</span></div></pre></div><p>通过查看worker-1上的进程，我们发现主要是MySQL使用的内存最多，这是吃内存的大户。如果宿主机内存不够，把worker-1杀掉确实是有可能的。</p><p>下面，我们增加几个临时的监控，把一些重要服务的内存记录一下，比如Gateway、Member、MySQL、Redis等。然后再恢复所有的应用，把场景跑起来，看看是什么样的结果：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimagefe99fecdae9ec7e1375313ca3effeb5d7399.b0db4c04.png" alt=""/></p><p>运行时长已经快有七个小时了。你可能会奇怪，为什么上一个场景只运行了4个多小时，而现在却能运行7个小时了呢？这是因为worker-1被杀了之后，虚拟机重启了，状态都重置了。</p><p>而在上次的场景运行之前，我们并没有重启过虚拟机，也就是说前面已经有了一段时间的内存消耗。对于稳定性场景来说，增删改查都是有的，数据量也在不断增加，所以内存会使用得越来越多。</p><p>这一次运行的累积业务量是3200多万：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimagede97de6e783a5f88ee5da6188419f2efbf97.1a217476.png" alt=""/></p><p>但是，问题还是出现了：通过查看宿主机的日志，我看到worker-2又被杀掉了：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">Feb 20 19:42:44 hp-server kernel: Out of memory: Kill process 7603 (qemu-kvm) score 257 or sacrifice child</span></div><div class="token-line"><span class="token plain">    Feb 20 19:42:44 hp-server kernel: Killed process 7603 (qemu-kvm), UID 107, total-vm:17798976kB, anon-rss:16870472kB, file-rss:0kB, shmem-rss:16kB</span></div><div class="token-line"><span class="token plain">    Feb 20 19:42:46 hp-server kernel: br0: port 5(vnet3) entered disabled state</span></div><div class="token-line"><span class="token plain">    Feb 20 19:42:46 hp-server kernel: device vnet3 left promiscuous mode</span></div><div class="token-line"><span class="token plain">    Feb 20 19:42:46 hp-server kernel: br0: port 5(vnet3) entered disabled state</span></div><div class="token-line"><span class="token plain">    Feb 20 19:42:46 hp-server systemd-machined: Machine qemu-4-vm-k8s-worker-2 terminated.</span></div><div class="token-line"><span class="token plain">    Feb 20 19:42:46 hp-server avahi-daemon[953]: Withdrawing address record for fe80::fc54:ff:fe5e:dded on vnet3.</span></div><div class="token-line"><span class="token plain">    Feb 20 19:42:46 hp-server avahi-daemon[953]: Withdrawing workstation service for vnet3.</span></div><div class="token-line"><span class="token plain">    [root@hp-server log]#</span></div></pre></div><p>也就是说，在内存不够的情况下，杀掉哪个worker并不是固定的。至少这可以说明，宿主机真的是因为自己的内存不够用而杀掉虚拟机的。这可能就和具体的组件无关了，因为组件的内存消耗是根据运行需求来的，是合理的。</p><p>为什么做这样的判断呢？因为如果是某个固定的worker被杀掉，那我们可以去监控这个worker上运行的技术组件，看看是哪个组件的内存增加得快，然后进一步判断这个技术组件的内存不断增加的原因。</p><p>可是现在被杀掉的worker并不是固定的。根据OOM的逻辑，宿主机操作系统在内存不够用的时候才会调用OOM killer。我们前面也提到，overcommit的参数设置是1，也就是说宿主机操作系统允许内存在请求时超分。</p><p>但是，在宿主机真正使用内存的时候，内存不够用了，进而导致虚拟机被杀掉。这意味着，在宿主机创建KVM虚拟机时，产生了超分但并没有提供足够的可用内存，而在压力持续的过程中，虚拟机又确实需要这些内存。所以，虚拟机不断向宿主机申请内存，可宿主机没有足够的内存，因而触发了OOM killer机制。</p><p>这样看来，我们就得算一下内存到底超分了多少，看看是不是因为我们配置的超分过大，导致了这个问题。我们把虚拟机的内存列出来看看：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage2155218237ca581de41ayyyy0b5c2e1a6755.98466271.png" alt=""/></p><p>我们计算一下总分配内存：</p><p>$$ 总分配内存 = 8 \times 2 + 16 \times 4 = 80G $$</p><p>而宿主机的物理内存只有：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">[root@hp-server log]# cat /proc/meminfo|grep Total</span></div><div class="token-line"><span class="token plain">    MemTotal:       65675952 kB</span></div><div class="token-line"><span class="token plain">    SwapTotal:             0 kB</span></div><div class="token-line"><span class="token plain">    VmallocTotal:   34359738367 kB</span></div><div class="token-line"><span class="token plain">    CmaTotal:              0 kB</span></div><div class="token-line"><span class="token plain">    HugePages_Total:       0</span></div><div class="token-line"><span class="token plain">    [root@hp-server log]#</span></div></pre></div><p>也就是说宿主机的最大物理内存也只有65G左右。这也难怪，物理内存在真实使用时会不够用。</p><p>现在我们把虚拟机的内存降下来，让它不会产生超分，配置如下：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage35fc35c3b6275047993698dde957372cf6fc.27a759ab.png" alt=""/></p><p>总分配内存计算下来就是：</p><p>$$ 总分配内存 = 4 \times 2 + 13 \times 4 = 60G $$</p><p>这样就足够用了。</p><p>不过，根据性能分析中，时间和空间相互转换的原则，这样可能会导致TPS降低。因为在虚拟机的操作系统内存减少时，会更早地出现page faults，也就是页错误（换页时会产生）。不过，如果只是换页，而不是出现OOM，至少不会导致虚拟机被杀掉。</p><p>我们再把场景跑起来，看看结果：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage8d758d4ebfa73a4120d7d024d6299ef96075.82685521.png" alt=""/></p><p>这个结果看起来不错，虽说TPS有掉下来的时候，但是总体上是稳定的。运行时间也超过了12小时。</p><p>我们再来看累积业务量：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage925992a154c43e56e4b43ba75ff44b3e9d59.3e122aca.png" alt=""/></p><p>这次的累积业务量超过了7200万，超过了我们定的5000万的小目标。现在是不是可以欢呼一下了？</p><p>别高兴太早，在下节课中，你会感受到性能项目中的大起大落。</p><h2 id="总结"><a aria-hidden="true" tabindex="-1" href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/04#总结"><span class="icon icon-link"></span></a>总结</h2><p>今天我们讲了稳定性场景的两个要点，分别是运行时长和压力量级。要想把稳定性场景做得有意义，这两点是必备前提条件。</p><p>同时，你要记住一点，稳定性场景是为了找出业务积累的过程中出现的问题。所以，<strong>如果业务积累量不能达到线上的要求，就不能说明稳定性场景做得有意义。</strong></p><p>此外，在这节课中，我们也分析了物理内存增加的问题。在内存的使用上，特别是在这种Kubernetes+Docker的架构中，资源分配是非常关键的。不要觉得Kubernetes给我们做了很多自动的分配工作，我们就可以喝咖啡了。你会发现，仍然有不少新坑在等着我们。</p><h2 id="课后作业"><a aria-hidden="true" tabindex="-1" href="/blog-architect/高楼的性能工程实战课/05.容量稳定性异常场景/04#课后作业"><span class="icon icon-link"></span></a>课后作业</h2><p>这就是今天的全部内容，最后给你留两个思考题吧：</p><ol><li>在你的项目中，怎么将这节课的稳定性理念落地？</li><li>在查找稳定性的问题时，如何设计监控策略，才能保证我们可以收集到足够的分析数据？在你的项目中是如何做的？</li></ol><p>记得在留言区和我讨论、交流你的想法，每一次思考都会让你更进一步。</p><p>如果这节课让你有所收获，也欢迎你分享给你的朋友，共同学习进步。我们下一讲再见！</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/ssrc/高楼的性能工程实战课/05.容量稳定性异常场景/04.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">2023/9/29 14:47:35</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog-architect/umi.ded6fefd.js"></script>
  </body>
</html>
