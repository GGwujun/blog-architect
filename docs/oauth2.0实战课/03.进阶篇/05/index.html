<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog-architect/umi.3ec1f225.css" />
    <script>
      window.routerBase = "/blog-architect";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>
      11 | 实战案例：使用Spring Security搭建一套基于JWT的OAuth 2.0架构 - 大师兄
    </title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/oauth2.0实战课/03.进阶篇/05" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-architect/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>后端开发<ul><li><a href="/blog-architect/spark性能调优实战">spark性能调优实战</a></li></ul></span><span>架构师<ul><li><a href="/blog-architect/设计模式之美">设计模式之美</a></li><li><a href="/blog-architect/架构实战案例解析">架构实战案例解析</a></li><li><a href="/blog-architect/许式伟的架构课">许式伟的架构课</a></li><li><a href="/blog-architect/说透中台">说透中台</a></li><li><a aria-current="page" class="active" href="/blog-architect/oauth2.0实战课">oauth2.0实战课</a></li><li><a href="/blog-architect/从0开始学架构">从0开始学架构</a></li><li><a href="/blog-architect/即时消息技术剖析与实战">即时消息技术剖析与实战</a></li><li><a href="/blog-architect/如何设计一个秒杀系统">如何设计一个秒杀系统</a></li><li><a href="/blog-architect/如何落地业务建模">如何落地业务建模</a></li><li><a href="/blog-architect/性能优化高手课">性能优化高手课</a></li><li><a href="/blog-architect/性能工程高手课">性能工程高手课</a></li><li><a href="/blog-architect/手把手带你搭建秒杀系统">手把手带你搭建秒杀系统</a></li><li><a href="/blog-architect/技术与商业案例解读">技术与商业案例解读</a></li><li><a href="/blog-architect/推荐系统三十六式">推荐系统三十六式</a></li><li><a href="/blog-architect/检索技术核心20讲">检索技术核心20讲</a></li><li><a href="/blog-architect/软件设计之美">软件设计之美</a></li><li><a href="/blog-architect/高并发系统设计40问">高并发系统设计40问</a></li><li><a href="/blog-architect/高楼的性能工程实战课">高楼的性能工程实战课</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-architect/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>后端开发<ul><li><a href="/blog-architect/spark性能调优实战">spark性能调优实战</a></li></ul></li><li>架构师<ul><li><a href="/blog-architect/设计模式之美">设计模式之美</a></li><li><a href="/blog-architect/架构实战案例解析">架构实战案例解析</a></li><li><a href="/blog-architect/许式伟的架构课">许式伟的架构课</a></li><li><a href="/blog-architect/说透中台">说透中台</a></li><li><a aria-current="page" class="active" href="/blog-architect/oauth2.0实战课">oauth2.0实战课</a></li><li><a href="/blog-architect/从0开始学架构">从0开始学架构</a></li><li><a href="/blog-architect/即时消息技术剖析与实战">即时消息技术剖析与实战</a></li><li><a href="/blog-architect/如何设计一个秒杀系统">如何设计一个秒杀系统</a></li><li><a href="/blog-architect/如何落地业务建模">如何落地业务建模</a></li><li><a href="/blog-architect/性能优化高手课">性能优化高手课</a></li><li><a href="/blog-architect/性能工程高手课">性能工程高手课</a></li><li><a href="/blog-architect/手把手带你搭建秒杀系统">手把手带你搭建秒杀系统</a></li><li><a href="/blog-architect/技术与商业案例解读">技术与商业案例解读</a></li><li><a href="/blog-architect/推荐系统三十六式">推荐系统三十六式</a></li><li><a href="/blog-architect/检索技术核心20讲">检索技术核心20讲</a></li><li><a href="/blog-architect/软件设计之美">软件设计之美</a></li><li><a href="/blog-architect/高并发系统设计40问">高并发系统设计40问</a></li><li><a href="/blog-architect/高楼的性能工程实战课">高楼的性能工程实战课</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog-architect/oauth2.0实战课">oauth2.0实战课</a></li><li><a href="/blog-architect/oauth2.0实战课/01.开篇词">01.开篇词</a><ul><li><a href="/blog-architect/oauth2.0实战课/01.开篇词/01"><span>开篇词 | 为什么要学OAuth 2.0？</span></a></li></ul></li><li><a href="/blog-architect/oauth2.0实战课/02.基础篇">02.基础篇</a><ul><li><a href="/blog-architect/oauth2.0实战课/02.基础篇/01"><span>01 | OAuth 2.0是要通过什么方式解决什么问题？</span></a></li><li><a href="/blog-architect/oauth2.0实战课/02.基础篇/02"><span>02 | 授权码许可类型中，为什么一定要有授权码？</span></a></li><li><a href="/blog-architect/oauth2.0实战课/02.基础篇/03"><span>03 | 授权服务：授权码和访问令牌的颁发流程是怎样的？</span></a></li><li><a href="/blog-architect/oauth2.0实战课/02.基础篇/04"><span>04 | 在OAuth 2.0中，如何使用JWT结构化令牌？</span></a></li><li><a href="/blog-architect/oauth2.0实战课/02.基础篇/05"><span>05 | 如何安全、快速地接入OAuth 2.0？</span></a></li><li><a href="/blog-architect/oauth2.0实战课/02.基础篇/06"><span>06 | 除了授权码许可类型，OAuth 2.0还支持什么授权流程？</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog-architect/oauth2.0实战课/03.进阶篇">03.进阶篇</a><ul><li><a href="/blog-architect/oauth2.0实战课/03.进阶篇/01"><span>07 | 如何在移动App中使用OAuth 2.0？</span></a></li><li><a href="/blog-architect/oauth2.0实战课/03.进阶篇/02"><span>08 | 实践OAuth 2.0时，使用不当可能会导致哪些安全漏洞？</span></a></li><li><a href="/blog-architect/oauth2.0实战课/03.进阶篇/03"><span>09 | 实战：利用OAuth 2.0实现一个OpenID Connect用户身份认证协议</span></a></li><li><a href="/blog-architect/oauth2.0实战课/03.进阶篇/04"><span>10 | 串讲：OAuth 2.0的工作流程与安全问题</span></a></li><li><a aria-current="page" class="active" href="/blog-architect/oauth2.0实战课/03.进阶篇/05"><span>11 | 实战案例：使用Spring Security搭建一套基于JWT的OAuth 2.0架构</span></a></li><li><a href="/blog-architect/oauth2.0实战课/03.进阶篇/06"><span>12 | 架构案例：基于OAuth 2.0/JWT的微服务参考架构</span></a></li><li><a href="/blog-architect/oauth2.0实战课/03.进阶篇/07"><span>13 | 各大开放平台是如何使用OAuth 2.0的？</span></a></li><li><a href="/blog-architect/oauth2.0实战课/03.进阶篇/08"><span>14 | 查漏补缺：OAuth 2.0 常见问题答疑</span></a></li></ul></li><li><a href="/blog-architect/oauth2.0实战课/04.结束语">04.结束语</a><ul><li><a href="/blog-architect/oauth2.0实战课/04.结束语/01"><span>期末测试 | 一套习题，测试你的掌握程度</span></a></li><li><a href="/blog-architect/oauth2.0实战课/04.结束语/02"><span>结束语 | 把学习当成一种习惯</span></a></li></ul></li><li><a href="/blog-architect/oauth2.0实战课/summary">oauth2.0实战课</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="项目准备工作" data-depth="2"><a href="/blog-architect/oauth2.0实战课/03.进阶篇/05#项目准备工作"><span>项目准备工作</span></a></li><li title="搭建授权服务器" data-depth="2"><a href="/blog-architect/oauth2.0实战课/03.进阶篇/05#搭建授权服务器"><span>搭建授权服务器</span></a></li><li title="搭建受保护资源服务器" data-depth="2"><a href="/blog-architect/oauth2.0实战课/03.进阶篇/05#搭建受保护资源服务器"><span>搭建受保护资源服务器</span></a></li><li title="初始化数据配置" data-depth="2"><a href="/blog-architect/oauth2.0实战课/03.进阶篇/05#初始化数据配置"><span>初始化数据配置</span></a></li><li title="演示三种授权许可类型" data-depth="2"><a href="/blog-architect/oauth2.0实战课/03.进阶篇/05#演示三种授权许可类型"><span>演示三种授权许可类型</span></a></li><li title="资源拥有者凭据许可类型" data-depth="3"><a href="/blog-architect/oauth2.0实战课/03.进阶篇/05#资源拥有者凭据许可类型"><span>资源拥有者凭据许可类型</span></a></li><li title="客户端授权许可类型" data-depth="3"><a href="/blog-architect/oauth2.0实战课/03.进阶篇/05#客户端授权许可类型"><span>客户端授权许可类型</span></a></li><li title="授权码许可类型" data-depth="3"><a href="/blog-architect/oauth2.0实战课/03.进阶篇/05#授权码许可类型"><span>授权码许可类型</span></a></li><li title="演示权限控制" data-depth="2"><a href="/blog-architect/oauth2.0实战课/03.进阶篇/05#演示权限控制"><span>演示权限控制</span></a></li><li title="搭建客户端程序" data-depth="2"><a href="/blog-architect/oauth2.0实战课/03.进阶篇/05#搭建客户端程序"><span>搭建客户端程序</span></a></li><li title="演示单点登录" data-depth="2"><a href="/blog-architect/oauth2.0实战课/03.进阶篇/05#演示单点登录"><span>演示单点登录</span></a></li><li title="演示客户端请求资源服务器资源" data-depth="2"><a href="/blog-architect/oauth2.0实战课/03.进阶篇/05#演示客户端请求资源服务器资源"><span>演示客户端请求资源服务器资源</span></a></li><li title="总结" data-depth="2"><a href="/blog-architect/oauth2.0实战课/03.进阶篇/05#总结"><span>总结</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="11--实战案例使用spring-security搭建一套基于jwt的oauth-20架构"><a aria-hidden="true" tabindex="-1" href="/blog-architect/oauth2.0实战课/03.进阶篇/05#11--实战案例使用spring-security搭建一套基于jwt的oauth-20架构"><span class="icon icon-link"></span></a>11 | 实战案例：使用Spring Security搭建一套基于JWT的OAuth 2.0架构</h1><p>你好，我朱晔，是<a target="_blank" rel="noopener noreferrer" href="https://time.geekbang.org/column/intro/294">《Java业务开发常见错误100例》<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>专栏课程的作者。</p><p>《OAuth 2.0实战课》上线之后，我也第一时间关注了这门课。在开篇词中，我看到有一些同学留言问道：“如何使用Spring Security来实现OAuth 2.0？”这时，我想到之前自己写过一篇相关的文章，于是就直接在开篇词下留了言。后面我很快收到了不少用户的点赞和肯定，紧接着极客时间编辑也邀请我从自己的角度为专栏写篇加餐。好吧，功不唐捐，于是我就将之前我写的那篇老文章再次迭代、整理为今天的这一讲内容，希望可以帮助你掌握OAuth 2.0。</p><p>如果你熟悉Spring Security的话，肯定知道它因为功能多、组件抽象程度高、配置方式多样，导致了强大且复杂的特性。也因此，Spring Security的学习成本几乎是Spring家族中最高的。但不仅于此，在结合实际的复杂业务场景使用Spring Security时，我们还要去理解一些组件的工作原理和流程，不然需要自定义和扩展框架的时候就会手足无措。这就让使用Spring Security的门槛更高了。</p><p>因此，在决定使用Spring Security搭建整套安全体系（授权、认证、权限、审计）之前，我们还需要考虑的是：将来我们的业务会多复杂，徒手写一套安全体系来得划算，还是使用Spring Security更好？我相信，这也是王老师给出课程配套代码中，并没有使用Spring Security来演示OAuth 2.0流程的原因之一。</p><p>反过来说，如果你的应用已经使用了Spring Security来做鉴权、认证和权限管理的话，那么仍然使用Spring Security来实现OAuth的成本是很低的。而且，在学习了OAuth 2.0的流程打下扎实的基础之后，我们再使用Spring Security来配置OAuth 2.0就不会那么迷茫了。这也是我在工作中使用Spring Security来实现OAuth 2.0的直观感受。</p><p>所以，我就结合自己的实践和积累，带你使用Spring Security来一步一步地搭建一套基于JWT的OAuth 2.0授权体系。这些内容会涉及OAuth 2.0的三角色（客户端、授权服务、受保护资源），以及资源拥有者凭据许可、客户端凭据许可和授权码许可这三种常用的授权许可类型（隐式许可类型，不太安全也不太常用）。同时，我还会演示OAuth 2.0的权限控制，以及使用OAuth 2.0实现SSO单点登录体系。</p><p>这样一来，今天这一讲涉及到的流程就会比较多，内容也会很长。不过不用担心，我会手把手带你从零开始，完成整个程序的搭建，并给出所有流程的演示。</p><h2 id="项目准备工作"><a aria-hidden="true" tabindex="-1" href="/blog-architect/oauth2.0实战课/03.进阶篇/05#项目准备工作"><span class="icon icon-link"></span></a>项目准备工作</h2><p>实战之前，我们先来搭建项目父依赖和初始化数据库结构，为后面具体的编码做准备。</p><p>首先，我们来创建一个父POM，内含三个模块：</p><ul><li>springsecurity101-cloud-oauth2-client，用来扮演客户端角色；</li><li>springsecurity101-cloud-oauth2-server，用来扮演授权服务器角色；</li><li>springsecurity101-cloud-oauth2-userservice，是用户服务，用来扮演资源提供者角色。</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">&lt;project xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></div><div class="token-line"><span class="token plain">             xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span></div><div class="token-line"><span class="token plain">             xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span></div><div class="token-line"><span class="token plain">        &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        &lt;groupId&gt;me.josephzhu&lt;/groupId&gt;</span></div><div class="token-line"><span class="token plain">        &lt;artifactId&gt;springsecurity101&lt;/artifactId&gt;</span></div><div class="token-line"><span class="token plain">        &lt;packaging&gt;pom&lt;/packaging&gt;</span></div><div class="token-line"><span class="token plain">        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        &lt;parent&gt;</span></div><div class="token-line"><span class="token plain">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></div><div class="token-line"><span class="token plain">            &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span></div><div class="token-line"><span class="token plain">            &lt;version&gt;2.2.1.RELEASE&lt;/version&gt;</span></div><div class="token-line"><span class="token plain">            &lt;relativePath/&gt;</span></div><div class="token-line"><span class="token plain">        &lt;/parent&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        &lt;modules&gt;</span></div><div class="token-line"><span class="token plain">            &lt;module&gt;springsecurity101-cloud-oauth2-client&lt;/module&gt;</span></div><div class="token-line"><span class="token plain">            &lt;module&gt;springsecurity101-cloud-oauth2-server&lt;/module&gt;</span></div><div class="token-line"><span class="token plain">            &lt;module&gt;springsecurity101-cloud-oauth2-userservice&lt;/module&gt;</span></div><div class="token-line"><span class="token plain">        &lt;/modules&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        &lt;properties&gt;</span></div><div class="token-line"><span class="token plain">            &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span></div><div class="token-line"><span class="token plain">            &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;</span></div><div class="token-line"><span class="token plain">            &lt;java.version&gt;1.8&lt;/java.version&gt;</span></div><div class="token-line"><span class="token plain">        &lt;/properties&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        &lt;dependencies&gt;</span></div><div class="token-line"><span class="token plain">            &lt;dependency&gt;</span></div><div class="token-line"><span class="token plain">                &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span></div><div class="token-line"><span class="token plain">                &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span></div><div class="token-line"><span class="token plain">                &lt;optional&gt;true&lt;/optional&gt;</span></div><div class="token-line"><span class="token plain">            &lt;/dependency&gt;</span></div><div class="token-line"><span class="token plain">        &lt;/dependencies&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        &lt;dependencyManagement&gt;</span></div><div class="token-line"><span class="token plain">            &lt;dependencies&gt;</span></div><div class="token-line"><span class="token plain">                &lt;dependency&gt;</span></div><div class="token-line"><span class="token plain">                    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></div><div class="token-line"><span class="token plain">                    &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</span></div><div class="token-line"><span class="token plain">                    &lt;version&gt;Greenwich.SR4&lt;/version&gt;</span></div><div class="token-line"><span class="token plain">                    &lt;type&gt;pom&lt;/type&gt;</span></div><div class="token-line"><span class="token plain">                    &lt;scope&gt;import&lt;/scope&gt;</span></div><div class="token-line"><span class="token plain">                &lt;/dependency&gt;</span></div><div class="token-line"><span class="token plain">            &lt;/dependencies&gt;</span></div><div class="token-line"><span class="token plain">        &lt;/dependencyManagement&gt;</span></div><div class="token-line"><span class="token plain">        &lt;build&gt;</span></div><div class="token-line"><span class="token plain">            &lt;plugins&gt;</span></div><div class="token-line"><span class="token plain">                &lt;plugin&gt;</span></div><div class="token-line"><span class="token plain">                    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></div><div class="token-line"><span class="token plain">                    &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span></div><div class="token-line"><span class="token plain">                &lt;/plugin&gt;</span></div><div class="token-line"><span class="token plain">            &lt;/plugins&gt;</span></div><div class="token-line"><span class="token plain">        &lt;/build&gt;</span></div><div class="token-line"><span class="token plain">    &lt;/project&gt;</span></div></pre></div><p>然后，我们来创建一个oauth数据库，初始化将来会用到的5个表。</p><ul><li>authorities表：记录账号的权限，需要我们在后面配置。</li><li>oauth_approvals表：记录授权批准的状态。</li><li>oauth_client_details表：记录OAuth的客户端，需要我们在后面做配置。</li><li>oauth_code表：记录授权码。</li><li>users表：记录账号，需要我们在后面做初始化。</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">SET NAMES utf8mb4;</span></div><div class="token-line"><span class="token plain">    SET FOREIGN_KEY_CHECKS = 0;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    -- ----------------------------</span></div><div class="token-line"><span class="token plain">    -- Table structure for authorities</span></div><div class="token-line"><span class="token plain">    -- ----------------------------</span></div><div class="token-line"><span class="token plain">    DROP TABLE IF EXISTS `authorities`;</span></div><div class="token-line"><span class="token plain">    CREATE TABLE `authorities` (</span></div><div class="token-line"><span class="token plain">      `username` varchar(50) NOT NULL,</span></div><div class="token-line"><span class="token plain">      `authority` varchar(50) NOT NULL,</span></div><div class="token-line"><span class="token plain">      UNIQUE KEY `ix_auth_username` (`username`,`authority`),</span></div><div class="token-line"><span class="token plain">      CONSTRAINT `fk_authorities_users` FOREIGN KEY (`username`) REFERENCES `users` (`username`)</span></div><div class="token-line"><span class="token plain">    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    -- ----------------------------</span></div><div class="token-line"><span class="token plain">    -- Table structure for oauth_approvals</span></div><div class="token-line"><span class="token plain">    -- ----------------------------</span></div><div class="token-line"><span class="token plain">    DROP TABLE IF EXISTS `oauth_approvals`;</span></div><div class="token-line"><span class="token plain">    CREATE TABLE `oauth_approvals` (</span></div><div class="token-line"><span class="token plain">      `userId` varchar(256) DEFAULT NULL,</span></div><div class="token-line"><span class="token plain">      `clientId` varchar(256) DEFAULT NULL,</span></div><div class="token-line"><span class="token plain">      `partnerKey` varchar(32) DEFAULT NULL,</span></div><div class="token-line"><span class="token plain">      `scope` varchar(256) DEFAULT NULL,</span></div><div class="token-line"><span class="token plain">      `status` varchar(10) DEFAULT NULL,</span></div><div class="token-line"><span class="token plain">      `expiresAt` datetime DEFAULT NULL,</span></div><div class="token-line"><span class="token plain">      `lastModifiedAt` datetime DEFAULT NULL</span></div><div class="token-line"><span class="token plain">    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    -- ----------------------------</span></div><div class="token-line"><span class="token plain">    -- Table structure for oauth_client_details</span></div><div class="token-line"><span class="token plain">    -- ----------------------------</span></div><div class="token-line"><span class="token plain">    DROP TABLE IF EXISTS `oauth_client_details`;</span></div><div class="token-line"><span class="token plain">    CREATE TABLE `oauth_client_details` (</span></div><div class="token-line"><span class="token plain">      `client_id` varchar(255) NOT NULL,</span></div><div class="token-line"><span class="token plain">      `resource_ids` varchar(255) DEFAULT NULL,</span></div><div class="token-line"><span class="token plain">      `client_secret` varchar(255) DEFAULT NULL,</span></div><div class="token-line"><span class="token plain">      `scope` varchar(255) DEFAULT NULL,</span></div><div class="token-line"><span class="token plain">      `authorized_grant_types` varchar(255) DEFAULT NULL,</span></div><div class="token-line"><span class="token plain">      `web_server_redirect_uri` varchar(255) DEFAULT NULL,</span></div><div class="token-line"><span class="token plain">      `authorities` varchar(255) DEFAULT NULL,</span></div><div class="token-line"><span class="token plain">      `access_token_validity` int(11) DEFAULT NULL,</span></div><div class="token-line"><span class="token plain">      `refresh_token_validity` int(11) DEFAULT NULL,</span></div><div class="token-line"><span class="token plain">      `additional_information` varchar(4096) DEFAULT NULL,</span></div><div class="token-line"><span class="token plain">      `autoapprove` varchar(255) DEFAULT NULL,</span></div><div class="token-line"><span class="token plain">      PRIMARY KEY (`client_id`)</span></div><div class="token-line"><span class="token plain">    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    -- ----------------------------</span></div><div class="token-line"><span class="token plain">    -- Table structure for oauth_code</span></div><div class="token-line"><span class="token plain">    -- ----------------------------</span></div><div class="token-line"><span class="token plain">    DROP TABLE IF EXISTS `oauth_code`;</span></div><div class="token-line"><span class="token plain">    CREATE TABLE `oauth_code` (</span></div><div class="token-line"><span class="token plain">      `code` varchar(255) DEFAULT NULL,</span></div><div class="token-line"><span class="token plain">      `authentication` blob</span></div><div class="token-line"><span class="token plain">    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    -- ----------------------------</span></div><div class="token-line"><span class="token plain">    -- Table structure for users</span></div><div class="token-line"><span class="token plain">    -- ----------------------------</span></div><div class="token-line"><span class="token plain">    DROP TABLE IF EXISTS `users`;</span></div><div class="token-line"><span class="token plain">    CREATE TABLE `users` (</span></div><div class="token-line"><span class="token plain">      `username` varchar(50) NOT NULL,</span></div><div class="token-line"><span class="token plain">      `password` varchar(100) NOT NULL,</span></div><div class="token-line"><span class="token plain">      `enabled` tinyint(1) NOT NULL,</span></div><div class="token-line"><span class="token plain">      PRIMARY KEY (`username`)</span></div><div class="token-line"><span class="token plain">    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    SET FOREIGN_KEY_CHECKS = 1;</span></div></pre></div><p>这5个表是Spring Security OAuth需要用到的存储表，我们不要去修改既有的表结构。这里可以看到，我们并没有在数据库中创建相应的表，来存放访问令牌和刷新令牌。这是因为，我们之后的实现会使用JWT来传输令牌信息，以便进行本地校验，所以并不一定要将其存放到数据库中。基本上所有的这些表都是可以自己扩展的，只需要继承实现Spring的一些既有类即可，这里不做展开。</p><p>接下来，我们开始搭建授权服务器和受保护资源服务器。</p><h2 id="搭建授权服务器"><a aria-hidden="true" tabindex="-1" href="/blog-architect/oauth2.0实战课/03.进阶篇/05#搭建授权服务器"><span class="icon icon-link"></span></a>搭建授权服务器</h2><p>我们先创建第一个模块，也就是授权服务器。首先创建POM，配置依赖：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></div><div class="token-line"><span class="token plain">    &lt;project xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></div><div class="token-line"><span class="token plain">             xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span></div><div class="token-line"><span class="token plain">             xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span></div><div class="token-line"><span class="token plain">        &lt;parent&gt;</span></div><div class="token-line"><span class="token plain">            &lt;artifactId&gt;springsecurity101&lt;/artifactId&gt;</span></div><div class="token-line"><span class="token plain">            &lt;groupId&gt;me.josephzhu&lt;/groupId&gt;</span></div><div class="token-line"><span class="token plain">            &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span></div><div class="token-line"><span class="token plain">        &lt;/parent&gt;</span></div><div class="token-line"><span class="token plain">        &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        &lt;artifactId&gt;springsecurity101-cloud-oauth2-server&lt;/artifactId&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        &lt;dependencies&gt;</span></div><div class="token-line"><span class="token plain">            &lt;dependency&gt;</span></div><div class="token-line"><span class="token plain">                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></div><div class="token-line"><span class="token plain">                &lt;artifactId&gt;spring-cloud-starter-oauth2&lt;/artifactId&gt;</span></div><div class="token-line"><span class="token plain">            &lt;/dependency&gt;</span></div><div class="token-line"><span class="token plain">            &lt;dependency&gt;</span></div><div class="token-line"><span class="token plain">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></div><div class="token-line"><span class="token plain">                &lt;artifactId&gt;spring-boot-starter-jdbc&lt;/artifactId&gt;</span></div><div class="token-line"><span class="token plain">            &lt;/dependency&gt;</span></div><div class="token-line"><span class="token plain">            &lt;dependency&gt;</span></div><div class="token-line"><span class="token plain">                &lt;groupId&gt;mysql&lt;/groupId&gt;</span></div><div class="token-line"><span class="token plain">                &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span></div><div class="token-line"><span class="token plain">            &lt;/dependency&gt;</span></div><div class="token-line"><span class="token plain">            &lt;dependency&gt;</span></div><div class="token-line"><span class="token plain">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></div><div class="token-line"><span class="token plain">                &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span></div><div class="token-line"><span class="token plain">            &lt;/dependency&gt;</span></div><div class="token-line"><span class="token plain">            &lt;dependency&gt;</span></div><div class="token-line"><span class="token plain">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></div><div class="token-line"><span class="token plain">                &lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;</span></div><div class="token-line"><span class="token plain">            &lt;/dependency&gt;</span></div><div class="token-line"><span class="token plain">        &lt;/dependencies&gt;</span></div><div class="token-line"><span class="token plain">    &lt;/project&gt;</span></div></pre></div><p>这里，我们使用了Spring Cloud的spring-cloud-starter-oauth2组件，而不是直接使用的Spring Security，因为前者做了一些自动化配置的工作，使用起来会更方便。</p><p>此外，我们还在POM中加入了数据访问、Web等依赖，因为我们的受保护资源服务器需要使用数据库来保存客户端的信息、用户信息等数据，同时也会引入thymeleaf模板引擎依赖，来稍稍美化一下登录页面。</p><p>然后创建一个配置文件application.yml实现程序配置：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">server:</span></div><div class="token-line"><span class="token plain">      port: 8080</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    spring:</span></div><div class="token-line"><span class="token plain">      application:</span></div><div class="token-line"><span class="token plain">        name: oauth2-server</span></div><div class="token-line"><span class="token plain">      datasource:</span></div><div class="token-line"><span class="token plain">        url: jdbc:mysql://localhost:6657/oauth?useSSL=false</span></div><div class="token-line"><span class="token plain">        username: root</span></div><div class="token-line"><span class="token plain">        password: kIo9u7Oi0eg</span></div><div class="token-line"><span class="token plain">        driver-class-name: com.mysql.jdbc.Driver</span></div></pre></div><p>可以看到，我们配置了oauth数据库的连接字符串，定义了授权服务器的监听端口是8080。</p><p>最后，使用keytool工具生成密钥对，把密钥文件jks保存到资源目录下，并要导出一个公钥留作以后使用。</p><p>以上完成了项目框架搭建工作，接下来，我们正式开始编码。</p><p>第一步，创建一个最核心的类用于配置授权服务器。我把每段代码的作用放在了注释里，你可以直接看下。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">@Configuration</span></div><div class="token-line"><span class="token plain">    @EnableAuthorizationServer //开启授权服务器</span></div><div class="token-line"><span class="token plain">    public class OAuth2ServerConfiguration extends AuthorizationServerConfigurerAdapter {</span></div><div class="token-line"><span class="token plain">        @Autowired</span></div><div class="token-line"><span class="token plain">        private DataSource dataSource;</span></div><div class="token-line"><span class="token plain">        @Autowired</span></div><div class="token-line"><span class="token plain">        private AuthenticationManager authenticationManager;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        /**</span></div><div class="token-line"><span class="token plain">         * 我们配置了使用数据库来维护客户端信息。虽然在各种Demo中我们经常看到的是在内存中维护客户端信息，通过配置直接写死在这里。</span></div><div class="token-line"><span class="token plain">         * 但是，对于实际的应用我们一般都会用数据库来维护这个信息，甚至还会建立一套工作流来允许客户端自己申请ClientID，实现OAuth客户端接入的审批。</span></div><div class="token-line"><span class="token plain">         * @param clients</span></div><div class="token-line"><span class="token plain">         * @throws Exception</span></div><div class="token-line"><span class="token plain">         */</span></div><div class="token-line"><span class="token plain">        @Override</span></div><div class="token-line"><span class="token plain">        public void configure(ClientDetailsServiceConfigurer clients) throws Exception {</span></div><div class="token-line"><span class="token plain">            clients.jdbc(dataSource);</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        /**</span></div><div class="token-line"><span class="token plain">         * 这里干了两件事儿。首先，打开了验证Token的访问权限（以便之后我们演示）。</span></div><div class="token-line"><span class="token plain">         * 然后，允许ClientSecret明文方式保存，并且可以通过表单提交（而不仅仅是Basic Auth方式提交），之后会演示到这个。</span></div><div class="token-line"><span class="token plain">         * @param security</span></div><div class="token-line"><span class="token plain">         * @throws Exception</span></div><div class="token-line"><span class="token plain">         */</span></div><div class="token-line"><span class="token plain">        @Override</span></div><div class="token-line"><span class="token plain">        public void configure(AuthorizationServerSecurityConfigurer security) throws Exception {</span></div><div class="token-line"><span class="token plain">            security.checkTokenAccess(&quot;permitAll()&quot;)</span></div><div class="token-line"><span class="token plain">                    .allowFormAuthenticationForClients().passwordEncoder(NoOpPasswordEncoder.getInstance());</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        /**</span></div><div class="token-line"><span class="token plain">         * 干了以下4件事儿：</span></div><div class="token-line"><span class="token plain">         * 1. 配置我们的令牌存放方式为JWT方式，而不是内存、数据库或Redis方式。</span></div><div class="token-line"><span class="token plain">         * JWT是Json Web Token的缩写，也就是使用JSON数据格式包装的令牌，由.号把整个JWT分隔为头、数据体、签名三部分。</span></div><div class="token-line"><span class="token plain">         * JWT保存Token虽然易于使用但是不是那么安全，一般用于内部，且需要走HTTPS并配置比较短的失效时间。</span></div><div class="token-line"><span class="token plain">         * 2. 配置JWT Token的非对称加密来进行签名</span></div><div class="token-line"><span class="token plain">         * 3. 配置一个自定义的Token增强器，把更多信息放入Token中</span></div><div class="token-line"><span class="token plain">         * 4. 配置使用JDBC数据库方式来保存用户的授权批准记录</span></div><div class="token-line"><span class="token plain">         * @param endpoints</span></div><div class="token-line"><span class="token plain">         * @throws Exception</span></div><div class="token-line"><span class="token plain">         */</span></div><div class="token-line"><span class="token plain">        @Override</span></div><div class="token-line"><span class="token plain">        public void configure(AuthorizationServerEndpointsConfigurer endpoints) {</span></div><div class="token-line"><span class="token plain">            TokenEnhancerChain tokenEnhancerChain = new TokenEnhancerChain();</span></div><div class="token-line"><span class="token plain">            tokenEnhancerChain.setTokenEnhancers(</span></div><div class="token-line"><span class="token plain">                    Arrays.asList(tokenEnhancer(), jwtTokenEnhancer()));</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            endpoints.approvalStore(approvalStore())</span></div><div class="token-line"><span class="token plain">                    .authorizationCodeServices(authorizationCodeServices())</span></div><div class="token-line"><span class="token plain">                    .tokenStore(tokenStore())</span></div><div class="token-line"><span class="token plain">                    .tokenEnhancer(tokenEnhancerChain)</span></div><div class="token-line"><span class="token plain">                    .authenticationManager(authenticationManager);</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        /**</span></div><div class="token-line"><span class="token plain">         * 使用JDBC数据库方式来保存授权码</span></div><div class="token-line"><span class="token plain">         * @return</span></div><div class="token-line"><span class="token plain">         */</span></div><div class="token-line"><span class="token plain">        @Bean</span></div><div class="token-line"><span class="token plain">        public AuthorizationCodeServices authorizationCodeServices() {</span></div><div class="token-line"><span class="token plain">            return new JdbcAuthorizationCodeServices(dataSource);</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        /**</span></div><div class="token-line"><span class="token plain">         * 使用JWT存储</span></div><div class="token-line"><span class="token plain">         * @return</span></div><div class="token-line"><span class="token plain">         */</span></div><div class="token-line"><span class="token plain">        @Bean</span></div><div class="token-line"><span class="token plain">        public TokenStore tokenStore() {</span></div><div class="token-line"><span class="token plain">            return new JwtTokenStore(jwtTokenEnhancer());</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        /**</span></div><div class="token-line"><span class="token plain">         * 使用JDBC数据库方式来保存用户的授权批准记录</span></div><div class="token-line"><span class="token plain">         * @return</span></div><div class="token-line"><span class="token plain">         */</span></div><div class="token-line"><span class="token plain">        @Bean</span></div><div class="token-line"><span class="token plain">        public JdbcApprovalStore approvalStore() {</span></div><div class="token-line"><span class="token plain">            return new JdbcApprovalStore(dataSource);</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        /**</span></div><div class="token-line"><span class="token plain">         * 自定义的Token增强器，把更多信息放入Token中</span></div><div class="token-line"><span class="token plain">         * @return</span></div><div class="token-line"><span class="token plain">         */</span></div><div class="token-line"><span class="token plain">        @Bean</span></div><div class="token-line"><span class="token plain">        public TokenEnhancer tokenEnhancer() {</span></div><div class="token-line"><span class="token plain">            return new CustomTokenEnhancer();</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        /**</span></div><div class="token-line"><span class="token plain">         * 配置JWT使用非对称加密方式来验证</span></div><div class="token-line"><span class="token plain">         * @return</span></div><div class="token-line"><span class="token plain">         */</span></div><div class="token-line"><span class="token plain">        @Bean</span></div><div class="token-line"><span class="token plain">        protected JwtAccessTokenConverter jwtTokenEnhancer() {</span></div><div class="token-line"><span class="token plain">            KeyStoreKeyFactory keyStoreKeyFactory = new KeyStoreKeyFactory(new ClassPathResource(&quot;jwt.jks&quot;), &quot;mySecretKey&quot;.toCharArray());</span></div><div class="token-line"><span class="token plain">            JwtAccessTokenConverter converter = new JwtAccessTokenConverter();</span></div><div class="token-line"><span class="token plain">            converter.setKeyPair(keyStoreKeyFactory.getKeyPair(&quot;jwt&quot;));</span></div><div class="token-line"><span class="token plain">            return converter;</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        /**</span></div><div class="token-line"><span class="token plain">         * 配置登录页面的视图信息（其实可以独立一个配置类，这样会更规范）</span></div><div class="token-line"><span class="token plain">         */</span></div><div class="token-line"><span class="token plain">        @Configuration</span></div><div class="token-line"><span class="token plain">        static class MvcConfig implements WebMvcConfigurer {</span></div><div class="token-line"><span class="token plain">            @Override</span></div><div class="token-line"><span class="token plain">            public void addViewControllers(ViewControllerRegistry registry) {</span></div><div class="token-line"><span class="token plain">                registry.addViewController(&quot;login&quot;).setViewName(&quot;login&quot;);</span></div><div class="token-line"><span class="token plain">            }</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>第二步，还记得吗，刚才在第一步的代码中我们还用到了一个自定义的Token增强器，把用户信息嵌入到JWT Token中去（如果使用的是客户端凭据许可类型，这段代码无效，因为和用户没关系）。</p><p>这是一个常见需求。因为，默认情况下Token中只会有用户名这样的基本信息，我们往往需要把关于用户的更多信息返回给客户端（在实际应用中，你可能会从数据库或外部服务查询更多的用户信息加入到JWT Token中去）。这个时候，我们就可以自定义增强器来丰富Token的内容：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">public class CustomTokenEnhancer implements TokenEnhancer {</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        @Override</span></div><div class="token-line"><span class="token plain">        public OAuth2AccessToken enhance(OAuth2AccessToken accessToken, OAuth2Authentication authentication) {</span></div><div class="token-line"><span class="token plain">            Authentication userAuthentication = authentication.getUserAuthentication();</span></div><div class="token-line"><span class="token plain">            if (userAuthentication != null) {</span></div><div class="token-line"><span class="token plain">                Object principal = authentication.getUserAuthentication().getPrincipal();</span></div><div class="token-line"><span class="token plain">                //把用户标识嵌入JWT Token中去(Key是userDetails)</span></div><div class="token-line"><span class="token plain">                Map&lt;String, Object&gt; additionalInfo = new HashMap&lt;&gt;();</span></div><div class="token-line"><span class="token plain">                additionalInfo.put(&quot;userDetails&quot;, principal);</span></div><div class="token-line"><span class="token plain">                ((DefaultOAuth2AccessToken) accessToken).setAdditionalInformation(additionalInfo);</span></div><div class="token-line"><span class="token plain">            }</span></div><div class="token-line"><span class="token plain">            return accessToken;</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>第三步，实现安全方面的配置。你可以直接看下代码注释，来了解关键代码的作用。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">@Configuration</span></div><div class="token-line"><span class="token plain">    public class WebSecurityConfig extends WebSecurityConfigurerAdapter {</span></div><div class="token-line"><span class="token plain">        @Autowired</span></div><div class="token-line"><span class="token plain">        private DataSource dataSource;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        @Override</span></div><div class="token-line"><span class="token plain">        @Bean</span></div><div class="token-line"><span class="token plain">        public AuthenticationManager authenticationManagerBean() throws Exception {</span></div><div class="token-line"><span class="token plain">            return super.authenticationManagerBean();</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        /**</span></div><div class="token-line"><span class="token plain">         * 配置用户账户的认证方式。显然，我们把用户存在了数据库中希望配置JDBC的方式。</span></div><div class="token-line"><span class="token plain">         * 此外，我们还配置了使用BCryptPasswordEncoder哈希来保存用户的密码（生产环境中，用户密码肯定不能是明文保存的）</span></div><div class="token-line"><span class="token plain">         * @param auth</span></div><div class="token-line"><span class="token plain">         * @throws Exception</span></div><div class="token-line"><span class="token plain">         */</span></div><div class="token-line"><span class="token plain">        @Override</span></div><div class="token-line"><span class="token plain">        protected void configure(AuthenticationManagerBuilder auth) throws Exception {</span></div><div class="token-line"><span class="token plain">            auth.jdbcAuthentication()</span></div><div class="token-line"><span class="token plain">                    .dataSource(dataSource)</span></div><div class="token-line"><span class="token plain">                    .passwordEncoder(new BCryptPasswordEncoder());</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        /**</span></div><div class="token-line"><span class="token plain">         * 开放/login和/oauth/authorize两个路径的匿名访问。前者用于登录，后者用于换授权码，这两个端点访问的时机都在登录之前。</span></div><div class="token-line"><span class="token plain">         * 设置/login使用表单验证进行登录。</span></div><div class="token-line"><span class="token plain">         * @param http</span></div><div class="token-line"><span class="token plain">         * @throws Exception</span></div><div class="token-line"><span class="token plain">         */</span></div><div class="token-line"><span class="token plain">        @Override</span></div><div class="token-line"><span class="token plain">        protected void configure(HttpSecurity http) throws Exception {</span></div><div class="token-line"><span class="token plain">            http.authorizeRequests()</span></div><div class="token-line"><span class="token plain">                    .antMatchers(&quot;/login&quot;, &quot;/oauth/authorize&quot;)</span></div><div class="token-line"><span class="token plain">                    .permitAll()</span></div><div class="token-line"><span class="token plain">                    .anyRequest().authenticated()</span></div><div class="token-line"><span class="token plain">                    .and()</span></div><div class="token-line"><span class="token plain">                    .formLogin().loginPage(&quot;/login&quot;);</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>第四步，在资源目录下创建一个templates文件夹，然后创建一个login.html登录页：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">&lt;body class=&quot;uk-height-1-1&quot;&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    &lt;div class=&quot;uk-vertical-align uk-text-center uk-height-1-1&quot;&gt;</span></div><div class="token-line"><span class="token plain">        &lt;div class=&quot;uk-vertical-align-middle&quot; style=&quot;width: 250px;&quot;&gt;</span></div><div class="token-line"><span class="token plain">            &lt;h1&gt;Login Form&lt;/h1&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            &lt;p class=&quot;uk-text-danger&quot; th:if=&quot;${param.error}&quot;&gt;</span></div><div class="token-line"><span class="token plain">                用户名或密码错误...</span></div><div class="token-line"><span class="token plain">            &lt;/p&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">            &lt;form class=&quot;uk-panel uk-panel-box uk-form&quot; method=&quot;post&quot; th:action=&quot;@{/login}&quot;&gt;</span></div><div class="token-line"><span class="token plain">                &lt;div class=&quot;uk-form-row&quot;&gt;</span></div><div class="token-line"><span class="token plain">                    &lt;input class=&quot;uk-width-1-1 uk-form-large&quot; type=&quot;text&quot; placeholder=&quot;Username&quot; name=&quot;username&quot;</span></div><div class="token-line"><span class="token plain">                           value=&quot;reader&quot;/&gt;</span></div><div class="token-line"><span class="token plain">                &lt;/div&gt;</span></div><div class="token-line"><span class="token plain">                &lt;div class=&quot;uk-form-row&quot;&gt;</span></div><div class="token-line"><span class="token plain">                    &lt;input class=&quot;uk-width-1-1 uk-form-large&quot; type=&quot;password&quot; placeholder=&quot;Password&quot; name=&quot;password&quot;</span></div><div class="token-line"><span class="token plain">                           value=&quot;reader&quot;/&gt;</span></div><div class="token-line"><span class="token plain">                &lt;/div&gt;</span></div><div class="token-line"><span class="token plain">                &lt;div class=&quot;uk-form-row&quot;&gt;</span></div><div class="token-line"><span class="token plain">                    &lt;button class=&quot;uk-width-1-1 uk-button uk-button-primary uk-button-large&quot;&gt;Login&lt;/button&gt;</span></div><div class="token-line"><span class="token plain">                &lt;/div&gt;</span></div><div class="token-line"><span class="token plain">            &lt;/form&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        &lt;/div&gt;</span></div><div class="token-line"><span class="token plain">    &lt;/div&gt;</span></div><div class="token-line"><span class="token plain">    &lt;/body&gt;</span></div></pre></div><p>至此，授权服务器的编码工作就完成了。</p><h2 id="搭建受保护资源服务器"><a aria-hidden="true" tabindex="-1" href="/blog-architect/oauth2.0实战课/03.进阶篇/05#搭建受保护资源服务器"><span class="icon icon-link"></span></a>搭建受保护资源服务器</h2><p>接下来，我们搭建一个用户服务模拟资源提供者（受保护资源服务器）。我们先看看项目初始化工作。</p><p>这次创建的POM没有什么特殊，依赖了spring-cloud-starter-oauth2：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></div><div class="token-line"><span class="token plain">    &lt;project xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></div><div class="token-line"><span class="token plain">             xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span></div><div class="token-line"><span class="token plain">             xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span></div><div class="token-line"><span class="token plain">        &lt;parent&gt;</span></div><div class="token-line"><span class="token plain">            &lt;artifactId&gt;springsecurity101&lt;/artifactId&gt;</span></div><div class="token-line"><span class="token plain">            &lt;groupId&gt;me.josephzhu&lt;/groupId&gt;</span></div><div class="token-line"><span class="token plain">            &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span></div><div class="token-line"><span class="token plain">        &lt;/parent&gt;</span></div><div class="token-line"><span class="token plain">        &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        &lt;artifactId&gt;springsecurity101-cloud-oauth2-userservice&lt;/artifactId&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        &lt;dependencies&gt;</span></div><div class="token-line"><span class="token plain">            &lt;dependency&gt;</span></div><div class="token-line"><span class="token plain">                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></div><div class="token-line"><span class="token plain">                &lt;artifactId&gt;spring-cloud-starter-oauth2&lt;/artifactId&gt;</span></div><div class="token-line"><span class="token plain">            &lt;/dependency&gt;</span></div><div class="token-line"><span class="token plain">            &lt;dependency&gt;</span></div><div class="token-line"><span class="token plain">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></div><div class="token-line"><span class="token plain">                &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span></div><div class="token-line"><span class="token plain">            &lt;/dependency&gt;</span></div><div class="token-line"><span class="token plain">        &lt;/dependencies&gt;</span></div><div class="token-line"><span class="token plain">    &lt;/project&gt;</span></div></pre></div><p>配置文件非常简单，只是声明了资源服务端口为8081：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">server:</span></div><div class="token-line"><span class="token plain">      port: 8081</span></div></pre></div><p>同时，还要记得把我们之前在项目准备工作时生成的密钥对的公钥命名为public.cert，并放到资源文件下。这样，资源服务器可以本地校验JWT的合法性。内容大概是这样的：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">-----BEGIN PUBLIC KEY-----</span></div><div class="token-line"><span class="token plain">    MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAwR84LFHwnK5GXErnwkmD</span></div><div class="token-line"><span class="token plain">    mPOJl4CSTtYXCqmCtlbF+5qVOosu0YsM2DsrC9O2gun6wVFKkWYiMoBSjsNMSI3Z</span></div><div class="token-line"><span class="token plain">    w5JYgh+ldHvA+MIex2QXfOZx920M1fPUiuUPgmnTFS+Z3lmK3/T6jJnmciUPY1pe</span></div><div class="token-line"><span class="token plain">    h4MXL6YzeI0q4W9xNBBeKT6FDGpduc0FC3OlXHfLbVOThKmAUpAWFDwf9/uUA//l</span></div><div class="token-line"><span class="token plain">    3PLchmV6VwTcUaaHp5W8Af/GU4lPGZbTAqOxzB9ukisPFuO1DikacPhrOQgdxtqk</span></div><div class="token-line"><span class="token plain">    LciRTa884uQnkFwSguOEUYf3ni8GNRJauIuW0rVXhMOs78pKvCKmo53M0tqeC6ul</span></div><div class="token-line"><span class="token plain">    +QIDAQAB</span></div><div class="token-line"><span class="token plain">    -----END PUBLIC KEY-----</span></div></pre></div><p>好了，让我们正式开始编码吧。</p><p>第一步，创建一个可以匿名访问的接口GET /hello，用来测试无需登录就可以访问的服务端资源：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">@RestController</span></div><div class="token-line"><span class="token plain">    public class HelloController {</span></div><div class="token-line"><span class="token plain">        @GetMapping(&quot;hello&quot;)</span></div><div class="token-line"><span class="token plain">        public String hello() {</span></div><div class="token-line"><span class="token plain">            return &quot;Hello&quot;;</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>第二步，创建三个需要登录+授权才能访问到的接口。我们通过@PreAuthorize在方法执行前进行权限控制：</p><ul><li>GET /user/name接口，读权限或写权限可访问，返回登录用户名；</li><li>GET /user接口，读权限或写权限可访问，返回登录用户信息；</li><li>POST /user接口，只有写权限可以访问，返回访问令牌中的额外信息（也就是自定义的Token增强器CustomTokenEnhancer加入到访问令牌中的额外信息，Key是userDetails），这里也演示了使用TokenStore来解析Token的方式。</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">@RestController</span></div><div class="token-line"><span class="token plain">    @RequestMapping(&quot;user&quot;)</span></div><div class="token-line"><span class="token plain">    public class UserController {</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        @Autowired</span></div><div class="token-line"><span class="token plain">        private TokenStore tokenStore;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        /***</span></div><div class="token-line"><span class="token plain">         * 读权限或写权限可访问，返回登录用户名</span></div><div class="token-line"><span class="token plain">         * @param authentication</span></div><div class="token-line"><span class="token plain">         * @return</span></div><div class="token-line"><span class="token plain">         */</span></div><div class="token-line"><span class="token plain">        @PreAuthorize(&quot;hasAuthority(&#x27;READ&#x27;) or hasAuthority(&#x27;WRITE&#x27;)&quot;)</span></div><div class="token-line"><span class="token plain">        @GetMapping(&quot;name&quot;)</span></div><div class="token-line"><span class="token plain">        public String name(OAuth2Authentication authentication) {</span></div><div class="token-line"><span class="token plain">            return authentication.getName();</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        /**</span></div><div class="token-line"><span class="token plain">         * 读权限或写权限可访问，返回登录用户信息</span></div><div class="token-line"><span class="token plain">         * @param authentication</span></div><div class="token-line"><span class="token plain">         * @return</span></div><div class="token-line"><span class="token plain">         */</span></div><div class="token-line"><span class="token plain">        @PreAuthorize(&quot;hasAuthority(&#x27;READ&#x27;) or hasAuthority(&#x27;WRITE&#x27;)&quot;)</span></div><div class="token-line"><span class="token plain">        @GetMapping</span></div><div class="token-line"><span class="token plain">        public OAuth2Authentication read(OAuth2Authentication authentication) {</span></div><div class="token-line"><span class="token plain">            return authentication;</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        /**</span></div><div class="token-line"><span class="token plain">         * 只有写权限可以访问，返回访问令牌中的额外信息</span></div><div class="token-line"><span class="token plain">         * @param authentication</span></div><div class="token-line"><span class="token plain">         * @return</span></div><div class="token-line"><span class="token plain">         */</span></div><div class="token-line"><span class="token plain">        @PreAuthorize(&quot;hasAuthority(&#x27;WRITE&#x27;)&quot;)</span></div><div class="token-line"><span class="token plain">        @PostMapping</span></div><div class="token-line"><span class="token plain">        public Object write(OAuth2Authentication authentication) {</span></div><div class="token-line"><span class="token plain">            OAuth2AuthenticationDetails details = (OAuth2AuthenticationDetails) authentication.getDetails();</span></div><div class="token-line"><span class="token plain">            OAuth2AccessToken accessToken = tokenStore.readAccessToken(details.getTokenValue());</span></div><div class="token-line"><span class="token plain">            return accessToken.getAdditionalInformation().getOrDefault(&quot;userDetails&quot;, null);</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>第三步，创建核心的资源服务器配置类。这里我们需要注意下面两点：</p><ul><li>我们硬编码了资源服务器的ID为userservice；</li><li>现在我们使用的是不落数据库的JWT方式+非对称加密，需要通过本地公钥进行验证，因此在这里我们配置了公钥的路径。</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">@Configuration</span></div><div class="token-line"><span class="token plain">    @EnableResourceServer //启用资源服务器</span></div><div class="token-line"><span class="token plain">    @EnableGlobalMethodSecurity(prePostEnabled = true) //启用方法注解方式来进行权限控制</span></div><div class="token-line"><span class="token plain">    public class ResourceServerConfiguration extends ResourceServerConfigurerAdapter {</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        /**</span></div><div class="token-line"><span class="token plain">         * 声明了资源服务器的ID是userservice，声明了资源服务器的TokenStore是JWT</span></div><div class="token-line"><span class="token plain">         * @param resources</span></div><div class="token-line"><span class="token plain">         * @throws Exception</span></div><div class="token-line"><span class="token plain">         */</span></div><div class="token-line"><span class="token plain">        @Override</span></div><div class="token-line"><span class="token plain">        public void configure(ResourceServerSecurityConfigurer resources) throws Exception {</span></div><div class="token-line"><span class="token plain">            resources.resourceId(&quot;userservice&quot;).tokenStore(tokenStore());</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        /**</span></div><div class="token-line"><span class="token plain">         * 配置TokenStore</span></div><div class="token-line"><span class="token plain">         * @return</span></div><div class="token-line"><span class="token plain">         */</span></div><div class="token-line"><span class="token plain">        @Bean</span></div><div class="token-line"><span class="token plain">        public TokenStore tokenStore() {</span></div><div class="token-line"><span class="token plain">            return new JwtTokenStore(jwtAccessTokenConverter());</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        /**</span></div><div class="token-line"><span class="token plain">         * 配置公钥</span></div><div class="token-line"><span class="token plain">         * @return</span></div><div class="token-line"><span class="token plain">         */</span></div><div class="token-line"><span class="token plain">        @Bean</span></div><div class="token-line"><span class="token plain">        protected JwtAccessTokenConverter jwtAccessTokenConverter() {</span></div><div class="token-line"><span class="token plain">            JwtAccessTokenConverter converter = new JwtAccessTokenConverter();</span></div><div class="token-line"><span class="token plain">            Resource resource = new ClassPathResource(&quot;public.cert&quot;);</span></div><div class="token-line"><span class="token plain">            String publicKey = null;</span></div><div class="token-line"><span class="token plain">            try {</span></div><div class="token-line"><span class="token plain">                publicKey = new String(FileCopyUtils.copyToByteArray(resource.getInputStream()));</span></div><div class="token-line"><span class="token plain">            } catch (IOException e) {</span></div><div class="token-line"><span class="token plain">                e.printStackTrace();</span></div><div class="token-line"><span class="token plain">            }</span></div><div class="token-line"><span class="token plain">            converter.setVerifierKey(publicKey);</span></div><div class="token-line"><span class="token plain">            return converter;</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        /**</span></div><div class="token-line"><span class="token plain">         * 配置了除了/user路径之外的请求可以匿名访问</span></div><div class="token-line"><span class="token plain">         * @param http</span></div><div class="token-line"><span class="token plain">         * @throws Exception</span></div><div class="token-line"><span class="token plain">         */</span></div><div class="token-line"><span class="token plain">        @Override</span></div><div class="token-line"><span class="token plain">        public void configure(HttpSecurity http) throws Exception {</span></div><div class="token-line"><span class="token plain">            http.authorizeRequests()</span></div><div class="token-line"><span class="token plain">                    .antMatchers(&quot;/user/**&quot;).authenticated()</span></div><div class="token-line"><span class="token plain">                    .anyRequest().permitAll();</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>到这里，我们来想一下，如果授权服务器产生Token的话，受保护资源服务器必须要有一种办法来验证Token，那如果这里的Token不是JWT的方式，我们可以怎么办呢？</p><p>我来说下我的方法吧：</p><ul><li>首先，Token可以保存在数据库或Redis中，资源服务器和授权服务器共享底层的TokenStore来验证；</li><li>然后，资源服务器可以使用RemoteTokenServices，来从授权服务器的/oauth/check_token端点进行Token校验。</li></ul><p>到这里，资源服务器就配置完成了，我们还在资源服务器中分别创建了两个控制器HelloController和UserController，用于分别测试可以匿名访问以及受到权限保护的资源。</p><h2 id="初始化数据配置"><a aria-hidden="true" tabindex="-1" href="/blog-architect/oauth2.0实战课/03.进阶篇/05#初始化数据配置"><span class="icon icon-link"></span></a>初始化数据配置</h2><p>在实现了授权服务器和受保护资源服务器代码后，我们再来初始化oauth数据库的数据就非常容易理解了。总结起来，我们需要配置用户、权限和客户端三部分。</p><ol><li><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">配置两个用户。其中，读用户reader具有读权限，密码为reader；写用户writer具有读写权限，密码为writer。还记得吗，密码我们使用的是BCryptPasswordEncoder加密（准确说是哈希）？</span></div></pre></div></li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">INSERT INTO `users` VALUES (&#x27;reader&#x27;, &#x27;$2a$04$C6pPJvC1v6.enW6ZZxX.luTdpSI/1gcgTVN7LhvQV6l/AfmzNU/3i&#x27;, 1);</span></div><div class="token-line"><span class="token plain">    INSERT INTO `users` VALUES (&#x27;writer&#x27;, &#x27;$2a$04$M9t2oVs3/VIreBMocOujqOaB/oziWL0SnlWdt8hV4YnlhQrORA0fS&#x27;, 1);</span></div></pre></div><ol start="2"><li><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">配置两个权限，也就是配置reader用户具有读权限，writer用户具有写权限：</span></div></pre></div></li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">INSERT INTO `authorities` VALUES (&#x27;reader&#x27;, &#x27;READ&#x27;);</span></div><div class="token-line"><span class="token plain">    INSERT INTO `authorities` VALUES (&#x27;writer&#x27;, &#x27;READ,WRITE&#x27;);</span></div></pre></div><ol start="3"><li><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">配置三个客户端，其中客户端userservice1使用资源拥有者凭据许可类型，客户端userservice2使用客户端凭据许可类型，客户端userservice3使用授权码许可类型。</span></div></pre></div></li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">INSERT INTO `oauth_client_details` VALUES (&#x27;userservice1&#x27;, &#x27;userservice&#x27;, &#x27;1234&#x27;, &#x27;FOO&#x27;, &#x27;password,refresh_token&#x27;, &#x27;&#x27;, &#x27;READ,WRITE&#x27;, 7200, NULL, NULL, &#x27;true&#x27;);</span></div><div class="token-line"><span class="token plain">    INSERT INTO `oauth_client_details` VALUES (&#x27;userservice2&#x27;, &#x27;userservice&#x27;, &#x27;1234&#x27;, &#x27;FOO&#x27;, &#x27;client_credentials,refresh_token&#x27;, &#x27;&#x27;, &#x27;READ,WRITE&#x27;, 7200, NULL, NULL, &#x27;true&#x27;);</span></div><div class="token-line"><span class="token plain">    INSERT INTO `oauth_client_details` VALUES (&#x27;userservice3&#x27;, &#x27;userservice&#x27;, &#x27;1234&#x27;, &#x27;FOO&#x27;, &#x27;authorization_code,refresh_token&#x27;, &#x27;https://baidu.com,http://localhost:8082/ui/login,http://localhost:8083/ui/login,http://localhost:8082/ui/remoteCall&#x27;, &#x27;READ,WRITE&#x27;, 7200, NULL, NULL, &#x27;false&#x27;);</span></div></pre></div><p>值得说明的是：</p><ul><li>三个客户端账号能使用的资源ID都是userservice，对应我们受保护资源服务器刚才配置的资源ID，也就是userservice，这两者需要一致。</li><li>三个客户端账号的密码都是1234。</li><li>三个客户端账号的授权范围都是FOO（并不是关键信息），它们可以拿到的权限是读写。不过，对于和用户相关的授权许可类型（比如资源拥有者凭据许可、授权码许可），最终拿到的权限还取决于客户端权限和用户权限的交集。</li><li>通过grant_types字段配置支持不同的授权许可类型。这里为了便于测试观察，我们给三个客户端账号各自配置了一种授权许可类型；在实际业务场景中，你完全可以为同一个客户端配置支持OAuth 2.0的四种授权许可类型。</li><li>userservice1和userservice2我们配置了用户自动批准授权（不会弹出一个页面要求用户进行授权）。</li></ul><h2 id="演示三种授权许可类型"><a aria-hidden="true" tabindex="-1" href="/blog-architect/oauth2.0实战课/03.进阶篇/05#演示三种授权许可类型"><span class="icon icon-link"></span></a>演示三种授权许可类型</h2><p>到这里，授权服务器和受保护资源服务器程序都搭建完成了，数据库也配置了用于测试的用户、权限和客户端。接下来，我们就使用Postman来手工测试一下OAuth 2.0的授权码许可、资源拥有者凭据许可、客户端凭据许可这三种授权许可类型吧。</p><h3 id="资源拥有者凭据许可类型"><a aria-hidden="true" tabindex="-1" href="/blog-architect/oauth2.0实战课/03.进阶篇/05#资源拥有者凭据许可类型"><span class="icon icon-link"></span></a>资源拥有者凭据许可类型</h3><p>首先，我们测试的是资源拥有者凭据许可，POST请求地址是：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">http://localhost:8080/oauth/token?grant_type=password&amp;client_id=userservice1&amp;client_secret=1234&amp;username=writer&amp;password=writer</span></div></pre></div><p>得到如下图所示结果：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage18e418cd7b24ff152e28806b1176b0a560e4.dbb6d68e.png" alt=""/></p><p>再使用<a target="_blank" rel="noopener noreferrer" href="http://jwt.io/">JWT解析工具<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>看下请求Token中的信息：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage8e7e8e4c2dd1931a31197df55cc251b2a07e.edebb12c.png" alt=""/></p><p>可以看到，Token中果然包含了Token增强器加入的userDetails自定义信息。如果我们把公钥粘贴到页面的话，可以看到这个JWT校验成功了：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage4dae4d701319144d3de7c5d743f59e4991ae.ef801755.png" alt=""/></p><p>除了本地校验外，还可以访问授权服务器来校验JWT：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">http://localhost:8080/oauth/check_token?client_id=userservice1&amp;client_secret=1234&amp;token=...</span></div></pre></div><p>得到如下结果：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage28952835c0d2b49ac515c9f6c537dd2f7195.76efc98f.png" alt=""/></p><h3 id="客户端授权许可类型"><a aria-hidden="true" tabindex="-1" href="/blog-architect/oauth2.0实战课/03.进阶篇/05#客户端授权许可类型"><span class="icon icon-link"></span></a>客户端授权许可类型</h3><p>我们再来测试下客户端授权许可类型。POST请求地址：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">http://localhost:8080/oauth/token?grant_type=client_credentials&amp;client_id=userservice2&amp;client_secret=1234</span></div></pre></div><p>如下图所示，可以直接拿到Token：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage81e981722855fd6935aea594ec62b64bf0e9.1cdbbb4e.png" alt=""/></p><p>这里需要注意的是，并没有提供刷新令牌。这是因为，刷新令牌用于避免访问令牌失效后需要用户再次登录的问题，而客户端授权许可类型没有用户的概念，因此没有刷新令牌，也无法注入额外的userDetails信息。</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimagefcdafcf2b1c1a53ecc33d3a0abc72b6d83da.98bc926f.png" alt=""/></p><p>也可以试一下，如果我们的授权服务器没有开启allowFormAuthenticationForClients参数（允许表单提交认证）的话，客户端的凭证需要通过Basic Auth传过去而不是通过Post：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimagece6fce391c3c93e2131e1cf8fb4e3324b66f.cea25840.png" alt=""/></p><h3 id="授权码许可类型"><a aria-hidden="true" tabindex="-1" href="/blog-architect/oauth2.0实战课/03.进阶篇/05#授权码许可类型"><span class="icon icon-link"></span></a>授权码许可类型</h3><p>最后，我们来测试下比较复杂的授权码许可。</p><p><strong>第一步</strong>，打开浏览器访问地址：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">http://localhost:8080/oauth/authorize?response_type=code&amp;client_id=userservice3&amp;redirect_uri=https://baidu.com</span></div></pre></div><p>注意，客户端跳转地址需要和数据库中配置的一致（百度的URL <a target="_blank" rel="noopener noreferrer" href="https://baidu.com/">https://baidu.com<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><p>我们之前已经在数据库中有配置了）。访问后页面会直接跳转到登录界面，我们使用用户名“reader”、密码“reader”来登录：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage731173c3bd926e4e350b220447cd8b97d811.1cc602fc.png" alt=""/></p><p>由于我们在数据库中设置的是禁用自动批准授权的模式，所以登录后来到了批准界面：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage9c019cac3b06b632220166d7e43607da4901.9f339abf.png" alt=""/></p><p>点击同意后可以看到，数据库中也会产生授权通过记录：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage9e6f9e942cc7c22ff8b4540e9f6736d56b6f.344e111f.png" alt=""/></p><p>**第二步，**我们可以看到浏览器转到了百度并且提供给了我们授权码：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">https://www.baidu.com/?code=XKkHGY</span></div></pre></div><p>数据库中也记录了授权码：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimageef3eeff235ff90aafb559d6e45b07a4d173e.ab506acd.png" alt=""/></p><p>然后POST访问下面的地址（code参数替换为刚才获得的授权码）：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">http://localhost:8080/oauth/token?grant_type=authorization_code&amp;client_id=userservice3&amp;client_secret=1234&amp;code=XKkHGY&amp;redirect_uri=https://baidu.com</span></div></pre></div><p>可以通过授权码换取访问令牌：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimageead7ea401694bf55f83353f7db65d17ab6d7.df21622c.png" alt=""/></p><p>虽然userservice3客户端可以有读权限和写权限，但是因为我们登录的用户reader只有读权限，所以最后拿到也只有读权限。</p><h2 id="演示权限控制"><a aria-hidden="true" tabindex="-1" href="/blog-architect/oauth2.0实战课/03.进阶篇/05#演示权限控制"><span class="icon icon-link"></span></a>演示权限控制</h2><p>现在我们来测试一下之前定义的两个账号，也就是读账号和写账号，看看它们的权限控制是否有效。</p><p>首先，测试一下我们的安全配置，访问/hello端点不需要认证可以匿名访问：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage76597646fe1e6e4cc9914f79881576126459.5ab39e14.png" alt=""/></p><p>访问/user需要身份认证：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage3bf63b22a89392c92187960aecd4bc3cf8f6.8b7b8de4.png" alt=""/></p><p>不管以哪种模式拿到访问令牌，我们用具有读权限的访问令牌访问资源服务器的如下地址</p><p>（请求头加入Authorization: Bearer XXXXXXXXXX，其中XXXXXXXXXX代表访问令牌）：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">http://localhost:8081/user/</span></div></pre></div><p>可以得到如下结果：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage06d50606fbb094de245d346ed17d9yycd6d5.a934e6ca.png" alt=""/></p><p>以POST方式访问<a target="_blank" rel="noopener noreferrer" href="http://localhost:8081/user/%EF%BC%8C%E6%98%BE%E7%84%B6%E6%98%AF%E5%A4%B1%E8%B4%A5%E7%9A%84%EF%BC%9A">http://localhost:8081/user/，显然是失败的：<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimagea788a71bcef74da7577aa1529bf2d9546588.7833cbcf.png" alt=""/></p><p>因为这个接口要求有写权限：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">@PreAuthorize(&quot;hasAuthority(&#x27;WRITE&#x27;)&quot;)</span></div><div class="token-line"><span class="token plain">    @PostMapping</span></div><div class="token-line"><span class="token plain">    public Object write(OAuth2Authentication authentication) {</span></div></pre></div><p>我们换一个具有读写权限的访问令牌来试试：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimagea7fca754a6fdcb9666e07f1b820052a4e2fc.50fe4e5d.png" alt=""/></p><p>可以发现，果然访问成功了。这里输出的内容是Token中的userDetails额外信息，说明资源服务器的权限控制有效。</p><h2 id="搭建客户端程序"><a aria-hidden="true" tabindex="-1" href="/blog-architect/oauth2.0实战课/03.进阶篇/05#搭建客户端程序"><span class="icon icon-link"></span></a>搭建客户端程序</h2><p>在上面的演示中，我们使用的是Postman，也就是手动HTTP请求的方式来申请和使用Token。最后，我们来搭建一个OAuth客户端程序自动实现这个过程。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></div><div class="token-line"><span class="token plain">    &lt;project xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></div><div class="token-line"><span class="token plain">             xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span></div><div class="token-line"><span class="token plain">             xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        &lt;parent&gt;</span></div><div class="token-line"><span class="token plain">            &lt;artifactId&gt;springsecurity101&lt;/artifactId&gt;</span></div><div class="token-line"><span class="token plain">            &lt;groupId&gt;me.josephzhu&lt;/groupId&gt;</span></div><div class="token-line"><span class="token plain">            &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span></div><div class="token-line"><span class="token plain">        &lt;/parent&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        &lt;artifactId&gt;springsecurity101-cloud-oauth2-client&lt;/artifactId&gt;</span></div><div class="token-line"><span class="token plain">        &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        &lt;dependencies&gt;</span></div><div class="token-line"><span class="token plain">            &lt;dependency&gt;</span></div><div class="token-line"><span class="token plain">                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></div><div class="token-line"><span class="token plain">                &lt;artifactId&gt;spring-cloud-starter-oauth2&lt;/artifactId&gt;</span></div><div class="token-line"><span class="token plain">            &lt;/dependency&gt;</span></div><div class="token-line"><span class="token plain">            &lt;dependency&gt;</span></div><div class="token-line"><span class="token plain">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></div><div class="token-line"><span class="token plain">                &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span></div><div class="token-line"><span class="token plain">            &lt;/dependency&gt;</span></div><div class="token-line"><span class="token plain">            &lt;dependency&gt;</span></div><div class="token-line"><span class="token plain">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></div><div class="token-line"><span class="token plain">                &lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;</span></div><div class="token-line"><span class="token plain">            &lt;/dependency&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        &lt;/dependencies&gt;</span></div><div class="token-line"><span class="token plain">    &lt;/project&gt;</span></div></pre></div><p>配置文件如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">server:</span></div><div class="token-line"><span class="token plain">      port: 8083</span></div><div class="token-line"><span class="token plain">      servlet:</span></div><div class="token-line"><span class="token plain">        context-path: /ui</span></div><div class="token-line"><span class="token plain">    security:</span></div><div class="token-line"><span class="token plain">      oauth2:</span></div><div class="token-line"><span class="token plain">        client:</span></div><div class="token-line"><span class="token plain">          clientId: userservice3</span></div><div class="token-line"><span class="token plain">          clientSecret: 1234</span></div><div class="token-line"><span class="token plain">          accessTokenUri: http://localhost:8080/oauth/token</span></div><div class="token-line"><span class="token plain">          userAuthorizationUri: http://localhost:8080/oauth/authorize</span></div><div class="token-line"><span class="token plain">          scope: FOO</span></div><div class="token-line"><span class="token plain">        resource:</span></div><div class="token-line"><span class="token plain">          jwt:</span></div><div class="token-line"><span class="token plain">            key-value: |</span></div><div class="token-line"><span class="token plain">              -----BEGIN PUBLIC KEY-----</span></div><div class="token-line"><span class="token plain">              ***</span></div><div class="token-line"><span class="token plain">              -----END PUBLIC KEY-----</span></div><div class="token-line"><span class="token plain">    spring:</span></div><div class="token-line"><span class="token plain">      thymeleaf:</span></div><div class="token-line"><span class="token plain">        cache: false</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    #logging:</span></div><div class="token-line"><span class="token plain">    #  level:</span></div><div class="token-line"><span class="token plain">    #    ROOT: DEBUG</span></div></pre></div><p>客户端项目端口8082，几个需要说明的地方：</p><ul><li>本地测试的时候有一个坑，也就是我们需要配置context-path，否则可能会出现客户端和授权服务器服务端Cookie干扰，导致CSRF防御触发的问题。这个问题出现后程序没有任何错误日志输出，只有开启DEBUG模式后才能看到DEBUG日志里有提示，因此这个问题非常难以排查。说实话，我也不知道Spring为什么不把这个信息作为WARN级别的日志输出。</li><li>作为OAuth客户端，我们需要配置OAuth服务端获取Token的地址、授权（获取授权码）的地址，需要配置客户端的ID、密码和授权范围。</li><li>因为使用的是JWT Token，我们需要配置公钥（当然，如果不在这里直接配置公钥的话，也可以配置从授权服务器服务端获取公钥）。</li></ul><p>接下来，我们可以开始编码了。</p><p>第一步，实现MVC的配置：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">@Configuration</span></div><div class="token-line"><span class="token plain">    @EnableWebMvc</span></div><div class="token-line"><span class="token plain">    public class WebMvcConfig implements WebMvcConfigurer {</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        /**</span></div><div class="token-line"><span class="token plain">         * 配置RequestContextListener用于启用session scope的Bean</span></div><div class="token-line"><span class="token plain">         * @return</span></div><div class="token-line"><span class="token plain">         */</span></div><div class="token-line"><span class="token plain">        @Bean</span></div><div class="token-line"><span class="token plain">        public RequestContextListener requestContextListener() {</span></div><div class="token-line"><span class="token plain">            return new RequestContextListener();</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">        /**</span></div><div class="token-line"><span class="token plain">         * 配置index路径的首页Controller</span></div><div class="token-line"><span class="token plain">         * @param registry</span></div><div class="token-line"><span class="token plain">         */</span></div><div class="token-line"><span class="token plain">        @Override</span></div><div class="token-line"><span class="token plain">        public void addViewControllers(ViewControllerRegistry registry) {</span></div><div class="token-line"><span class="token plain">            registry.addViewController(&quot;/&quot;)</span></div><div class="token-line"><span class="token plain">                    .setViewName(&quot;forward:/index&quot;);</span></div><div class="token-line"><span class="token plain">            registry.addViewController(&quot;/index&quot;);</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>这里做了两件事情：</p><ol><li>配置RequestContextListener，用于启用session scope的Bean；</li><li>配置了index路径的首页Controller。</li></ol><p>第二步，实现安全方面的配置：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">@Configuration</span></div><div class="token-line"><span class="token plain">    @Order(200)</span></div><div class="token-line"><span class="token plain">    public class WebSecurityConfig extends WebSecurityConfigurerAdapter {</span></div><div class="token-line"><span class="token plain">        /**</span></div><div class="token-line"><span class="token plain">         * /路径和/login路径允许访问，其它路径需要身份认证后才能访问</span></div><div class="token-line"><span class="token plain">         * @param http</span></div><div class="token-line"><span class="token plain">         * @throws Exception</span></div><div class="token-line"><span class="token plain">         */</span></div><div class="token-line"><span class="token plain">        @Override</span></div><div class="token-line"><span class="token plain">        protected void configure(HttpSecurity http) throws Exception {</span></div><div class="token-line"><span class="token plain">            http</span></div><div class="token-line"><span class="token plain">                    .authorizeRequests()</span></div><div class="token-line"><span class="token plain">                    .antMatchers(&quot;/&quot;, &quot;/login**&quot;)</span></div><div class="token-line"><span class="token plain">                    .permitAll()</span></div><div class="token-line"><span class="token plain">                    .anyRequest()</span></div><div class="token-line"><span class="token plain">                    .authenticated();</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>这里我们实现的是/路径和/login路径允许访问，其它路径需要身份认证后才能访问。</p><p>第三步，我们来创建一个控制器：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">@RestController</span></div><div class="token-line"><span class="token plain">    public class DemoController {</span></div><div class="token-line"><span class="token plain">        @Autowired</span></div><div class="token-line"><span class="token plain">        OAuth2RestTemplate restTemplate;</span></div><div class="token-line"><span class="token plain">        //演示登录后才能访问的安全页面</span></div><div class="token-line"><span class="token plain">        @GetMapping(&quot;/securedPage&quot;)</span></div><div class="token-line"><span class="token plain">        public ModelAndView securedPage(OAuth2Authentication authentication) {</span></div><div class="token-line"><span class="token plain">            return new ModelAndView(&quot;securedPage&quot;).addObject(&quot;authentication&quot;, authentication);</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">        //演示通过OAuth2RestTemplate调用受保护资源</span></div><div class="token-line"><span class="token plain">        @GetMapping(&quot;/remoteCall&quot;)</span></div><div class="token-line"><span class="token plain">        public String remoteCall() {</span></div><div class="token-line"><span class="token plain">            ResponseEntity&lt;String&gt; responseEntity = restTemplate.getForEntity(&quot;http://localhost:8081/user/name&quot;, String.class);</span></div><div class="token-line"><span class="token plain">            return responseEntity.getBody();</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>这里我们实现了两个功能：</p><ol><li>securedPage页面，实现的功能是，把用户信息作为模型传入了视图，这样打开页面后就能显示用户名和权限。</li><li>remoteCall接口，实现的功能是，通过引入OAuth2RestTemplate，在登录后就可以使用凭据直接从受保护资源服务器拿资源，不需要繁琐地实现获得访问令牌、在请求头里加入访问令牌的过程。</li></ol><p>第四步，配置一下刚才用到的OAuth2RestTemplate Bean，并启用OAuth2Sso功能：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">@Configuration</span></div><div class="token-line"><span class="token plain">    @EnableOAuth2Sso //这个注解包含了@EnableOAuth2Client</span></div><div class="token-line"><span class="token plain">    public class OAuthClientConfig {</span></div><div class="token-line"><span class="token plain">        /**</span></div><div class="token-line"><span class="token plain">         * 定义了OAuth2RestTemplate，网上一些比较老的资料给出的是手动读取配置文件来实现，最新版本已经可以自动注入OAuth2ProtectedResourceDetails</span></div><div class="token-line"><span class="token plain">         * @param oAuth2ClientContext</span></div><div class="token-line"><span class="token plain">         * @param details</span></div><div class="token-line"><span class="token plain">         * @return</span></div><div class="token-line"><span class="token plain">         */</span></div><div class="token-line"><span class="token plain">        @Bean</span></div><div class="token-line"><span class="token plain">        public OAuth2RestTemplate oauth2RestTemplate(OAuth2ClientContext oAuth2ClientContext,</span></div><div class="token-line"><span class="token plain">                                                     OAuth2ProtectedResourceDetails details) {</span></div><div class="token-line"><span class="token plain">            return new OAuth2RestTemplate(details, oAuth2ClientContext);</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>第五步，实现首页：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">&lt;body&gt;</span></div><div class="token-line"><span class="token plain">    &lt;div class=&quot;container&quot;&gt;</span></div><div class="token-line"><span class="token plain">        &lt;div class=&quot;col-sm-12&quot;&gt;</span></div><div class="token-line"><span class="token plain">            &lt;h1&gt;Spring Security SSO Client&lt;/h1&gt;</span></div><div class="token-line"><span class="token plain">            &lt;a class=&quot;btn btn-primary&quot; href=&quot;securedPage&quot;&gt;Login&lt;/a&gt;</span></div><div class="token-line"><span class="token plain">        &lt;/div&gt;</span></div><div class="token-line"><span class="token plain">    &lt;/div&gt;</span></div><div class="token-line"><span class="token plain">    &lt;/body&gt;</span></div></pre></div><p>以及登录后才能访问的securedPage页面：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">&lt;body&gt;</span></div><div class="token-line"><span class="token plain">    &lt;div class=&quot;container&quot;&gt;</span></div><div class="token-line"><span class="token plain">        &lt;div class=&quot;col-sm-12&quot;&gt;</span></div><div class="token-line"><span class="token plain">            &lt;h1&gt;Secured Page&lt;/h1&gt;</span></div><div class="token-line"><span class="token plain">            Welcome, &lt;span th:text=&quot;${authentication.name}&quot;&gt;Name&lt;/span&gt;</span></div><div class="token-line"><span class="token plain">            &lt;br/&gt;</span></div><div class="token-line"><span class="token plain">            Your authorities are &lt;span th:text=&quot;${authentication.authorities}&quot;&gt;authorities&lt;/span&gt;</span></div><div class="token-line"><span class="token plain">        &lt;/div&gt;</span></div><div class="token-line"><span class="token plain">    &lt;/div&gt;</span></div><div class="token-line"><span class="token plain">    &lt;/body&gt;</span></div></pre></div><h2 id="演示单点登录"><a aria-hidden="true" tabindex="-1" href="/blog-architect/oauth2.0实战课/03.进阶篇/05#演示单点登录"><span class="icon icon-link"></span></a>演示单点登录</h2><p>好，客户端程序搭建好之后，我们先来测试一下单点登录的功能。启动客户端项目，打开浏览器访问：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">http://localhost:8082/ui/securedPage</span></div></pre></div><p>可以看到，页面自动转到了授权服务器（8080端口）的登录页面：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage058105b76f316304e3ef2d1494bae501c381.056e5b52.png" alt=""/></p><p>登录后显示了当前用户名和权限：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage7d377d24bc73267506c15f9feyy546557237.2ea8f1ef.png" alt=""/></p><p>我们再启动另一个客户端网站，端口改为8083，然后访问同样的地址：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage7a467a50619ace3e40c8ff7c0aa860f11246.996a1032.png" alt=""/></p><p>可以看到直接是登录状态，单点登录测试成功。是不是很方便？其实，为了达成单点登录的效果，程序在背后自动实现了多次302重定向，整个流程为：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">http://localhost:8083/ui/securedPage -&gt;</span></div><div class="token-line"><span class="token plain">    http://localhost:8083/ui/login -&gt;</span></div><div class="token-line"><span class="token plain">    http://localhost:8080/oauth/authorize?client_id=userservice3&amp;redirect_uri=http://localhost:8083/ui/login&amp;response_type=code&amp;scope=FOO&amp;state=Sobjqe -&gt;</span></div><div class="token-line"><span class="token plain">    http://localhost:8083/ui/login?code=CDdvHa&amp;state=Sobjqe -&gt;</span></div><div class="token-line"><span class="token plain">    http://localhost:8083/ui/securedPage</span></div></pre></div><h2 id="演示客户端请求资源服务器资源"><a aria-hidden="true" tabindex="-1" href="/blog-architect/oauth2.0实战课/03.进阶篇/05#演示客户端请求资源服务器资源"><span class="icon icon-link"></span></a>演示客户端请求资源服务器资源</h2><p>还记得吗，在上一节“搭建客户端程序”中，我们还定义了一个remoteCall接口，直接使用OAuth2RestTemplate来访问远程资源服务器的资源。现在，我们来测试一下这个接口是否可以实现自动的OAuth流程。访问：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">http://localhost:8082/ui/remoteCall</span></div></pre></div><p>会先转到授权服务器登录，登录后自动跳转回来：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage0127016f28b7161d2c600197aa2392b0de27.68a68697.png" alt=""/></p><p>可以看到输出了用户名，对应的资源服务器服务端接口是：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">@PreAuthorize(&quot;hasAuthority(&#x27;READ&#x27;) or hasAuthority(&#x27;WRITE&#x27;)&quot;)</span></div><div class="token-line"><span class="token plain">    @GetMapping(&quot;name&quot;)</span></div><div class="token-line"><span class="token plain">    public String name(OAuth2Authentication authentication) {</span></div><div class="token-line"><span class="token plain">        return authentication.getName();</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>换一个writer用户登录试试，也能得到正确的输出：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimageyy84yy2bca66c45cefa56d2d727c3a136a84.8315d145.png" alt=""/></p><h2 id="总结"><a aria-hidden="true" tabindex="-1" href="/blog-architect/oauth2.0实战课/03.进阶篇/05#总结"><span class="icon icon-link"></span></a>总结</h2><p>今天这一讲，我们完整演示了如何使用Spring Cloud的OAuth 2.0组件基于三个程序角色（授权服务器、受保护资源服务器和客户端）实现三种OAuth 2.0的授权许可类型（资源拥有者凭据许可、客户端凭据许可和授权码许可）。</p><p>我们先演示了三种授权许可类型的手动流程，然后也演示了如何实现权限控制和单点登录，以及如何使用客户端程序来实现自动的OAuth 2.0流程。</p><p>我把今天用到的所有代码都放到了GitHub上，你可以点击<a target="_blank" rel="noopener noreferrer" href="https://github.com/JosephZhu1983/SpringSecurity101">这个链接<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>查看。</p><p>最后，我再提一下，将来Spring对于OAuth 2.0的支持可能会转移到<a target="_blank" rel="noopener noreferrer" href="https://spring.io/blog/2020/04/15/announcing-the-spring-authorization-server">由社区推进的Spring Authorization Server项目上来继续运作<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。如果你感兴趣的话，可以及时关注这个项目的进展。</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/ssrc/oauth2.0实战课/03.进阶篇/05.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">2023/9/29 14:47:35</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog-architect/umi.ded6fefd.js"></script>
  </body>
</html>
