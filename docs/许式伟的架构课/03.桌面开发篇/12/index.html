<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
    <link rel="stylesheet" href="/blog-architect/umi.3ec1f225.css" />
    <script>
      window.routerBase = "/blog-architect";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>31 | 辅助界面元素的架构设计 - 大师兄</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/许式伟的架构课/03.桌面开发篇/12" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-architect/">大师兄</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span>后端开发<ul><li><a href="/blog-architect/spark性能调优实战">spark性能调优实战</a></li></ul></span><span>架构师<ul><li><a href="/blog-architect/设计模式之美">设计模式之美</a></li><li><a href="/blog-architect/架构实战案例解析">架构实战案例解析</a></li><li><a aria-current="page" class="active" href="/blog-architect/许式伟的架构课">许式伟的架构课</a></li><li><a href="/blog-architect/说透中台">说透中台</a></li><li><a href="/blog-architect/oauth2.0实战课">oauth2.0实战课</a></li><li><a href="/blog-architect/从0开始学架构">从0开始学架构</a></li><li><a href="/blog-architect/即时消息技术剖析与实战">即时消息技术剖析与实战</a></li><li><a href="/blog-architect/如何设计一个秒杀系统">如何设计一个秒杀系统</a></li><li><a href="/blog-architect/如何落地业务建模">如何落地业务建模</a></li><li><a href="/blog-architect/性能优化高手课">性能优化高手课</a></li><li><a href="/blog-architect/性能工程高手课">性能工程高手课</a></li><li><a href="/blog-architect/手把手带你搭建秒杀系统">手把手带你搭建秒杀系统</a></li><li><a href="/blog-architect/技术与商业案例解读">技术与商业案例解读</a></li><li><a href="/blog-architect/推荐系统三十六式">推荐系统三十六式</a></li><li><a href="/blog-architect/检索技术核心20讲">检索技术核心20讲</a></li><li><a href="/blog-architect/软件设计之美">软件设计之美</a></li><li><a href="/blog-architect/高并发系统设计40问">高并发系统设计40问</a></li><li><a href="/blog-architect/高楼的性能工程实战课">高楼的性能工程实战课</a></li></ul></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;/logo.png&#x27;)" href="/blog-architect/"></a><h1>大师兄</h1><p></p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li>后端开发<ul><li><a href="/blog-architect/spark性能调优实战">spark性能调优实战</a></li></ul></li><li>架构师<ul><li><a href="/blog-architect/设计模式之美">设计模式之美</a></li><li><a href="/blog-architect/架构实战案例解析">架构实战案例解析</a></li><li><a aria-current="page" class="active" href="/blog-architect/许式伟的架构课">许式伟的架构课</a></li><li><a href="/blog-architect/说透中台">说透中台</a></li><li><a href="/blog-architect/oauth2.0实战课">oauth2.0实战课</a></li><li><a href="/blog-architect/从0开始学架构">从0开始学架构</a></li><li><a href="/blog-architect/即时消息技术剖析与实战">即时消息技术剖析与实战</a></li><li><a href="/blog-architect/如何设计一个秒杀系统">如何设计一个秒杀系统</a></li><li><a href="/blog-architect/如何落地业务建模">如何落地业务建模</a></li><li><a href="/blog-architect/性能优化高手课">性能优化高手课</a></li><li><a href="/blog-architect/性能工程高手课">性能工程高手课</a></li><li><a href="/blog-architect/手把手带你搭建秒杀系统">手把手带你搭建秒杀系统</a></li><li><a href="/blog-architect/技术与商业案例解读">技术与商业案例解读</a></li><li><a href="/blog-architect/推荐系统三十六式">推荐系统三十六式</a></li><li><a href="/blog-architect/检索技术核心20讲">检索技术核心20讲</a></li><li><a href="/blog-architect/软件设计之美">软件设计之美</a></li><li><a href="/blog-architect/高并发系统设计40问">高并发系统设计40问</a></li><li><a href="/blog-architect/高楼的性能工程实战课">高楼的性能工程实战课</a></li></ul></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/blog-architect/许式伟的架构课">许式伟的架构课</a></li><li><a href="/blog-architect/许式伟的架构课/01.开篇词">01.开篇词</a><ul><li><a href="/blog-architect/许式伟的架构课/01.开篇词/01"><span>开篇词 | 怎样成长为优秀的软件架构师？</span></a></li></ul></li><li><a href="/blog-architect/许式伟的架构课/02.基础平台篇">02.基础平台篇</a><ul><li><a href="/blog-architect/许式伟的架构课/02.基础平台篇/01"><span>01 | 架构设计的宏观视角</span></a></li><li><a href="/blog-architect/许式伟的架构课/02.基础平台篇/02"><span>02 | 大厦基石：无生有，有生万物</span></a></li><li><a href="/blog-architect/许式伟的架构课/02.基础平台篇/03"><span>03 | 汇编：编程语言的诞生</span></a></li><li><a href="/blog-architect/许式伟的架构课/02.基础平台篇/04"><span>04 | 编程语言的进化</span></a></li><li><a href="/blog-architect/许式伟的架构课/02.基础平台篇/05"><span>05 | 思考题解读：如何实现可自我迭代的计算机？</span></a></li><li><a href="/blog-architect/许式伟的架构课/02.基础平台篇/06"><span>06 | 操作系统进场</span></a></li><li><a href="/blog-architect/许式伟的架构课/02.基础平台篇/07"><span>07 | 软件运行机制及内存管理</span></a></li><li><a href="/blog-architect/许式伟的架构课/02.基础平台篇/08"><span>08 | 操作系统内核与编程接口</span></a></li><li><a href="/blog-architect/许式伟的架构课/02.基础平台篇/09"><span>09 | 外存管理与文件系统</span></a></li><li><a href="/blog-architect/许式伟的架构课/02.基础平台篇/10"><span>10 | 输入和输出设备：交互的演进</span></a></li><li><a href="/blog-architect/许式伟的架构课/02.基础平台篇/11"><span>11 | 多任务：进程、线程与协程</span></a></li><li><a href="/blog-architect/许式伟的架构课/02.基础平台篇/12"><span>12 | 进程内协同：同步、互斥与通讯</span></a></li><li><a href="/blog-architect/许式伟的架构课/02.基础平台篇/13"><span>13 | 进程间的同步互斥、资源共享与通讯</span></a></li><li><a href="/blog-architect/许式伟的架构课/02.基础平台篇/14"><span>14 | IP 网络：连接世界的桥梁</span></a></li><li><a href="/blog-architect/许式伟的架构课/02.基础平台篇/15"><span>15 | 可编程的互联网世界</span></a></li><li><a href="/blog-architect/许式伟的架构课/02.基础平台篇/16"><span>16 | 安全管理：数字世界的守护</span></a></li><li><a href="/blog-architect/许式伟的架构课/02.基础平台篇/17"><span>17 | 架构：需求分析 (上)</span></a></li><li><a href="/blog-architect/许式伟的架构课/02.基础平台篇/18"><span>18 | 架构：需求分析 (下) · 实战案例</span></a></li><li><a href="/blog-architect/许式伟的架构课/02.基础平台篇/19"><span>19 | 基础平台篇：回顾与总结</span></a></li></ul></li><li><a aria-current="page" class="active" href="/blog-architect/许式伟的架构课/03.桌面开发篇">03.桌面开发篇</a><ul><li><a href="/blog-architect/许式伟的架构课/03.桌面开发篇/01"><span>20 | 桌面开发的宏观视角</span></a></li><li><a href="/blog-architect/许式伟的架构课/03.桌面开发篇/02"><span>21 | 图形界面程序的框架</span></a></li><li><a href="/blog-architect/许式伟的架构课/03.桌面开发篇/03"><span>22 | 桌面程序的架构建议</span></a></li><li><a href="/blog-architect/许式伟的架构课/03.桌面开发篇/04"><span>23 | Web开发：浏览器、小程序与PWA</span></a></li><li><a href="/blog-architect/许式伟的架构课/03.桌面开发篇/05"><span>24 | 跨平台与 Web 开发的建议</span></a></li><li><a href="/blog-architect/许式伟的架构课/03.桌面开发篇/06"><span>25 | 桌面开发的未来</span></a></li><li><a href="/blog-architect/许式伟的架构课/03.桌面开发篇/07"><span>26 | 实战（一）：怎么设计一个“画图”程序？</span></a></li><li><a href="/blog-architect/许式伟的架构课/03.桌面开发篇/08"><span>27 | 实战（二）：怎么设计一个“画图”程序？</span></a></li><li><a href="/blog-architect/许式伟的架构课/03.桌面开发篇/09"><span>28 | 实战（三）：怎么设计一个“画图”程序？</span></a></li><li><a href="/blog-architect/许式伟的架构课/03.桌面开发篇/10"><span>29 | 实战（四）：怎么设计一个“画图”程序？</span></a></li><li><a href="/blog-architect/许式伟的架构课/03.桌面开发篇/11"><span>30  | 实战（五）：怎么设计一个“画图”程序？</span></a></li><li><a aria-current="page" class="active" href="/blog-architect/许式伟的架构课/03.桌面开发篇/12"><span>31 | 辅助界面元素的架构设计</span></a></li><li><a href="/blog-architect/许式伟的架构课/03.桌面开发篇/13"><span>32 | 架构：系统的概要设计</span></a></li><li><a href="/blog-architect/许式伟的架构课/03.桌面开发篇/14"><span>33 | 桌面开发篇：回顾与总结</span></a></li></ul></li><li><a href="/blog-architect/许式伟的架构课/04.服务端开发篇">04.服务端开发篇</a><ul><li><a href="/blog-architect/许式伟的架构课/04.服务端开发篇/01"><span>34 | 服务端开发的宏观视角</span></a></li><li><a href="/blog-architect/许式伟的架构课/04.服务端开发篇/02"><span>35 | 流量调度与负载均衡</span></a></li><li><a href="/blog-architect/许式伟的架构课/04.服务端开发篇/03"><span>36 | 业务状态与存储中间件</span></a></li><li><a href="/blog-architect/许式伟的架构课/04.服务端开发篇/04"><span>37 | 键值存储与数据库</span></a></li><li><a href="/blog-architect/许式伟的架构课/04.服务端开发篇/05"><span>38  | 文件系统与对象存储</span></a></li><li><a href="/blog-architect/许式伟的架构课/04.服务端开发篇/06"><span>39  | 存储与缓存</span></a></li><li><a href="/blog-architect/许式伟的架构课/04.服务端开发篇/07"><span>40 | 服务端的业务架构建议</span></a></li><li><a href="/blog-architect/许式伟的架构课/04.服务端开发篇/08"><span>41 | 实战（一）：“画图”程序后端实战</span></a></li><li><a href="/blog-architect/许式伟的架构课/04.服务端开发篇/09"><span>42 | 实战（二）：“画图”程序后端实战</span></a></li><li><a href="/blog-architect/许式伟的架构课/04.服务端开发篇/10"><span>43 | 实战（三）：“画图”程序后端实战</span></a></li><li><a href="/blog-architect/许式伟的架构课/04.服务端开发篇/11"><span>44 | 实战（四）：“画图”程序后端实战</span></a></li><li><a href="/blog-architect/许式伟的架构课/04.服务端开发篇/12"><span>45 | 架构：怎么做详细设计？</span></a></li><li><a href="/blog-architect/许式伟的架构课/04.服务端开发篇/13"><span>46 | 服务端开发篇：回顾与总结</span></a></li><li><a href="/blog-architect/许式伟的架构课/04.服务端开发篇/14"><span>加餐 | 如何做HTTP服务的测试？</span></a></li></ul></li><li><a href="/blog-architect/许式伟的架构课/05.服务治理篇">05.服务治理篇</a><ul><li><a href="/blog-architect/许式伟的架构课/05.服务治理篇/01"><span>47 | 服务治理的宏观视角</span></a></li><li><a href="/blog-architect/许式伟的架构课/05.服务治理篇/02"><span>48 | 事务与工程：什么是工程师思维？</span></a></li><li><a href="/blog-architect/许式伟的架构课/05.服务治理篇/03"><span>49 | 发布、升级与版本管理</span></a></li><li><a href="/blog-architect/许式伟的架构课/05.服务治理篇/04"><span>50 | 日志、监控与报警</span></a></li><li><a href="/blog-architect/许式伟的架构课/05.服务治理篇/05"><span>加餐 | 怎么保障发布的效率与质量？</span></a></li><li><a href="/blog-architect/许式伟的架构课/05.服务治理篇/06"><span>51 | 故障域与故障预案</span></a></li><li><a href="/blog-architect/许式伟的架构课/05.服务治理篇/07"><span>52 | 故障排查与根因分析</span></a></li><li><a href="/blog-architect/许式伟的架构课/05.服务治理篇/08"><span>53 | 过载保护与容量规划</span></a></li><li><a href="/blog-architect/许式伟的架构课/05.服务治理篇/09"><span>54 | 业务的可支持性与持续运营</span></a></li><li><a href="/blog-architect/许式伟的架构课/05.服务治理篇/10"><span>55 | 云计算、容器革命与服务端的未来</span></a></li><li><a href="/blog-architect/许式伟的架构课/05.服务治理篇/11"><span>56 | 服务治理篇：回顾与总结</span></a></li></ul></li><li><a href="/blog-architect/许式伟的架构课/06.架构思维篇">06.架构思维篇</a><ul><li><a href="/blog-architect/许式伟的架构课/06.架构思维篇/01"><span>57 | 心性：架构师的修炼之道</span></a></li><li><a href="/blog-architect/许式伟的架构课/06.架构思维篇/02"><span>58 | 如何判断架构设计的优劣？</span></a></li><li><a href="/blog-architect/许式伟的架构课/06.架构思维篇/03"><span>59 | 少谈点框架，多谈点业务</span></a></li><li><a href="/blog-architect/许式伟的架构课/06.架构思维篇/04"><span>60 | 架构分解：边界，不断重新审视边界</span></a></li><li><a href="/blog-architect/许式伟的架构课/06.架构思维篇/05"><span>加餐 | 实战：“画图程序” 的整体架构</span></a></li><li><a href="/blog-architect/许式伟的架构课/06.架构思维篇/06"><span>61 | 全局性功能的架构设计</span></a></li><li><a href="/blog-architect/许式伟的架构课/06.架构思维篇/07"><span>62 | 重新认识开闭原则 (OCP)</span></a></li><li><a href="/blog-architect/许式伟的架构课/06.架构思维篇/08"><span>63 | 接口设计的准则</span></a></li><li><a href="/blog-architect/许式伟的架构课/06.架构思维篇/09"><span>64 | 不断完善的架构范式</span></a></li><li><a href="/blog-architect/许式伟的架构课/06.架构思维篇/10"><span>65 | 架构范式：文本处理</span></a></li><li><a href="/blog-architect/许式伟的架构课/06.架构思维篇/11"><span>66 | 架构老化与重构</span></a></li><li><a href="/blog-architect/许式伟的架构课/06.架构思维篇/12"><span>67 | 架构思维篇：回顾与总结</span></a></li></ul></li><li><a href="/blog-architect/许式伟的架构课/07.软件工程篇">07.软件工程篇</a><ul><li><a href="/blog-architect/许式伟的架构课/07.软件工程篇/01"><span>68 | 软件工程的宏观视角</span></a></li><li><a href="/blog-architect/许式伟的架构课/07.软件工程篇/02"><span>69 | 团队的共识管理</span></a></li><li><a href="/blog-architect/许式伟的架构课/07.软件工程篇/03"><span>70 | 怎么写设计文档？</span></a></li><li><a href="/blog-architect/许式伟的架构课/07.软件工程篇/04"><span>71 | 如何阅读别人的代码？</span></a></li><li><a href="/blog-architect/许式伟的架构课/07.软件工程篇/05"><span>72 | 发布单元与版本管理</span></a></li><li><a href="/blog-architect/许式伟的架构课/07.软件工程篇/06"><span>73 | 软件质量管理：单元测试、持续构建与发布</span></a></li><li><a href="/blog-architect/许式伟的架构课/07.软件工程篇/07"><span>74 | 开源、云服务与外包管理</span></a></li><li><a href="/blog-architect/许式伟的架构课/07.软件工程篇/08"><span>75 | 软件版本迭代的规划</span></a></li><li><a href="/blog-architect/许式伟的架构课/07.软件工程篇/09"><span>76 | 软件工程的未来</span></a></li><li><a href="/blog-architect/许式伟的架构课/07.软件工程篇/10"><span>77 | 软件工程篇：回顾与总结</span></a></li></ul></li><li><a href="/blog-architect/许式伟的架构课/08.结束语">08.结束语</a><ul><li><a href="/blog-architect/许式伟的架构课/08.结束语/01"><span>结束语 | 放下技术人的身段，用极限思维提升架构能力</span></a></li><li><a href="/blog-architect/许式伟的架构课/08.结束语/02"><span>结课问卷获奖用户名单</span></a></li><li><a href="/blog-architect/许式伟的架构课/08.结束语/03"><span>课程迭代 | 84讲音频重新交付</span></a></li></ul></li><li><a href="/blog-architect/许式伟的架构课/09.延展阅读">09.延展阅读</a><ul><li><a href="/blog-architect/许式伟的架构课/09.延展阅读/01"><span>热点观察 | 我看Facebook发币（上）：区块链、比特币与Libra币</span></a></li><li><a href="/blog-architect/许式伟的架构课/09.延展阅读/02"><span>热点观察 | 我看Facebook发币（下）：深入浅出理解 Libra 币</span></a></li><li><a href="/blog-architect/许式伟的架构课/09.延展阅读/03"><span>课外阅读 | 从《孙子兵法》看底层的自然法则</span></a></li><li><a href="/blog-architect/许式伟的架构课/09.延展阅读/04"><span>答疑解惑 | 想当架构师，我需要成为“全才”吗？</span></a></li><li><a href="/blog-architect/许式伟的架构课/09.延展阅读/05"><span>用户故事 | 站在更高的视角看架构</span></a></li></ul></li><li><a href="/blog-architect/许式伟的架构课/summary">许式伟的架构课</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="辅助界面元素的框架" data-depth="2"><a href="/blog-architect/许式伟的架构课/03.桌面开发篇/12#辅助界面元素的框架"><span>辅助界面元素的框架</span></a></li><li title="jQuery 颜色选择器" data-depth="2"><a href="/blog-architect/许式伟的架构课/03.桌面开发篇/12#jquery-颜色选择器"><span>jQuery 颜色选择器</span></a></li><li title="辅助界面元素的架构设计" data-depth="2"><a href="/blog-architect/许式伟的架构课/03.桌面开发篇/12#辅助界面元素的架构设计"><span>辅助界面元素的架构设计</span></a></li><li title="结语" data-depth="2"><a href="/blog-architect/许式伟的架构课/03.桌面开发篇/12#结语"><span>结语</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="31--辅助界面元素的架构设计"><a aria-hidden="true" tabindex="-1" href="/blog-architect/许式伟的架构课/03.桌面开发篇/12#31--辅助界面元素的架构设计"><span class="icon icon-link"></span></a>31 | 辅助界面元素的架构设计</h1><p>你好，我是七牛云许式伟。</p><p>我们第二章 “桌面软件开发” 今天开始进入尾声。前面我们主要围绕一个完整的桌面应用程序，从单机到 B/S 结构，我们的系统架构应该如何考虑。并且，我们通过五讲的 “画图” 程序实战，来验证我们的架构设计思路。</p><p>这个实战有点复杂。对于编码量不多的初学者，理解起来还是有点复杂性的。为了减轻理解的难度，我们从原计划的上下两讲，扩大到了五讲。尽管如此，理解上的难度仍然还是有的，后面我们做总结时，会给出一个不基于 MVC 架构的实现代码。</p><p>今天我们不谈桌面应用的架构，而是来谈谈辅助界面元素的架构设计。</p><p>辅助界面元素非常常见，它其实就是通用控件，或者我们自定义的控件。例如在我们画图程序中使用了线型选择控件（<a target="_blank" rel="noopener noreferrer" href="https://github.com/qiniu/qpaint/blob/v30/paintweb/www/accel/menu.js#L105">menu.js#L105<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>），如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">&lt;select id=&quot;lineWidth&quot; onchange=&quot;onIntPropChanged(&#x27;lineWidth&#x27;)&quot;&gt;</span></div><div class="token-line"><span class="token plain">      &lt;option value=&quot;1&quot;&gt;1&lt;/option&gt;</span></div><div class="token-line"><span class="token plain">      &lt;option value=&quot;3&quot;&gt;3&lt;/option&gt;</span></div><div class="token-line"><span class="token plain">      &lt;option value=&quot;5&quot;&gt;5&lt;/option&gt;</span></div><div class="token-line"><span class="token plain">      &lt;option value=&quot;7&quot;&gt;7&lt;/option&gt;</span></div><div class="token-line"><span class="token plain">      &lt;option value=&quot;9&quot;&gt;9&lt;/option&gt;</span></div><div class="token-line"><span class="token plain">      &lt;option value=&quot;11&quot;&gt;11&lt;/option&gt;</span></div><div class="token-line"><span class="token plain">    &lt;/select&gt;</span></div></pre></div><p>还有颜色选择控件（<a target="_blank" rel="noopener noreferrer" href="https://github.com/qiniu/qpaint/blob/v30/paintweb/www/accel/menu.js#L115">menu.js#L115<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>），如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">&lt;select id=&quot;lineColor&quot; onchange=&quot;onPropChanged(&#x27;lineColor&#x27;)&quot;&gt;</span></div><div class="token-line"><span class="token plain">      &lt;option value=&quot;black&quot;&gt;black&lt;/option&gt;</span></div><div class="token-line"><span class="token plain">      &lt;option value=&quot;red&quot;&gt;red&lt;/option&gt;</span></div><div class="token-line"><span class="token plain">      &lt;option value=&quot;blue&quot;&gt;blue&lt;/option&gt;</span></div><div class="token-line"><span class="token plain">      &lt;option value=&quot;green&quot;&gt;green&lt;/option&gt;</span></div><div class="token-line"><span class="token plain">      &lt;option value=&quot;yellow&quot;&gt;yellow&lt;/option&gt;</span></div><div class="token-line"><span class="token plain">      &lt;option value=&quot;gray&quot;&gt;gray&lt;/option&gt;</span></div><div class="token-line"><span class="token plain">    &lt;/select&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    &lt;select id=&quot;fillColor&quot; onchange=&quot;onPropChanged(&#x27;fillColor&#x27;)&quot;&gt;</span></div><div class="token-line"><span class="token plain">      &lt;option value=&quot;white&quot;&gt;white&lt;/option&gt;</span></div><div class="token-line"><span class="token plain">      &lt;option value=&quot;null&quot;&gt;transparent&lt;/option&gt;</span></div><div class="token-line"><span class="token plain">      &lt;option value=&quot;black&quot;&gt;black&lt;/option&gt;</span></div><div class="token-line"><span class="token plain">      &lt;option value=&quot;red&quot;&gt;red&lt;/option&gt;</span></div><div class="token-line"><span class="token plain">      &lt;option value=&quot;blue&quot;&gt;blue&lt;/option&gt;</span></div><div class="token-line"><span class="token plain">      &lt;option value=&quot;green&quot;&gt;green&lt;/option&gt;</span></div><div class="token-line"><span class="token plain">      &lt;option value=&quot;yellow&quot;&gt;yellow&lt;/option&gt;</span></div><div class="token-line"><span class="token plain">      &lt;option value=&quot;gray&quot;&gt;gray&lt;/option&gt;</span></div><div class="token-line"><span class="token plain">    &lt;/select&gt;</span></div></pre></div><p>我们统一用通用的 select 控件实现了一个线型选择器、两个颜色选择器的实例。虽然这种方式实现的颜色选择器不够美观，但是它们的确可以正常工作。</p><p>不过，产品经理很快就提出反对意见，说我们需要更加用户友好的界面。赶紧换一个更加可视化的颜色选择器吧？比如像下图这样的：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage654965ca44b08788bd03776bcd86ea3d0749.bd2e6b64.png" alt=""/></p><h2 id="辅助界面元素的框架"><a aria-hidden="true" tabindex="-1" href="/blog-architect/许式伟的架构课/03.桌面开发篇/12#辅助界面元素的框架"><span class="icon icon-link"></span></a>辅助界面元素的框架</h2><p>怎么做到？</p><p>我们不妨把上面基础版本的线型选择器、颜色选择器叫做 BaseLineWidthPicker、BaseColorPicker，我们总结它们在画图程序中的使用接口如下：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfoAAACmCAAAAAAXRRKtAAAAAmJLR0QA/4ePzL8AAAAHdElNRQfnCR0JLBvUc/VkAAAAAW9yTlQBz6J3mgAAGelJREFUeNrtnftD08gWx+9fckpLFYoFF0GFBRRQLusDWZRFAUWURQHFB4sPRBGFKsKyqMuKKPIQRa8VLcXKCgoCbRELpTTzB90zaZK20JaHdUs3+f6QpJmZdOZ8ksnMdDrnPyBJpPpPoDMgKVCS0ItWEnrRSkIvWnlAL0sEKC4GSFOyn1jhwZacQOcVFaIStB4/pv6mwK38TMr3/E5lwVbuSO44+HV5lqA25LR3D24SzqwPgMW8ywP6TGYbPH8Oe5h0/HCdsEqr3n2KCXReUTuJoJf48TRZDyVp68jZ7/mdYeOt3FH99G66MzxYIsW6D1Szs+xuHZ54/UFxJbmQRAfafG7yVOF3XqTor7TQ4/gL5NcWS5bq69k1gv78QYf6HOjDQmYufj/0W25TvWUa6S4RonTWtOLi4vE3uFnnI5m8iMpgYHdygBRStpMcWPvoDSMoq5VuDQCK/STh4pQiZM2gH3nHCe/MVg0ZPkEYhjB2e+73+LqUoaEhIxlyaDeEhF+WM1yl4xvjiN1uJwQ3I/RT2/T630jvW9L96NEPgbagU4vRX7h8uXfebG29fPnyBYBxR0Fr1gz6ita2x53PBz5O7wElU0fax5mKc+TR6dNbv/3innWOkXFHoU8r8VlQKAxtuPGd6NPD1NT+/tTUh5/wQz7pDhke7xsi2r6+NfTge6jwt/0xm/18YmzwYhx+2N9hy/vTkpu0RtDvIpl19TcNn84cyw6HBOYcyZl+Dt/3XV9tiaJS4WEDuUDPLPmuxygWi8Vuxw1WnD9Mka6jZBes/Qq/h/TtgHv3FIV6UgsQOf0MKqcAfoq+Yg90XlGHSOT41OjM3OgkiYQDRmzmXTv8ndF3Oeq9djyUNVbU6vV66zRuinylUZWghoboVgGpxqGuBLxb1j76nEzc3KrBzc+Y1Xx7Jov+xJhVF+i8okrmZePd1frR6j8QvTwZ0asbG5uJtrEx5jt9o2zqeTZqxNHKDy1paRmfbkHt95UougdlNvf06EkYQFJvV3RxUVEzOVtUlBFoCzq1CP36Jirr3+wOO6LYyY+52KSIKS9ZC/fspXGoqKboq6tpExvRx7x/P0SM798nfqdvTCB5dPeumW6TpnfBRmsNJBf6TLOngerz54aGHtKMXfrerky+S9oeaAs6tQh9+EvUF0I+0X04bHqA0pGHuD0X6Lyi2rR1VqvVzuDGqnT06+H7VvgaCzuy9aGObpstYVA7FwWX57f4SrOH7ROOjd2+3UOaWPQypVL5K9miVCqW853/jDz160NOzf/RPHuKbdjGPEYNkg7c/hbovGLz+utFjX779o7nNYOl5B9Bv4e5yu7NFbiJtDZBrAVbQOHTjT5TxT5DTU09e/aOVviInp5c++/62DI9aVXCb8ybsiiAuB9R1WQ73UUEOrOQSRI02vMfZsnXubMc+qzc3ALSkpub/l2+8KevOvY5zSbZuL1EUtb/j7nRqreSOZ8d9IjS0tKyz0O4LaXJgwT9xnnmxS/0IP0vm3UjWJwjpyTwNf5/X4NGm3QwWSUbmRgDFv0ol7nO7/F9Yeb3FHGvlbyidaD+DcQQy0Db1eOZc7VLJG02Eg1/HCTo4UAUfxSFd3piklPqQGcWQAkZBexB7kn6tt1WKldHRQn9bv9rF1vmpKOZcrpX4Hdy1sle6vtSTx4Sfq3JZ4ca40vX/M83ksQhCb1oJaEXrST0opWEXrSS0ItWEnrRSkIvWknoRSsO/QdJ4hJIT72IJaEXrST0opWEXrSS0ItWEnrRSkIvWknoRSsJvWgloRetggx9KfeH2rQs73FU59Yt72IiV3ChV3zg/vFU3bYoLOu/3EHqWHyg8xkUCi70gjygf3A10JkKMgUZ+hcZAGc/fa6i6Pdz/3s7qR3/PQp6LV9Gth5pOT9+PnpkPWgzu80tCQDrWsyD+c1HA53tNakgQ//pFzg6V5/ZM94GIbN/sKeSpzMTHzVD4tPmlNCTX57lxsaSMJgwlGf2PQa4N152eGCiLNDZXpMKPvT9LQAyIz71+2LZUxX/AwiNdlT4J60RACz6OoC9s8oI+2GAeCKh96TgQ/+1APd/Ot/1W0yDF2nVz6J/DRz6bGzpk9idDP3j1EcJvScFH3orXbCw0aWZt76811bJodcCh/5ngDASm0qi8MSYhN6Tgg+9gf6BdcS9hZ83rYAH1xejV9mO0nUxJPSeFHzoz5mLfqi1IPpGx1J5F/8XoaieBKjqj5QtRA+N5gsnBicl9J4UfOgVv9tsbRfaQPaxhj21rv3LdO8ugB/7mYRF6BU1g0/3vpTQe9Kq0ScU+w4/wK0VFf0rd6IgbkGMUucqh4vCfCrU8T91fiVDkHP/W/ewTk0itviVpsOrNg+fsa0Fi4Li5aqVLpWgLFvuELMsYdVZ9iL5jwvPLEbfx9jmh+u9rxdCfmJ3JYOyBQF7bUrEYq3Bw4tv4M87jrMZJoAkWjUbjjhOVDHz85Zn252Dsi5hfle1Pi/n4cTq14TgM5b398KQlEcQrg1b2dXUZOMyY55acgWTiDIX+/cRBlXoM+6j1AVnPaC/iHd0X4vX7+TQL1boLD7omezyek9rhLMUfckrFytW9eJDdMvkhuO7oQ8taesu/YZ1ab2il/fTRQUbVna1ZaOP1cqWipJA5M4PlNlScaP75e5nPaOH0wMAm5rHX5fjcUaHuT0NIKr9y8gZENDndsDmofQ3n69FCEE9VQC1tTNqkFv2Qu0FgH36qb9+MUG1yTpSAIai+6ZHaQ70oJrLYQdlCw2mpmTWwiH3GmXy2jFjkxKv+7Ohc/W4/ClDYZNpKI9Fn2zAzwefcLk7TzOoMKd5TqaoHTW3R4EwnsyVU03S+0y3owXTHmk5MTxIGyJZ76YepL/BG8phAOikD/0OrWVgH8QO43XWDSXD8fdfezYD1Jc2GHuyIHuMfNRAZL4bep9xobNiGegVuw34hn70IDV/Kh2Uk2VbLw/JZbrejPKpYwL64zqIZ57lHflUDnzQuT4A/a7uAtg5q4CWOthse5x555MJYq7pU9Rg+HB590M9hz6ayaJNtpw5za47HxUUfbN2PdR/KMg1tOB135RsDzR0Dv3YvYz79lSKPm2WItRzuesrocGtVZ6TaSbO5OrwjciPJ3PlVJOXxdl6jWDak8bHGWdtyRA335bRMIzVI2cAuQ1fzNGzDek3bVthEBtVBz/Lcr5W7OkcDoHW8Ru7Gs0hEblk52aoJDGu6H3GhZN9S6JnbAxpwAonGiuIptuQZsU3Wowi04ZV9I03bujJL0jyOfBB262KqGn5mRY43wMUfe1HjNcmVPh38W4nW1j0sS1mFUWvxXOyqiREf31QBWFYFUC2PTye+Pg1/h9GT831usUNPZu7CTaLNX95TBVmw9duNMbjxpP5cqpJEV5iTDDtyfkNAC8uQd0QvY1MLgbAJ/8aVrzwthYqn7DG1OKlImwHoBVfqErrbkclrub8cfTZZlDRPuNC1uSS6DUJCYe79DKQpV+5Y2gF2dvJunSAM0aNRvPkqzt6vClyPglBMuNPhR2QMA5PzrE56Pgd4xUL6GkrxJQJVTajkTFnsh216QLOwloGm9LJpEGjuUNS4klooJEL6Ctxc/W1O3rMXTjZRoNP6T2mSmaXSfv7LD+ezJdTTR/SROTAmfYkbRfVt0DXbXppk2CAnCn83KFDqw50wBbruhDzDpjuwI+ms9B6E8P0xxe86xvTUArfcZOI+6pfXt71ause0A7Vlne14u2a/9dMJ1SMnadyR4/dqV8+OYNaK+/jm2ts25ftLPqeeox3xK2ZZ0T0un37dtDFRxH9zCHOwnrdA4A0ppJeJ4a97tqQgTZ2KnUC+mN6R6nVJIkGl733mCqNoUbWVQrDC1w52WYe5cCZlh2GqGuBTrr2ZpFJMECeGT9399Fj7Je+PrR7BMDaTD+mQ2sNvfRxL808X3ETSeRy0KushSlzmP8njgWho+fScm20ODJP6IWgop7JeIDmu0YZi75hEE83U/T9ruh7uS9C9HraAzwQi2FbpstAzWSx11lL6LEGhd42in4LwZ5CA4cexg/S4PpWj6nUDIZGMHkCeq6cPHretDz62mFg34y8AeLo83mLGo1atfxu3VWAd9cdn5w4lR7Q+4qbM+GeSw/ob27efKDdsinSdmDdMWsr7DImyvYzCcrPLdFRndhEIUfiUK7ohaBNzCheIJ/5E1j0O5grUSWfEf2e2XiZR/QnzOnK4i8RNCx3LhUealPDqnTytYTedC6qYi6L7dx9uKE+OMqj72aby10VnpO1DWTEt31WCui5cvLoedPy6GPneg7d/xsNxRlANoM9h21M+fqkT3gPbTSOYhVTNnlQkWOKEXAqrUdDIL3N8Wrsq6NMwnzGhYruJdETQkZv7QT4bdLWWY239bXPFh22HFMM9i8P8O5hlyVlXNELQTDUhJsNTJEDPZRamIFDWKKQTmuJR/SyKzN27SFHjaD5qFJ32mefJ66pp/7YS2b2gqNfn2dg9CU8+pr7NHjUS3tU/XieGcROK4+eK6dQ4XOm5dFDWs87TRYaijMAvKZDoAUm+yjbg3j+Dmi/zzo/kOt8krHL/ACKpyMFZoQU+owL92qWQu+UjB+sCnfsVN7HGbwEyfiGhdxbUpl700OphBVo+QOj35BMFSIchjvPxk9jryZr2Os9GrpgIdUF5ZS5jQNuoF3/s0NOAxT1O867pQlZeEm5y2D2AnmIq55eMFs1yH6+cdfyB0b9kcxddZfxEfOT18co85WM85MXnCdkut3+ubKLLtUtOCGhX6VUbxXbuvxVkNTal5oM1yf4p9ZVX8uLFG8XLugcXOjzaTthl14eUmMYqVGzDN9vA/hhBOtPbvBym+N54QeZncOvuwfHytRPzPc2Y7LUnulXtHfGD3ievv91Z6DL9o8ruNBHzm/F9mArlL/bm/GmkkVvRWYx2BniBy97PrIx+UFm5/BrV9ZZRleWqa/FZO+vZL8yKoU0rVO///x9FlVfywou9PD0LNszUK/HBrDBDT0/eJngcIfBDzI7x+D2AOixMV3yHpNV0cHW484Bz/5AlysQCjL0RS9h+xdsVsdV3OqdcEPPD15y4geZ3YZf6Y1zYIz+gIYnX9U4BzxrAl2uQCjI0Ktm1ZebAa4ZG8/Xu6PnBy858WMObsOvvec49PR3wZ469wFP0SnI0MOjIl0myM1ZAOcc6MeOAOQhen7wkhOP3m34VUCPT79itsx9wFN0Cjb0+brJEICBq8qMYQf6pt4tac8RPT94WeL416Uw0ug6/CqgN+TGNM+o3Qc8RadgQ6+03MLtfoN96JgD/fZeZvIgoucHL+9p2XgCetfhVwH9nk9kMmvBgKfoFGzoebn0xfjhVW7wctHYZrin9Bvc0ohSwYpe0jdLQi9aSehFKwm9aCWhF60k9KKVhF60ktCLVhJ60UpCL1px6NMliUsgPfUiloRetJLQi1YSetFKQi9aSehFKwm9aCWhF60k9KKVhF60CjL0krMz/ym40EvOzvyo4EIvSHJ29u0KMvSSszP/KcjQS87O/KfgQy85O/OTgg+95OzMTwo+9JKzMz8p+NBLzs78pOBDLzk785OCD73k7MxPCjL0rP5BZ2f/ZgUj+hXoW52d/Zv1L0f/rc7O/s36l6OX5F0SetFKQi9aSehFKwm9aCWhF60k9KKVhF60Wg16WVycqyt0777D+PmzqIK475B5317Llp1NH+KzvbVgUVC8XBXt1/y65T3Bf1ZySP7jwjMePVnPD9d7HwGTnZ8xWkwlzhOLHEhVMfPzlmfbnfNngXNr6m/5cl21dDaXIz7b1MWhu1IeQbg2bGVXW34WTp1bKkZEmcs60H2EQRX6jPsodcFZzz5t4/tavH7nxY+pIN83e8Z7gaj/yq23TG4j5/84+qWzuRx5RS/vx0c+v8F/+XVTrFa2VBTP7ox9xI3ul7uf9eLO+PQAwKbm8dfUkXNGh7k9DSCq/csIGlI1k0djHb4BsOOVxXDcUSBF7ai5PYpzG8a6LlXN5bDzZwsNpqZk1oYh9xplvHsxbc6L6ZWDWIGzM5dsRj00j9UqHHY/ZrBod67Au5mhsMk0lMeid7pN+9nQCec78ZPCnOY5GW8OfmIwZwU1Se8z3Y4WTHuk5cTwIP1FOevd1IP0N3SB/jFjkxKgkz70O7SWgX0QO4zXWTeULDhmK20w9mRB9hj5qIHIfDf0PuNC5wIHvB7RK3YbfsUa4kFq/lQ6KCfLtl4ekst0vRnlU8cgTfCgHG1t31dnzWVtqpk4k6sblDnchrHoo5ks+ut6zpxm152PCoq+WbtecC828bFqzyrQL9/ZmTObMr0ut3z8Nhv5kLVuX7t10/K9mxnG7mXct6e6+a9n3pRshz72VdJa5TkZbw5+YjBnBTV5WZyt1wimPWl8nHHWlgxx820ZDcMmZPWhINfQAnIbvpijZxvSb9q2wmAx3nGfZYJjtvEbuxrNIRG5ZOdmqCQxruh9xoWTfUuiZ2wMacAKJxoriKbbkGbFRypGkWnDCvzGGzhs5iPWjODm935q0zAbvmeiSZbDbRhFH9tiVlH02rto/KokRH99EI3NuxebuL4K8LACZ2fObP5MNmFkWziNrG3GE8PXl+/dzEDN9brFDT2hf/qaYP/5VfOXx1SCObiJwbwV1KQILzEmmPbk/AaAF5egjrqzbTVBGNaUkG0Pj6f37TWseOFtLVQ+YX1DC47ZdNhctO52VOJqzrNqn20GFe0zLmRNLolek5BwuEsvA1n6lTuGVpC9naxDc54xajSaJ19hv5WP2PE7bo5YKIBkQhu7f3Nuw6psRiNjzmQhTRdwNtQytLHMuxeb8PGfOV9atrMzZzbPUOfwG0kqjczmpvHJ8j2eGCpxc/W1O/pQgHCyjQaf0ntMJZiDmxjMW0FNH9JE5MCZ9iSigfoW6LpNL23CdA0azR2SkjNFzavDAg10wBbruhDzDqdjtpsYpj++4F3fmIZS+I6bRNwrOi/verV1D2iHasu7WvF2zf9rphMqxqhjsPN4mVguYjf1j5ttlaFN0xh6VV0lh163b98OWt8i+plDnA31uge4492L0QlUq9GynZ05s1lBnx4V818aeZY+JTd7VoCeNnYqdQJ63m2amlC/qFD23mMqwRz8PDHOCoITc860vBPzzkbcF5kwXSUtREwerbK6++jxYax0Du0eAXfHbLrjXpp5vuImksjloFdZC1PmMP9PHG51o+fScm20ODII+cDW1bVP4Ra95evYalfNHMQqhsnj0Lt4qNffwf2BWKzwt0xjg4Z3L7Za9Mt2dubMZi6DtWoOUdPI7+hs3oGGFaDHGhR62yh6N7dpMH6QBtd79josmINHz1mBR8+blkdfSyumNhOmy2ILEUefz1vsSwlLVH637iq4O2Zjcbr4exfQ+4qbM+GeSw/ob27efKDdsinSdmDdMWsr7DImyvYzCcrPLdFRnWi6I/bTYRtPM0WQZK+KKjKWsQDaBjLi2z4rF6M/YU5XFn+JoM283LlUwb3YqtEv19mZM5uhY23xe3UP2cilpqKoKvu2FaA3nYuqmMtiO3eubtOgm20ud1V4Tsabg0fPWYFHz5uWRx8713Po/t/YzHuoTQ2r0sllM9hz2MaUr0/6hPfQRuMoVjFujtkQp9J6NATS20IdzOriUGE+40JF95LoCSGjt7Aa/W3S1lmNt/W1zxYdthxTDPYvD+jdUzBlZ76coRgmyWyNnLWp+vE8M5gMi9HLrszYtYccHWTNRxXvXmzV6Jfr7Mwlm8l6Zr7D0RMMqZkhxiMr8G5mOPaSmb3g6Ne7uk2Dmvs0eNRLk4U3B4+es4JQ4XOm5dFDWs87TRaiV3faZ58nYr39Ky2AyT7K9iCev4MFjtkQJ1SbHkDxdKTAjJBCn3Hh3oJC+xrIlfGDVZy7MBVXn8q2JnCTX9XOGjbUW2dJ5h7gJ/diy3B25symKtSZmxVP0VSFLPomVPw0XihrWOEt1UJzLLCCzG0ccAPt+p+lzXxQstV4kaMHssGn5WRyD57dvMdVTy9YdkD6+WaVqruMj1iOf64VZb6ScX7ygvOETLfb7xm+VLfghIR+lVK9VWzr8tfFUmtfajJcn+CfWld9LS9SvF1Y3UroRSsJvWgloRetJPSilYRetJLQi1YSetFKQi9aBTn6VU30lRbRZRXk6F1me7LTTpNyvceVFtF1178HPTsfoeSV97jSIrruCjL02vS75nf0B9+iF8bmJAd6x/RTdtpptck6UiDMa/WwiC47ndZ1EV2oGB2rLr4d6HIFQkGGfuJ94772+ThImc7fcf8pi56bfspOO425pk9R8/NaPS2iy06ndV1Et8h6I7NzrO3bchWcCjb07bj5UAdhGwB+YKIoemEqLl/h8/NaPS2iy06ndVlEF3R0Wty4hH7ta4JOf2/oBlAX190l8RQ9P/1UQM/Pa+XTuC6iy06ndVlEF2Zou/APCf3a1wRd2r62F/Zb2irLHOj56acCen5eq5DIZRFddnaV65qKFrqm3j0J/drXxF3cYCXdUYN9NAd6fvopO+20pB+Eea2u4hfRXYS+v5lbYl18Cjb0prKoy0wa1PeqErsd6Pnpp+y00z2z8TJ+XqunRXQXoT9sa8p9OSKhX/uaKNYzljJ8f/fZzAfnWPT89FN22mlIp7WEn9fqaRHdReihSNtfWi2hX/tCYty84HCXv1tws87oFFWQ0/OOea3LWUQ3hjYJnjQGulyBUPCh96/2TRdnXrf5f/5rECjI0Jdt9vcVc35/cSkp0MUKiIIMvST/SUIvWknoRSsJvWgloRetJPSilYRetJLQi1Yc+nRJ4hJIT72IJaEXrST0opWEXrSS0ItW/weEJgtlBKI72gAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAyMy0wOS0yOVQwOTo0NDoyNyswMDowMFvFKJUAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMjMtMDktMjlUMDk6NDQ6MjcrMDA6MDAqmJApAAAAKHRFWHRkYXRlOnRpbWVzdGFtcAAyMDIzLTA5LTI5VDA5OjQ0OjI3KzAwOjAwfY2x9gAAAABJRU5ErkJggg==" alt=""/></p><p>我们解释一下这个表格中的各项内容。</p><p>id 是控件的 id，通过它可以获取到辅助界面元素的顶层结点。</p><p>value 是界面元素的值，其实也就是辅助界面元素的 Model 层的数据。从 MVC 架构角度来说，Model 层的数据一般是一棵 DOM 树。但是对很多辅助界面元素来说，它的 DOM 树比较简单，只是一个数值。比如线型选择器是一个 number，颜色选择器是一个 Color 值。</p><p>palette 是颜色选择器的调色板，用来指示颜色选择器可以选择哪些颜色。</p><p>blur() 方法是主动让一个界面元素失去焦点。</p><p>onchange 事件是在该界面元素的值（value）通过用户界面交互进行改变时发送的事件。需要注意的是，这个事件只在用户交互时发送。直接调用 element.value = xxx 这样的方式来修改界面元素的值是不会触发 onchange 事件的。</p><p>为了便于修改辅助界面元素，我们计划引入统一的辅助界面元素的框架。</p><p>这个框架长什么样？</p><p>首先，每个界面元素使用的时候，统一以 <code>&lt;div type=&quot;xxx&quot;&gt;</code>来表示。比如上面的一个线型选择器、两个颜色选择器的实例可以这样来表示：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">&lt;div type=&quot;BaseLineWidthPicker&quot; id=&quot;lineWidth&quot; onchange=&quot;onIntPropChanged(&#x27;lineWidth&#x27;)&quot;&gt;&lt;/div&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    &lt;div type=&quot;BaseColorPicker&quot; id=&quot;lineColor&quot; onchange=&quot;onPropChanged(&#x27;lineColor&#x27;)&quot; palette=&quot;black,red,blue,green,yellow,gray&quot;&gt;&lt;/div&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    &lt;div type=&quot;BaseColorPicker&quot; id=&quot;fillColor&quot; onchange=&quot;onPropChanged(&#x27;fillColor&#x27;)&quot; palette=&quot;white,null(transparent),black,red,blue,green,yellow,gray&quot;&gt;&lt;/div&gt;</span></div></pre></div><p>那么它是怎么被替换成前面的界面元素的？</p><p>我们引入一个全局的 qcontrols: QControls 实例，所有我们定义的控件都向它注册（register）自己。注册的代码如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">class QControls {</span></div><div class="token-line"><span class="token plain">      constructor() {</span></div><div class="token-line"><span class="token plain">        this.data = {}</span></div><div class="token-line"><span class="token plain">      }</span></div><div class="token-line"><span class="token plain">      register(type, control) {</span></div><div class="token-line"><span class="token plain">        this.data[type] = control</span></div><div class="token-line"><span class="token plain">      }</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>可以看出，注册的逻辑基本上没做什么，只是建立了类型（type）和控件的构建函数（control）的关联。有了这个关联表，我们就可以在适当的时候，把所有的 <code>&lt;div type=&quot;xxx&quot;&gt;</code>的div 替换为实际的控件。替换过程如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">class QControls {</span></div><div class="token-line"><span class="token plain">      init() {</span></div><div class="token-line"><span class="token plain">        let divs = document.getElementsByTagName(&quot;div&quot;)</span></div><div class="token-line"><span class="token plain">        let n = divs.length</span></div><div class="token-line"><span class="token plain">        for (let i = n-1; i &gt;= 0; i--) {</span></div><div class="token-line"><span class="token plain">          let div = divs[i]</span></div><div class="token-line"><span class="token plain">          let type = div.getAttribute(&quot;type&quot;)</span></div><div class="token-line"><span class="token plain">          if (type != null) {</span></div><div class="token-line"><span class="token plain">            let control = this.data[type]</span></div><div class="token-line"><span class="token plain">            if (control) {</span></div><div class="token-line"><span class="token plain">              control(div)</span></div><div class="token-line"><span class="token plain">            }</span></div><div class="token-line"><span class="token plain">          }</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">      }</span></div><div class="token-line"><span class="token plain">    }</span></div></pre></div><p>这段代码逻辑很简单，遍历文档中所有的 div，如果带 type 属性，就去查这个 type 有没有注册过，注册过就用注册时指定的构建函数去构建控件实例。</p><p>完整的辅助界面元素框架代码如下：</p><ul><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/qiniu/qpaint/blob/v31/paintweb/www/controls/base.js">controls/base.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><p>具体构建控件的代码是怎么样的？源代码请参考这两个文件：</p><ul><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/qiniu/qpaint/blob/v31/paintweb/www/controls/BaseLineWidthPicker.js">controls/BaseLineWidthPicker.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/qiniu/qpaint/blob/v31/paintweb/www/controls/BaseColorPicker.js">controls/BaseColorPicker.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><p>我们拿 BaseColorPicker 作为例子看下吧：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">function BaseColorPicker(div) {</span></div><div class="token-line"><span class="token plain">      let id = div.id</span></div><div class="token-line"><span class="token plain">      let onchange = div.onchange</span></div><div class="token-line"><span class="token plain">      let palette = div.getAttribute(&quot;palette&quot;)</span></div><div class="token-line"><span class="token plain">      let colors = palette.split(&quot;,&quot;)</span></div><div class="token-line"><span class="token plain">      let options = []</span></div><div class="token-line"><span class="token plain">      for (let i in colors) {</span></div><div class="token-line"><span class="token plain">        let color = colors[i]</span></div><div class="token-line"><span class="token plain">        let n = color.length</span></div><div class="token-line"><span class="token plain">        if (color.charAt(n-1) == &quot;)&quot;) {</span></div><div class="token-line"><span class="token plain">          let offset = color.indexOf(&quot;(&quot;)</span></div><div class="token-line"><span class="token plain">          options.push(`&lt;option value=&quot;` + color.substring(0, offset) + `&quot;&gt;` + color.substring(offset+1, n-1) + `&lt;/option&gt;`)</span></div><div class="token-line"><span class="token plain">        } else {</span></div><div class="token-line"><span class="token plain">          options.push(`&lt;option value=&quot;` + color + `&quot;&gt;` + color + `&lt;/option&gt;`)</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">      }</span></div><div class="token-line"><span class="token plain">      div.outerHTML = `&lt;select id=&quot;` + id + `&quot;&gt;` + options.join(&quot;&quot;) + `&lt;/select&gt;`</span></div><div class="token-line"><span class="token plain">      let elem = document.getElementById(id)</span></div><div class="token-line"><span class="token plain">      if (onchange) {</span></div><div class="token-line"><span class="token plain">        elem.onchange = onchange</span></div><div class="token-line"><span class="token plain">      }</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    qcontrols.register(&quot;BaseColorPicker&quot;, BaseColorPicker)</span></div></pre></div><p>可以看到，构建函数的代码大体分为如下三步。</p><p>第一步，从占位的 div 元素中读入所有的输入参数。这里是 id, onchange, palette。</p><p>第二步，把占位的 div 元素替换为实际的界面。也就是 div.outerHTML = <code>xxx</code> 这段代码。</p><p>第三步，如果用户对 onchange 事件感兴趣，把 onchange 响应函数安装到实际界面的 onchange 事件中。</p><h2 id="jquery-颜色选择器"><a aria-hidden="true" tabindex="-1" href="/blog-architect/许式伟的架构课/03.桌面开发篇/12#jquery-颜色选择器"><span class="icon icon-link"></span></a>jQuery 颜色选择器</h2><p>接下来我们就开始考虑替换颜色选择器的实现了。新版本的颜色选择器，我们不妨命名为 ColorPicker。这个新版本的使用姿势必须和 BaseColorPicker 一样，也就是：</p><p><img src="data:image/png;base64,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" alt=""/></p><p>从使用的角度来说，我们只需要把之前的 BaseColorPicker 换成 ColorPicker。如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">&lt;div type=&quot;BaseLineWidthPicker&quot; id=&quot;lineWidth&quot; onchange=&quot;onIntPropChanged(&#x27;lineWidth&#x27;)&quot;&gt;&lt;/div&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    &lt;div type=&quot;ColorPicker&quot; id=&quot;lineColor&quot; onchange=&quot;onPropChanged(&#x27;lineColor&#x27;)&quot; palette=&quot;black,red,blue,green,yellow,gray&quot;&gt;&lt;/div&gt;</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    &lt;div type=&quot;ColorPicker&quot; id=&quot;fillColor&quot; onchange=&quot;onPropChanged(&#x27;fillColor&#x27;)&quot; palette=&quot;white,null(transparent),black,red,blue,green,yellow,gray&quot;&gt;&lt;/div&gt;</span></div></pre></div><p>那么实现方面呢？</p><p>我们决定基于 jQuery 社区的 <a target="_blank" rel="noopener noreferrer" href="https://github.com/bgrins/spectrum">spectrum<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 颜色选择器。</p><p>我们的画图程序的主体并没有引用任何现成的框架代码。jQuery 是第一个被引入的。</p><p>对待 jQuery，我们可以有两种态度。一种是认为 jQuery 设计非常优良，我们很喜欢，决定将其作为团队的编程用的基础框架。</p><p>在这种态度下，我们允许 jQuery 风格的代码蔓延得到处都是，典型表现就是满屏皆是 $ 符号。</p><p>当然这种选择的风险是不低的。有一天我们不想再基于 jQuery 开发了，这意味着大量的模块需要进行调整，尤其是那些活跃的项目。</p><p>另一种态度是，认为 jQuery 并不是我们的主体框架，只是因为我们有些模块用了社区的成果，比如 <a target="_blank" rel="noopener noreferrer" href="https://github.com/bgrins/spectrum">spectrum<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 颜色选择器，它是基于 jQuery 实现的。这意味着我们要用 <a target="_blank" rel="noopener noreferrer" href="https://github.com/bgrins/spectrum">spectrum<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，就需要引入 jQuery。</p><p>这种团队下，我们会尽可能限制 jQuery 的使用范围，尽量不要让它的代码蔓延，而只是限制在颜色选择器等少量场景中。</p><p>我们这一讲假设我们的态度是后者。我们有自己的基础开发框架（虽然我们其实基本上接近裸写 JavaScript 的状态），所以不会大面积使用 jQuery。</p><p>这样我们需要包装 jQuery 组件。代码如下（参阅 <a target="_blank" rel="noopener noreferrer" href="https://github.com/qiniu/qpaint/blob/v31/paintweb/www/controls/ColorPicker.js">controls/ColorPicker.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">function ColorPicker(div) {</span></div><div class="token-line"><span class="token plain">      let id = div.id</span></div><div class="token-line"><span class="token plain">      let onchange = div.onchange</span></div><div class="token-line"><span class="token plain">      let palette = div.getAttribute(&quot;palette&quot;)</span></div><div class="token-line"><span class="token plain">      let colors = palette.split(&quot;,&quot;)</span></div><div class="token-line"><span class="token plain">      let value = colors[0]</span></div><div class="token-line"><span class="token plain">      div.outerHTML = `&lt;input type=&quot;button&quot; id=&quot;` + id + `&quot; value=&quot;` + value + `&quot;&gt;`</span></div><div class="token-line"><span class="token plain">      let elem = $(&quot;#&quot; + id)</span></div><div class="token-line"><span class="token plain">      elem.spectrum({</span></div><div class="token-line"><span class="token plain">        showInitial: true,</span></div><div class="token-line"><span class="token plain">        showInput: true,</span></div><div class="token-line"><span class="token plain">        showButtons: true,</span></div><div class="token-line"><span class="token plain">        preferredFormat: &quot;hex6&quot;</span></div><div class="token-line"><span class="token plain">      })</span></div><div class="token-line"><span class="token plain">      if (onchange) {</span></div><div class="token-line"><span class="token plain">        elem.change(onchange)</span></div><div class="token-line"><span class="token plain">      }</span></div><div class="token-line"><span class="token plain">      Object.defineProperty(document.getElementById(id), &quot;value&quot;, {</span></div><div class="token-line"><span class="token plain">        get() {</span></div><div class="token-line"><span class="token plain">          return value</span></div><div class="token-line"><span class="token plain">        },</span></div><div class="token-line"><span class="token plain">        set(x) {</span></div><div class="token-line"><span class="token plain">          if (this.busy) {</span></div><div class="token-line"><span class="token plain">            return</span></div><div class="token-line"><span class="token plain">          }</span></div><div class="token-line"><span class="token plain">          value = x</span></div><div class="token-line"><span class="token plain">          this.busy = true</span></div><div class="token-line"><span class="token plain">          elem.spectrum(&quot;set&quot;, value)</span></div><div class="token-line"><span class="token plain">          this.busy = false</span></div><div class="token-line"><span class="token plain">        }</span></div><div class="token-line"><span class="token plain">      })</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    qcontrols.register(&quot;ColorPicker&quot;, ColorPicker)</span></div></pre></div><p>这里大部分代码比较常规，只有 Object.defineProperty 这一段看起来比较古怪一些。这段代码是在改写 document.getElementById(id) 这个界面元素的 value 属性的读写（get/set）函数。</p><p>为什么需要改写？</p><p>因为我们希望感知到使用者对 value 的改写。正常我们可能认为接管 onchange 就可以了，但是实际上 element.value = xxx 这样的属性改写是不会触发 onchange 事件的。所以我们只能从改写 value 属性的 set 函数来做。</p><p>set 函数收到 value 被改写后，会调用 elem.spectrum(&quot;set&quot;, value) 来改变 spectrum 颜色控件的当前值。</p><p>但这里又有个细节问题：elem.spectrum(&quot;set&quot;, value) 内部又会调用 element.value = value 来修改 document.getElementById(id) 这个界面元素的 value 属性，这样就出现了死循环。怎么办？我们通过引入一个 busy 标志来解决：如果当前已经处于 value 属性的 set 函数，就直接返回。</p><h2 id="辅助界面元素的架构设计"><a aria-hidden="true" tabindex="-1" href="/blog-architect/许式伟的架构课/03.桌面开发篇/12#辅助界面元素的架构设计"><span class="icon icon-link"></span></a>辅助界面元素的架构设计</h2><p>到目前为止，我们实现了三个符合我们定义的控件规范的辅助界面元素。如下：</p><ul><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/qiniu/qpaint/blob/v31/paintweb/www/controls/BaseLineWidthPicker.js">controls/BaseLineWidthPicker.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/qiniu/qpaint/blob/v31/paintweb/www/controls/BaseColorPicker.js">controls/BaseColorPicker.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/qiniu/qpaint/blob/v31/paintweb/www/controls/ColorPicker.js">controls/ColorPicker.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><p>观察这些辅助界面元素的代码，你会发现它们都没有基于 MVC 架构。</p><p>是因为辅助界面元素不适合用 MVC 架构来编写么？</p><p>当然不是。</p><p>更本质的原因是因为它们规模太小了。这些界面元素的特点是 DOM 都是一个 value，并不是一棵树，这样 Model 层就没什么代码了。同样的逻辑，View 层、Control 层代码量都过于短小，就没必要有那么清楚的模块划分。View 负责界面呈现，Control 负责事件响应，只是在心里有谱就好了。</p><p>但并不是所有辅助界面元素都这么简单。</p><p>举一个简单的例子。让我们给自己设定一个新目标：把我们前面实战的 “画图” 程序，改造成一个标准的辅助界面元素，这可行么？</p><p>答案当然是肯定的。</p><p>但是这意味着我们有一些假设需要修正。这些假设通常都和唯一性有关。</p><p>比如，全局有唯一的 View 对象实例 qview: QPaintView。如果我们是辅助界面元素，意味着我们可能在同一个界面出现多个实例。在多实例的情况下，View 对象显然就应该有多个。</p><p>再比如，我们画图程序的辅助界面元素（参见 <a target="_blank" rel="noopener noreferrer" href="https://github.com/qiniu/qpaint/blob/v31/paintweb/www/accel/menu.js">accel/menu.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）都是单例，具体表现为这些界面元素的 id 都是固定的。</p><p>当然，辅助界面元素的改造方案有多种可能性。一种方案是将辅助界面元素也改造为多例，使得每个 QPaint 实例都有自己的辅助界面元素。</p><p>另一种方案是继续保持单例，这意味着多个 QPaint 实例会有一个当前实例的概念。辅助界面元素根据场景，可以是操作全部实例，也可以是操作当前实例。</p><p>我们选择继续保持单例。这意味着 qview: QPaintView 这个全局变量可以继续存在，但是和之前的含义有了很大不同。之前 qview 代表的是单例，现在 qview 代表的是当前实例。</p><p>有了当前实例当然就有切换。这样就需要增加焦点相关的事件响应。</p><p>在画图程序中，很多 Controller 都是 View 实例相关的。比如：PathCreator、ShapeSelector 等。在 View 存在多例的情况下，这些 Controller 之前的 registerController 动作就需要重新考虑。</p><p>为了支持多例，我们引入了 onViewAdded、onCurrentViewChanged 事件。当一个新的 View 实例被创建时，会发送 onViewAdded 事件。Controller 可以响应该事件去完成 registerController 动作。如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">onViewAdded(function(view) {</span></div><div class="token-line"><span class="token plain">      view.registerController(&quot;PathCreator&quot;, function() {</span></div><div class="token-line"><span class="token plain">        return new QPathCreator(view, false)</span></div><div class="token-line"><span class="token plain">      })</span></div><div class="token-line"><span class="token plain">    })</span></div></pre></div><p>原先，当前图形样式是放在 View 中的，通过 qview.style 可以访问到。这会导致多个 View 实例的当前图形样式不一样，但是我们辅助界面元素又是单例的，这就非常让人混淆。最后我们决定把 qview.style 挪到全局，改名叫 defaultStyle（参阅 <a target="_blank" rel="noopener noreferrer" href="https://github.com/qiniu/qpaint/blob/v31/paintweb/www/accel/menu.js#L42">accel/menu.js#L42<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）。</p><p>做完这些改造，我们的画图程序就有了成为一个标准控件的基础。具体代码如下（参阅 <a target="_blank" rel="noopener noreferrer" href="https://github.com/qiniu/qpaint/blob/v31/paintweb/www/PaintView.js">PaintView.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）：</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">function newPaintView(drawingID) {</span></div><div class="token-line"><span class="token plain">      let view = new QPaintView(drawingID)</span></div><div class="token-line"><span class="token plain">      fireViewAdded(view)</span></div><div class="token-line"><span class="token plain">      return view</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    function initPaintView(drawingID) {</span></div><div class="token-line"><span class="token plain">      let view = newPaintView(drawingID)</span></div><div class="token-line"><span class="token plain">      setCurrentView(view)</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    function PaintView(div) {</span></div><div class="token-line"><span class="token plain">      let id = div.id</span></div><div class="token-line"><span class="token plain">      let width = div.getAttribute(&quot;width&quot;)</span></div><div class="token-line"><span class="token plain">      let height = div.getAttribute(&quot;height&quot;)</span></div><div class="token-line"><span class="token plain">      div.outerHTML = `&lt;canvas id=&quot;` + id + `&quot; width=&quot;` + width + `&quot; height=&quot;` + height + `&quot;&gt;你的浏览器不支持Canvas！&lt;/canvas&gt;`</span></div><div class="token-line"><span class="token plain">      initPaintView(id)</span></div><div class="token-line"><span class="token plain">    }</span></div><div class="token-line"><span class="token plain">    </span></div><div class="token-line"><span class="token plain">    qcontrols.register(&quot;PaintView&quot;, PaintView)</span></div></pre></div><p>有了这个 PaintView 控件，我们就可以到处引用它了。我们做了一个 PaintView 控件的 DEMO 程序，它效果看起来是这样的（代码参阅 <a target="_blank" rel="noopener noreferrer" href="https://github.com/qiniu/qpaint/blob/v31/paintweb/www/PaintDemo.htm">PaintDemo.htm<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）：</p><p><img src="/blog-architect/static/httpsstatic001geekbangorgresourceimage2952295e17f40fa63b929a4a5175da39ae52.43595b4f.png" alt=""/></p><p>从这个截图看，细心的你可能会留意到，还有一个问题是没有被修改的，那就是 URL 地址。我们的 QPaintView 在 load 文档后会修改 URL，这作为应用程序并没有问题。但是如果是一个控件，整个界面有好多个 PaintView，URL 中应该显示哪个文档的 ID？</p><p>显然谁都不合适。如果非要显示，可能要在 PaintView 实例附近放一个辅助界面元素来显示它。</p><p>怎么修改？</p><p>这个问题暂且留给大家。</p><h2 id="结语"><a aria-hidden="true" tabindex="-1" href="/blog-architect/许式伟的架构课/03.桌面开发篇/12#结语"><span class="icon icon-link"></span></a>结语</h2><p>今天探讨了辅助界面元素，或者叫控件的架构设计。从大的实现逻辑来说，它和应用程序不应该有本质的不同。但控件总是要考虑支持多实例，这会带来一些细节上的差异。</p><p>支持多实例听起来是一项简单的工作，但是从我的观察看，对很多工程师来说实际上并不简单。不少初级工程师写代码往往容易全局变量满天飞，模块之间相互传递信息不假思索地基于全局变量来完成。这些不良习惯会导致代码极难控件化。</p><p>当然我们不见得什么桌面应用程序都要考虑把它控件化。但是我们花一些精力去思考控件化的话，会有助于你对架构设计中的一些决策提供帮助。</p><p>当然更重要的，其实是让你有机会形成更好的架构设计规范。</p><p>这一讲我们作出的修改如下：</p><ul><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/qiniu/qpaint/compare/v30...v31">https://github.com/qiniu/qpaint/compare/v30...v31<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><p>这是最新版本的源代码：</p><ul><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/qiniu/qpaint/tree/v31">https://github.com/qiniu/qpaint/tree/v31<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><p>如果你对今天的内容有什么思考与解读，欢迎给我留言，我们一起讨论。下一讲我们会谈谈架构设计的第二步：如何做好系统架构。</p><p>如果你觉得有所收获，也欢迎把文章分享给你的朋友。感谢你的收听，我们下期再见。</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/GGwujun/blog/edit/master/ssrc/许式伟的架构课/03.桌面开发篇/12.md">在 GitHub 上编辑此页<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="最后更新时间：">2023/9/29 14:47:35</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script>
      (function () {
        if (!location.port) {
          (function (i, s, o, g, r, a, m) {
            i["GoogleAnalyticsObject"] = r;
            (i[r] =
              i[r] ||
              function () {
                (i[r].q = i[r].q || []).push(arguments);
              }),
              (i[r].l = 1 * new Date());
            (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m);
          })(
            window,
            document,
            "script",
            "//www.google-analytics.com/analytics.js",
            "ga"
          );
          ga("create", "UA-149864185-1", "auto");
          ga("send", "pageview");
        }
      })();
    </script>
    <script src="/blog-architect/umi.ded6fefd.js"></script>
  </body>
</html>
